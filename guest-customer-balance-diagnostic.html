<!DOCTYPE html>
<html>

<head>
    <title>Guest Customer & Balance Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        .warning {
            color: orange;
            font-weight: bold;
        }

        .info {
            color: blue;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .guest-customer {
            background-color: #fff3cd;
        }

        .regular-customer {
            background-color: #d4edda;
        }

        .balance-mismatch {
            background-color: #f8d7da;
        }

        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: black;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }
    </style>
</head>

<body>
    <h1>üîç Guest Customer & Balance Diagnostic</h1>

    <div class="section">
        <h2>üé≠ Guest Customer Ledger Issue</h2>
        <button class="btn-primary" onclick="checkGuestCustomerLedgers()">Check Guest Customer Ledgers</button>
        <button class="btn-danger" onclick="cleanGuestCustomerLedgers()">Clean Guest Customer Ledgers</button>
        <div id="guestResults"></div>
    </div>

    <div class="section">
        <h2>üí∞ Balance Calculation Analysis</h2>
        <button class="btn-primary" onclick="analyzeBalanceCalculations()">Analyze Balance Calculations</button>
        <button class="btn-warning" onclick="compareBalancesMethods()">Compare Balance Methods</button>
        <div id="balanceResults"></div>
    </div>

    <div class="section">
        <h2>üìä Detailed Customer Analysis</h2>
        <button class="btn-primary" onclick="detailedCustomerAnalysis()">Show Detailed Analysis</button>
        <div id="detailedResults"></div>
    </div>

    <script type="module">
        let db;

        async function initializeDB() {
            try {
                const module = await import('./src/services/database.ts');
                db = new module.DatabaseService();
                await db.initialize();
                console.log('‚úÖ Database initialized');
                return true;
            } catch (error) {
                console.error('‚ùå Failed to initialize database:', error);
                return false;
            }
        }

        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const className = type === 'error' ? 'error' :
                type === 'success' ? 'success' :
                    type === 'warning' ? 'warning' : 'info';
            container.innerHTML += `<p class="${className}">${message}</p>`;
        }

        window.checkGuestCustomerLedgers = async function () {
            const results = document.getElementById('guestResults');
            results.innerHTML = '<h3>üé≠ Guest Customer Ledger Analysis</h3>';

            if (!await initializeDB()) {
                addResult('guestResults', '‚ùå Database initialization failed', 'error');
                return;
            }

            try {
                // Check for customer ledger entries for guest customers (customer_id = -1)
                const guestLedgerEntries = await db.executeRawQuery(`
                    SELECT COUNT(*) as count FROM customer_ledger_entries 
                    WHERE customer_id = -1
                `);

                addResult('guestResults', `Found ${guestLedgerEntries[0].count} ledger entries for guest customers`,
                    guestLedgerEntries[0].count > 0 ? 'warning' : 'success');

                if (guestLedgerEntries[0].count > 0) {
                    // Show sample guest ledger entries
                    const sampleGuestEntries = await db.executeRawQuery(`
                        SELECT customer_name, entry_type, transaction_type, amount, description, date, time
                        FROM customer_ledger_entries 
                        WHERE customer_id = -1
                        ORDER BY created_at DESC 
                        LIMIT 10
                    `);

                    if (sampleGuestEntries.length > 0) {
                        addResult('guestResults', '‚ùå PROBLEM: Guest customers have ledger entries (they should not!)', 'error');

                        let table = '<h4>Sample Guest Customer Ledger Entries:</h4>';
                        table += '<table><tr><th>Customer</th><th>Type</th><th>Transaction</th><th>Amount</th><th>Description</th><th>Date</th></tr>';
                        sampleGuestEntries.forEach(entry => {
                            table += `<tr class="guest-customer">
                                <td>${entry.customer_name}</td>
                                <td>${entry.entry_type}</td>
                                <td>${entry.transaction_type}</td>
                                <td>${parseFloat(entry.amount).toFixed(2)}</td>
                                <td>${entry.description}</td>
                                <td>${entry.date} ${entry.time}</td>
                            </tr>`;
                        });
                        table += '</table>';
                        results.innerHTML += table;

                        addResult('guestResults', 'üí° SOLUTION: Guest customers pay immediately in full, so they should not have ledger entries for tracking balances.', 'info');
                    }
                } else {
                    addResult('guestResults', '‚úÖ GOOD: No guest customer ledger entries found', 'success');
                }

                // Check for guest customers in customers table
                const guestCustomers = await db.executeRawQuery(`
                    SELECT id, name, balance FROM customers WHERE id = -1
                `);

                if (guestCustomers.length > 0) {
                    const guestBalance = parseFloat(guestCustomers[0].balance || 0);
                    addResult('guestResults', `Guest customer balance in customers table: Rs. ${guestBalance.toFixed(2)}`,
                        guestBalance !== 0 ? 'warning' : 'success');
                } else {
                    addResult('guestResults', 'No guest customer record in customers table', 'info');
                }

            } catch (error) {
                addResult('guestResults', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.cleanGuestCustomerLedgers = async function () {
            const results = document.getElementById('guestResults');
            results.innerHTML += '<h3>üßπ Cleaning Guest Customer Ledgers</h3>';

            if (!await initializeDB()) return;

            try {
                // Count guest customer ledger entries
                const countResult = await db.executeRawQuery(`
                    SELECT COUNT(*) as count FROM customer_ledger_entries WHERE customer_id = -1
                `);

                const count = countResult[0].count;
                addResult('guestResults', `Found ${count} guest customer ledger entries to remove`, 'info');

                if (count > 0) {
                    // Delete guest customer ledger entries
                    await db.executeRawQuery(`
                        DELETE FROM customer_ledger_entries WHERE customer_id = -1
                    `);

                    addResult('guestResults', `‚úÖ Removed ${count} guest customer ledger entries`, 'success');
                    addResult('guestResults', 'üí° Guest customers should only appear in daily ledger for cash flow tracking, not customer ledger for balance tracking.', 'info');
                } else {
                    addResult('guestResults', '‚úÖ No guest customer ledger entries to remove', 'success');
                }

                // Reset guest customer balance to 0
                await db.executeRawQuery(`
                    UPDATE customers SET balance = 0 WHERE id = -1
                `);
                addResult('guestResults', '‚úÖ Reset guest customer balance to 0', 'success');

            } catch (error) {
                addResult('guestResults', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.analyzeBalanceCalculations = async function () {
            const results = document.getElementById('balanceResults');
            results.innerHTML = '<h3>üí∞ Balance Calculation Analysis</h3>';

            if (!await initializeDB()) return;

            try {
                // Get all customers (excluding guest)
                const customers = await db.executeRawQuery(`
                    SELECT id, name, balance FROM customers WHERE id != -1 ORDER BY id LIMIT 10
                `);

                if (customers.length === 0) {
                    addResult('balanceResults', 'No regular customers found', 'warning');
                    return;
                }

                addResult('balanceResults', `Analyzing ${customers.length} customers...`, 'info');

                let table = '<table><tr><th>Customer</th><th>Stored Balance</th><th>Calculated (Ledger)</th><th>Outstanding Balance</th><th>Status</th></tr>';

                for (const customer of customers) {
                    try {
                        // Method 1: Stored balance from customers table
                        const storedBalance = parseFloat(customer.balance || 0);

                        // Method 2: Calculated from customer ledger entries
                        const ledgerCalculation = await db.executeRawQuery(`
                            SELECT 
                                COALESCE(SUM(CASE WHEN entry_type = 'debit' THEN amount ELSE -amount END), 0) as calculated_balance
                            FROM customer_ledger_entries 
                            WHERE customer_id = ?
                        `, [customer.id]);
                        const calculatedBalance = parseFloat(ledgerCalculation[0]?.calculated_balance || 0);

                        // Method 3: Outstanding balance using database method
                        const balanceInfo = await db.getCustomerBalance(customer.id);
                        const outstandingBalance = balanceInfo.outstanding;

                        // Check consistency
                        const isConsistent = Math.abs(storedBalance - calculatedBalance) < 0.01 &&
                            Math.abs(storedBalance - outstandingBalance) < 0.01;

                        const rowClass = isConsistent ? 'regular-customer' : 'balance-mismatch';
                        const status = isConsistent ? '‚úÖ Consistent' : '‚ùå Mismatch';

                        table += `<tr class="${rowClass}">
                            <td>${customer.name}</td>
                            <td>${storedBalance.toFixed(2)}</td>
                            <td>${calculatedBalance.toFixed(2)}</td>
                            <td>${outstandingBalance.toFixed(2)}</td>
                            <td>${status}</td>
                        </tr>`;

                    } catch (customerError) {
                        table += `<tr class="balance-mismatch">
                            <td>${customer.name}</td>
                            <td colspan="4">Error: ${customerError.message}</td>
                        </tr>`;
                    }
                }

                table += '</table>';
                results.innerHTML += table;

                addResult('balanceResults', 'üìä Analysis complete. Green rows = consistent, Red rows = have issues', 'info');

            } catch (error) {
                addResult('balanceResults', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.compareBalancesMethods = async function () {
            const results = document.getElementById('balanceResults');
            results.innerHTML += '<h3>üîç Balance Calculation Methods Comparison</h3>';

            if (!await initializeDB()) return;

            try {
                // Get one customer for detailed analysis
                const customers = await db.executeRawQuery(`
                    SELECT id, name, balance FROM customers WHERE id != -1 ORDER BY id LIMIT 1
                `);

                if (customers.length === 0) {
                    addResult('balanceResults', 'No customers found for comparison', 'warning');
                    return;
                }

                const customer = customers[0];
                addResult('balanceResults', `Detailed analysis for: ${customer.name}`, 'info');

                // Method 1: customers.balance
                const storedBalance = parseFloat(customer.balance || 0);
                addResult('balanceResults', `üìä Method 1 - Stored Balance: Rs. ${storedBalance.toFixed(2)}`, 'info');

                // Method 2: SUM from customer_ledger_entries
                const ledgerSum = await db.executeRawQuery(`
                    SELECT 
                        COALESCE(SUM(CASE WHEN entry_type = 'debit' THEN amount ELSE 0 END), 0) as total_debits,
                        COALESCE(SUM(CASE WHEN entry_type = 'credit' THEN amount ELSE 0 END), 0) as total_credits,
                        COALESCE(SUM(CASE WHEN entry_type = 'debit' THEN amount ELSE -amount END), 0) as net_balance
                    FROM customer_ledger_entries 
                    WHERE customer_id = ?
                `, [customer.id]);

                const debits = parseFloat(ledgerSum[0]?.total_debits || 0);
                const credits = parseFloat(ledgerSum[0]?.total_credits || 0);
                const netBalance = parseFloat(ledgerSum[0]?.net_balance || 0);

                addResult('balanceResults', `üìä Method 2 - Ledger Calculation: Debits Rs. ${debits.toFixed(2)} - Credits Rs. ${credits.toFixed(2)} = Rs. ${netBalance.toFixed(2)}`, 'info');

                // Method 3: Database getCustomerBalance method
                const balanceInfo = await db.getCustomerBalance(customer.id);
                addResult('balanceResults', `üìä Method 3 - Database Method: Outstanding Rs. ${balanceInfo.outstanding.toFixed(2)}, Invoiced Rs. ${balanceInfo.total_invoiced.toFixed(2)}, Paid Rs. ${balanceInfo.total_paid.toFixed(2)}`, 'info');

                // Method 4: Direct from invoices and payments tables
                const directCalculation = await db.executeRawQuery(`
                    SELECT 
                        COALESCE((SELECT SUM(grand_total) FROM invoices WHERE customer_id = ?), 0) as total_invoiced,
                        COALESCE((SELECT SUM(amount) FROM payments WHERE customer_id = ?), 0) as total_paid,
                        COALESCE((SELECT SUM(grand_total) FROM invoices WHERE customer_id = ?), 0) - 
                        COALESCE((SELECT SUM(amount) FROM payments WHERE customer_id = ?), 0) as calculated_balance
                `, [customer.id, customer.id, customer.id, customer.id]);

                const directInvoiced = parseFloat(directCalculation[0]?.total_invoiced || 0);
                const directPaid = parseFloat(directCalculation[0]?.total_paid || 0);
                const directBalance = parseFloat(directCalculation[0]?.calculated_balance || 0);

                addResult('balanceResults', `üìä Method 4 - Direct Calculation: Invoiced Rs. ${directInvoiced.toFixed(2)} - Paid Rs. ${directPaid.toFixed(2)} = Rs. ${directBalance.toFixed(2)}`, 'info');

                // Compare all methods
                const methods = [
                    { name: 'Stored Balance', value: storedBalance },
                    { name: 'Ledger Sum', value: netBalance },
                    { name: 'Database Method', value: balanceInfo.outstanding },
                    { name: 'Direct Calculation', value: directBalance }
                ];

                addResult('balanceResults', '\nüîç COMPARISON SUMMARY:', 'info');
                methods.forEach(method => {
                    addResult('balanceResults', `${method.name}: Rs. ${method.value.toFixed(2)}`, 'info');
                });

                // Check if all methods agree
                const allSame = methods.every(method => Math.abs(method.value - methods[0].value) < 0.01);
                if (allSame) {
                    addResult('balanceResults', '‚úÖ ALL METHODS AGREE - Balance calculations are consistent!', 'success');
                } else {
                    addResult('balanceResults', '‚ùå METHODS DISAGREE - Balance calculation inconsistency detected!', 'error');
                }

            } catch (error) {
                addResult('balanceResults', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        window.detailedCustomerAnalysis = async function () {
            const results = document.getElementById('detailedResults');
            results.innerHTML = '<h3>üìä Detailed Customer Analysis</h3>';

            if (!await initializeDB()) return;

            try {
                // Get customers with recent activity
                const customers = await db.executeRawQuery(`
                    SELECT DISTINCT c.id, c.name, c.balance,
                           (SELECT COUNT(*) FROM customer_ledger_entries WHERE customer_id = c.id) as ledger_entries_count,
                           (SELECT COUNT(*) FROM invoices WHERE customer_id = c.id) as invoices_count,
                           (SELECT COUNT(*) FROM payments WHERE customer_id = c.id) as payments_count
                    FROM customers c
                    WHERE c.id != -1 
                    ORDER BY ledger_entries_count DESC 
                    LIMIT 5
                `);

                if (customers.length === 0) {
                    addResult('detailedResults', 'No customers found', 'warning');
                    return;
                }

                let table = '<table><tr><th>Customer</th><th>Stored Balance</th><th>Ledger Entries</th><th>Invoices</th><th>Payments</th><th>Status</th></tr>';

                for (const customer of customers) {
                    const isGuest = customer.id === -1;
                    const hasLedgerEntries = customer.ledger_entries_count > 0;

                    let status = '';
                    let rowClass = '';

                    if (isGuest && hasLedgerEntries) {
                        status = '‚ùå Guest with ledger entries';
                        rowClass = 'guest-customer';
                    } else if (isGuest) {
                        status = '‚úÖ Guest without ledger entries';
                        rowClass = 'guest-customer';
                    } else if (hasLedgerEntries) {
                        status = '‚úÖ Regular customer';
                        rowClass = 'regular-customer';
                    } else {
                        status = '‚ö†Ô∏è No activity';
                        rowClass = '';
                    }

                    table += `<tr class="${rowClass}">
                        <td>${customer.name} (ID: ${customer.id})</td>
                        <td>${parseFloat(customer.balance || 0).toFixed(2)}</td>
                        <td>${customer.ledger_entries_count}</td>
                        <td>${customer.invoices_count}</td>
                        <td>${customer.payments_count}</td>
                        <td>${status}</td>
                    </tr>`;
                }

                table += '</table>';
                results.innerHTML += table;

                // Summary recommendations
                addResult('detailedResults', '\nüí° RECOMMENDATIONS:', 'info');
                addResult('detailedResults', '‚Ä¢ Guest customers (ID = -1) should NOT have customer ledger entries', 'info');
                addResult('detailedResults', '‚Ä¢ Guest customers pay immediately, so no balance tracking needed', 'info');
                addResult('detailedResults', '‚Ä¢ Regular customers should have consistent balance calculations', 'info');
                addResult('detailedResults', '‚Ä¢ Outstanding balance = Total Invoiced - Total Paid', 'info');

            } catch (error) {
                addResult('detailedResults', `‚ùå Error: ${error.message}`, 'error');
            }
        };

        // Initialize when page loads
        initializeDB();
    </script>
</body>

</html>