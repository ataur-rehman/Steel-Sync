import{d as n,f as o}from"./index-CKM3Cf7l.js";class r{static instance;notifications=[];settings;eventListeners=new Map;scheduledNotifications=new Map;constructor(){this.settings=this.getDefaultSettings(),this.loadSettings(),this.startPeriodicCheck()}static getInstance(){return r.instance||(r.instance=new r),r.instance}getDefaultSettings(){return{enabled:!0,categories:{inventory:{enabled:!0,priority:"high",repeatCount:3,repeatInterval:60,soundEnabled:!0,showInApp:!0,showAsBadge:!0},finance:{enabled:!0,priority:"high",repeatCount:2,repeatInterval:120,soundEnabled:!0,showInApp:!0,showAsBadge:!0},sales:{enabled:!0,priority:"medium",repeatCount:1,repeatInterval:30,soundEnabled:!1,showInApp:!0,showAsBadge:!0},system:{enabled:!0,priority:"medium",repeatCount:1,repeatInterval:0,soundEnabled:!1,showInApp:!0,showAsBadge:!1},reminders:{enabled:!0,priority:"medium",repeatCount:2,repeatInterval:30,soundEnabled:!0,showInApp:!0,showAsBadge:!0},alerts:{enabled:!0,priority:"urgent",repeatCount:5,repeatInterval:15,soundEnabled:!0,showInApp:!0,showAsBadge:!0}},globalSettings:{maxNotifications:50,autoMarkReadAfter:1440,enableSounds:!0,enableBadges:!0,quietHours:{enabled:!1,startTime:"22:00",endTime:"08:00"}}}}loadSettings(){try{const t=localStorage.getItem("notification_settings");t&&(this.settings={...this.getDefaultSettings(),...JSON.parse(t)})}catch(t){console.error("Failed to load notification settings:",t)}}saveSettings(){try{localStorage.setItem("notification_settings",JSON.stringify(this.settings))}catch(t){console.error("Failed to save notification settings:",t)}}getSettings(){return{...this.settings}}updateSettings(t){this.settings={...this.settings,...t},this.saveSettings(),this.emit("settings_updated",this.settings)}updateCategorySettings(t,e){this.settings.categories[t]={...this.settings.categories[t],...e},this.saveSettings(),this.emit("settings_updated",this.settings)}isInQuietHours(){if(!this.settings.globalSettings.quietHours.enabled)return!1;const t=new Date,e=t.getHours()*100+t.getMinutes(),i=this.parseTime(this.settings.globalSettings.quietHours.startTime),s=this.parseTime(this.settings.globalSettings.quietHours.endTime);return i<=s?e>=i&&e<=s:e>=i||e<=s}parseTime(t){const[e,i]=t.split(":").map(Number);return e*100+i}shouldCreateNotification(t,e){return!(!this.settings.enabled||!this.settings.categories[e].enabled||this.isInQuietHours()&&e!=="alerts")}async createNotification(t){if(!this.shouldCreateNotification(t.type,t.category))return null;const e={id:`notification_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:t.type,category:t.category,title:t.title,message:t.message,priority:t.priority,timestamp:new Date().toISOString(),read:!1,actionUrl:t.actionUrl,actionText:t.actionText||"View Details",data:t.data,expiresAt:t.expiresAt?.toISOString(),repeatCount:t.repeatCount||this.settings.categories[t.category].repeatCount,currentRepeat:0,dismissed:!1,persistent:t.priority==="urgent"||t.category==="alerts"};return this.notifications.unshift(e),this.notifications.length>this.settings.globalSettings.maxNotifications&&(this.notifications=this.notifications.slice(0,this.settings.globalSettings.maxNotifications)),e.repeatCount>0&&this.scheduleRepeat(e),e.expiresAt&&this.scheduleExpiry(e),this.settings.categories[t.category].soundEnabled&&this.settings.globalSettings.enableSounds&&this.playNotificationSound(e.priority),this.emit("notification_created",e),e.id}scheduleRepeat(t){const e=this.settings.categories[t.category];if(e.repeatInterval>0&&t.currentRepeat<t.repeatCount){const i=window.setTimeout(()=>{this.repeatNotification(t.id)},e.repeatInterval*60*1e3);this.scheduledNotifications.set(`repeat_${t.id}`,i)}}scheduleExpiry(t){if(!t.expiresAt)return;const e=new Date(t.expiresAt).getTime()-Date.now();if(e>0){const i=window.setTimeout(()=>{this.expireNotification(t.id)},e);this.scheduledNotifications.set(`expire_${t.id}`,i)}}repeatNotification(t){const e=this.notifications.find(s=>s.id===t);if(!e||e.dismissed)return;e.currentRepeat++,e.lastRepeated=new Date().toISOString(),e.currentRepeat<e.repeatCount&&this.scheduleRepeat(e),this.settings.categories[e.category].soundEnabled&&this.settings.globalSettings.enableSounds&&this.playNotificationSound(e.priority),this.emit("notification_repeated",e)}expireNotification(t){const e=this.notifications.findIndex(i=>i.id===t);e!==-1&&(this.notifications.splice(e,1),this.emit("notification_expired",t))}playNotificationSound(t){if(typeof Audio<"u")try{const e=new Audio;switch(t){case"urgent":e.src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+PUvmkiBzl+zfT...";break;case"high":e.src="data:audio/wav;base64,UklGRn4AAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YVoAAAC4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4uLi4";break;default:e.src="data:audio/wav;base64,UklGRjIAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ4AAAA="}e.volume=.3,e.play().catch(()=>{})}catch{}}getNotifications(){return[...this.notifications]}getUnreadCount(){return this.notifications.filter(t=>!t.read&&!t.dismissed).length}getUnreadByCategory(t){return this.notifications.filter(e=>!e.read&&!e.dismissed&&e.category===t).length}markAsRead(t){const e=this.notifications.find(i=>i.id===t);e&&(e.read=!0,this.emit("notification_read",e))}markAllAsRead(){this.notifications.forEach(t=>{t.read||(t.read=!0)}),this.emit("all_notifications_read")}dismissNotification(t){const e=this.notifications.find(i=>i.id===t);if(e){e.dismissed=!0;const i=`repeat_${t}`;this.scheduledNotifications.has(i)&&(window.clearTimeout(this.scheduledNotifications.get(i)),this.scheduledNotifications.delete(i)),this.emit("notification_dismissed",e)}}clearAllNotifications(){this.notifications=[],this.scheduledNotifications.forEach(t=>window.clearTimeout(t)),this.scheduledNotifications.clear(),this.emit("all_notifications_cleared")}clearExpiredNotifications(){const t=new Date,e=this.notifications.length;this.notifications=this.notifications.filter(i=>{if(i.expiresAt&&new Date(i.expiresAt)<t)return!1;if(i.read&&this.settings.globalSettings.autoMarkReadAfter>0){const a=new Date(i.timestamp).getTime()+this.settings.globalSettings.autoMarkReadAfter*60*1e3;return Date.now()<a}return!0}),this.notifications.length!==e&&this.emit("notifications_cleaned")}on(t,e){this.eventListeners.has(t)||this.eventListeners.set(t,[]),this.eventListeners.get(t).push(e)}off(t,e){const i=this.eventListeners.get(t);if(i){const s=i.indexOf(e);s>-1&&i.splice(s,1)}}emit(t,e){const i=this.eventListeners.get(t);i&&i.forEach(s=>{try{s(e)}catch(a){console.error("Error in notification event listener:",a)}})}startPeriodicCheck(){setInterval(()=>{this.checkSystemConditions(),this.clearExpiredNotifications()},5*60*1e3),window.setTimeout(()=>{this.checkSystemConditions()},2e3)}async checkSystemConditions(){try{await this.checkLowStock(),await this.checkHighBalances(),await this.checkOverduePayments(),await this.checkDailySummary()}catch(t){console.error("Error checking system conditions:",t)}}async checkLowStock(){try{await n.initialize();const e=(await n.getAllProducts()).filter(i=>i.stock_quantity<=(i.min_stock_alert||0));e.length>0&&(this.notifications.find(s=>s.type==="low_stock"&&!s.dismissed&&new Date(s.timestamp).getTime()>Date.now()-36e5)||await this.createNotification({id:"low_stock_check",type:"low_stock",category:"inventory",title:"Low Stock Alert",message:`${e.length} product${e.length>1?"s":""} running low on stock`,priority:"high",actionUrl:"/reports/stock?filter=low_stock",actionText:"View Stock Report",data:{products:e}}))}catch(t){console.error("Error checking low stock:",t)}}async checkHighBalances(){try{await n.initialize();const e=(await n.getAllCustomers()).filter(i=>i.balance>5e4);e.length>0&&(this.notifications.find(s=>s.type==="high_balance"&&!s.dismissed&&new Date(s.timestamp).getTime()>Date.now()-144e5)||await this.createNotification({id:"high_balance_check",type:"high_balance",category:"finance",title:"High Outstanding Balances",message:`${e.length} customer${e.length>1?"s have":" has"} balance over ${o(5e4)}`,priority:"high",actionUrl:"/reports/customer?filter=high_balance",actionText:"View Customer Report",data:{customers:e}}))}catch(t){console.error("Error checking high balances:",t)}}async checkOverduePayments(){try{await n.initialize();const t=await n.getOverdueInvoices(30);if(!Array.isArray(t)){console.warn("checkOverduePayments: getOverdueInvoices returned non-array:",typeof t);return}t.length>0&&(this.notifications.find(i=>i.type==="overdue_payment"&&!i.dismissed&&new Date(i.timestamp).getTime()>Date.now()-864e5)||await this.createNotification({id:"overdue_payment_check",type:"overdue_payment",category:"finance",title:"Overdue Payments",message:`${t.length} invoice${t.length>1?"s are":" is"} overdue for payment`,priority:"high",actionUrl:"/billing/list?filter=overdue",actionText:"View Overdue Invoices",data:{invoices:t}}))}catch(t){console.error("Error checking overdue payments:",t)}}async checkDailySummary(){try{await n.initialize();const t=new Date().toISOString().split("T")[0],e=await n.getInvoices({from_date:t,to_date:t});if(e.length>0&&!this.notifications.find(s=>s.type==="system_alert"&&s.data?.summaryDate===t&&!s.dismissed)){const s=e.reduce((a,c)=>a+c.grand_total,0);await this.createNotification({id:"daily_summary",type:"system_alert",category:"sales",title:"Daily Sales Summary",message:`${e.length} invoice${e.length>1?"s":""} totaling ${o(s)} today`,priority:"medium",actionUrl:`/billing/list?from_date=${t}&to_date=${t}`,actionText:"View Today's Sales",data:{summaryDate:t,invoiceCount:e.length,totalSales:s}})}}catch(t){console.error("Error checking daily summary:",t)}}async notifyProductLowStock(t,e,i,s){await this.createNotification({id:`low_stock_${t}`,type:"low_stock",category:"inventory",title:"Product Low Stock Alert",message:`${e} has only ${i} units left (minimum: ${s})`,priority:i===0?"urgent":"high",actionUrl:`/products/${t}`,actionText:"Restock Product",data:{productId:t,productName:e,currentStock:i,minStock:s},repeatCount:i===0?5:2,repeatInterval:i===0?15:60})}async notifyCustomerHighBalance(t,e,i){await this.createNotification({id:`high_balance_${t}`,type:"high_balance",category:"finance",title:"High Customer Balance Alert",message:`${e} has outstanding balance of ${o(i)}`,priority:i>1e5?"urgent":"high",actionUrl:`/customers/${t}`,actionText:"Contact Customer",data:{customerId:t,customerName:e,balance:i},repeatCount:3,repeatInterval:240})}async notifyPaymentOverdue(t,e,i,s){await this.createNotification({id:`overdue_${t}`,type:"overdue_payment",category:"finance",title:"Payment Overdue",message:`${e} payment of ${o(i)} is ${s} days overdue`,priority:s>30?"urgent":"high",actionUrl:`/billing/view/${t}`,actionText:"View Invoice",data:{invoiceId:t,customerName:e,amount:i,daysPastDue:s},repeatCount:s>30?5:2,repeatInterval:s>30?60:120})}async notifyLargeOrder(t,e,i){await this.createNotification({id:`large_order_${t}`,type:"new_order",category:"sales",title:"Large Order Received",message:`Large order of ${o(i)} from ${e}`,priority:i>5e5?"urgent":"high",actionUrl:`/billing/view/${t}`,actionText:"Process Order",data:{orderId:t,customerName:e,total:i}})}async notifyLowStock(t){await this.createNotification({id:"manual_low_stock",type:"low_stock",category:"inventory",title:"Low Stock Alert",message:`${t.length} product${t.length>1?"s need":" needs"} restocking`,priority:"high",actionUrl:"/reports/stock?filter=low_stock",data:{products:t}})}async notifyOrderComplete(t,e,i){await this.createNotification({id:`order_complete_${t}`,type:"new_order",category:"sales",title:"Order Completed",message:`New order from ${e} - ${o(i)}`,priority:"medium",actionUrl:`/billing/view/${t}`,data:{orderId:t,customerName:e,total:i}})}async notifyBackupComplete(t){await this.createNotification({id:`backup_${Date.now()}`,type:"backup_complete",category:"system",title:t==="success"?"Backup Complete":"Backup Failed",message:t==="success"?"System backup completed successfully":"System backup failed. Please try again.",priority:t==="success"?"low":"high",actionUrl:"/settings",actionText:"View Settings"})}async createReminder(t,e,i,s){const a=i.getTime()-Date.now();a>0&&window.setTimeout(async()=>{await this.createNotification({id:`reminder_${Date.now()}`,type:"reminder",category:"reminders",title:t,message:e,priority:"medium",actionUrl:s})},a)}}const u=r.getInstance();export{u as default,u as notificationService};
