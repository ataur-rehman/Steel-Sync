<!DOCTYPE html>
<html>
<head>
    <title>Stock Movements Table Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { padding: 12px 20px; margin: 8px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1976D2; }
        .result { margin: 15px 0; padding: 15px; border-radius: 6px; border-left: 5px solid; }
        .error { background: #ffebee; border-color: #f44336; color: #c62828; }
        .success { background: #e8f5e8; border-color: #4caf50; color: #2e7d32; }
        .warning { background: #fff3e0; border-color: #ff9800; color: #ef6c00; }
        .info { background: #e3f2fd; border-color: #2196F3; color: #1565c0; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Stock Movements Table Fix</h1>
        <p>This tool fixes the "no such table: stock_movements" error by creating the missing table.</p>
        
        <div>
            <button onclick="checkStockMovementsTable()">üîç Check Stock Movements Table</button>
            <button onclick="createStockMovementsTable()">üõ†Ô∏è Create Stock Movements Table</button>
            <button onclick="testStockMovements()">‚úÖ Test Stock Movements</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script>
        function addResult(content, type = 'info') {
            const container = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${content}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
        
        async function checkStockMovementsTable() {
            try {
                addResult('üîç Checking stock_movements table...', 'info');
                
                const { invoke } = window.__TAURI__.core;
                const { appDataDir, join } = window.__TAURI__.path;
                
                const appDataPath = await appDataDir();
                const dbPath = await join(appDataPath, 'store.db');
                const dbUrl = `sqlite:${dbPath}`;
                
                addResult(`üìç Using database: ${dbPath}`, 'info');
                
                // Check if table exists
                const tableCheck = await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "SELECT name FROM sqlite_master WHERE type='table' AND name='stock_movements'",
                    values: []
                });
                
                if (tableCheck && tableCheck.length > 0) {
                    addResult('‚úÖ stock_movements table exists', 'success');
                    
                    // Check table structure
                    const structure = await invoke('plugin:sql|execute', {
                        db: dbUrl,
                        query: "PRAGMA table_info(stock_movements)",
                        values: []
                    });
                    
                    addResult('<h4>Table Structure:</h4>', 'info');
                    addResult('<pre>' + JSON.stringify(structure, null, 2) + '</pre>', 'info');
                    
                    // Check row count
                    const count = await invoke('plugin:sql|execute', {
                        db: dbUrl,
                        query: "SELECT COUNT(*) as count FROM stock_movements",
                        values: []
                    });
                    
                    addResult(`üìä Table has ${count[0]?.count || 0} records`, 'info');
                } else {
                    addResult('‚ùå stock_movements table does NOT exist', 'error');
                    addResult('üí° Click "Create Stock Movements Table" to fix this issue', 'warning');
                }
                
            } catch (error) {
                addResult(`‚ùå Error checking table: ${error.message}`, 'error');
            }
        }
        
        async function createStockMovementsTable() {
            try {
                addResult('üõ†Ô∏è Creating stock_movements table...', 'info');
                
                const { invoke } = window.__TAURI__.core;
                const { appDataDir, join } = window.__TAURI__.path;
                
                const appDataPath = await appDataDir();
                const dbPath = await join(appDataPath, 'store.db');
                const dbUrl = `sqlite:${dbPath}`;
                
                // Create the table
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: `
                        CREATE TABLE IF NOT EXISTS stock_movements (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            product_id INTEGER NOT NULL,
                            product_name TEXT NOT NULL,
                            movement_type TEXT NOT NULL CHECK (movement_type IN ('in', 'out')),
                            quantity REAL NOT NULL CHECK (quantity > 0),
                            previous_stock REAL NOT NULL CHECK (previous_stock >= 0),
                            new_stock REAL NOT NULL CHECK (new_stock >= 0),
                            unit_price REAL NOT NULL CHECK (unit_price >= 0),
                            total_value REAL NOT NULL CHECK (total_value >= 0),
                            reason TEXT NOT NULL CHECK (length(reason) > 0),
                            reference_type TEXT CHECK (reference_type IN ('invoice', 'adjustment', 'initial', 'purchase')),
                            reference_id INTEGER,
                            reference_number TEXT,
                            customer_id INTEGER,
                            customer_name TEXT,
                            notes TEXT,
                            date TEXT NOT NULL,
                            time TEXT NOT NULL,
                            created_by TEXT,
                            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE RESTRICT ON UPDATE CASCADE,
                            FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL ON UPDATE CASCADE
                        )
                    `,
                    values: []
                });
                
                addResult('‚úÖ stock_movements table created successfully', 'success');
                
                // Create indexes
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "CREATE INDEX IF NOT EXISTS idx_stock_movements_product_id ON stock_movements(product_id)",
                    values: []
                });
                
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "CREATE INDEX IF NOT EXISTS idx_stock_movements_date ON stock_movements(date)",
                    values: []
                });
                
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "CREATE INDEX IF NOT EXISTS idx_stock_movements_reference ON stock_movements(reference_type, reference_id)",
                    values: []
                });
                
                addResult('‚úÖ Indexes created successfully', 'success');
                addResult('üéâ Table creation completed! You can now create invoices.', 'success');
                
            } catch (error) {
                addResult(`‚ùå Error creating table: ${error.message}`, 'error');
            }
        }
        
        async function testStockMovements() {
            try {
                addResult('‚úÖ Testing stock movements functionality...', 'info');
                
                const { invoke } = window.__TAURI__.core;
                const { appDataDir, join } = window.__TAURI__.path;
                
                const appDataPath = await appDataDir();
                const dbPath = await join(appDataPath, 'store.db');
                const dbUrl = `sqlite:${dbPath}`;
                
                // Test insert
                const testDate = new Date().toISOString().split('T')[0];
                const testTime = new Date().toLocaleTimeString();
                
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: `
                        INSERT INTO stock_movements 
                        (product_id, product_name, movement_type, quantity, previous_stock, new_stock, 
                         unit_price, total_value, reason, reference_type, date, time, created_by)
                        VALUES (1, 'Test Product', 'out', 1.0, 10.0, 9.0, 100.0, 100.0, 'Test movement', 'invoice', ?, ?, 'test')
                    `,
                    values: [testDate, testTime]
                });
                
                addResult('‚úÖ Test insert successful', 'success');
                
                // Test select
                const movements = await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "SELECT * FROM stock_movements WHERE created_by = 'test' ORDER BY id DESC LIMIT 1",
                    values: []
                });
                
                addResult('‚úÖ Test select successful', 'success');
                addResult('<pre>' + JSON.stringify(movements, null, 2) + '</pre>', 'info');
                
                // Clean up test data
                await invoke('plugin:sql|execute', {
                    db: dbUrl,
                    query: "DELETE FROM stock_movements WHERE created_by = 'test'",
                    values: []
                });
                
                addResult('‚úÖ Test cleanup completed', 'success');
                addResult('üéâ Stock movements table is working correctly!', 'success');
                
            } catch (error) {
                addResult(`‚ùå Test failed: ${error.message}`, 'error');
            }
        }
        
        // Auto-start with table check
        window.addEventListener('load', () => {
            setTimeout(() => {
                addResult('üöÄ Stock Movements Table Fix Tool loaded', 'info');
                addResult('üí° Click "Check Stock Movements Table" to start diagnosis', 'info');
            }, 500);
        });
    </script>
</body>
</html>
