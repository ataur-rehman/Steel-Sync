<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMMEDIATE Vendor Schema Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .title {
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
        }
        .button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .button:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        .success {
            background: #27ae60;
        }
        .success:hover {
            background: #219a52;
        }
        .log {
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 20px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .error {
            color: #ff6b6b;
        }
        .success-text {
            color: #51cf66;
        }
        .warning {
            background: #f39c12;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">üö® IMMEDIATE VENDOR SCHEMA FIX</h1>
        
        <div class="warning">
            <strong>‚ö†Ô∏è CRITICAL ERROR DETECTED:</strong><br>
            <code>NOT NULL constraint failed: vendors.vendor_name</code><br>
            <strong>This tool will fix it immediately!</strong>
        </div>

        <button class="button" onclick="runImmediateFix()">
            üîß RUN IMMEDIATE FIX NOW
        </button>

        <button class="button success" onclick="openMainApp()" style="display: none;" id="openAppBtn">
            üè† OPEN MAIN APPLICATION
        </button>

        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        function log(message, isError = false, isSuccess = false) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const className = isError ? 'error' : isSuccess ? 'success-text' : '';
            logDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function runImmediateFix() {
            log('üö® STARTING IMMEDIATE VENDOR SCHEMA FIX...', false, false);
            
            try {
                // Try to access the main application's database
                const mainWindow = window.open('http://localhost:5173/', '_blank');
                
                // Wait a moment for the main app to load
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Check if we can access the database from the main window
                if (mainWindow && !mainWindow.closed) {
                    log('üì° Attempting to access main application database...', false, false);
                    
                    // Inject our fix script into the main window
                    const script = mainWindow.document.createElement('script');
                    script.textContent = `
                        (async function() {
                            console.log('üö® Running vendor schema fix from emergency tool...');
                            
                            try {
                                // Try multiple ways to get database
                                let db = window.db;
                                if (!db && window.databaseService) {
                                    db = window.databaseService;
                                }
                                
                                if (!db) {
                                    console.log('Trying to get database instance...');
                                    // Try to import database service
                                    try {
                                        const dbModule = await import('./src/services/database.js');
                                        db = dbModule.db || dbModule.DatabaseService?.getInstance();
                                    } catch (e) {
                                        console.warn('Import failed:', e);
                                    }
                                }
                                
                                if (!db) {
                                    alert('‚ùå Could not access database. Please run this in the main application console:\\n\\nawait db.immediateVendorSchemaFix()');
                                    return;
                                }
                                
                                console.log('‚úÖ Database accessed, running fix...');
                                
                                // Check current schema
                                const schema = await db.executeRawQuery(\`PRAGMA table_info(vendors)\`);
                                const columns = schema.map(col => col.name);
                                console.log('Current columns:', columns);
                                
                                const hasVendorName = columns.includes('vendor_name');
                                const hasName = columns.includes('name');
                                
                                if (hasVendorName && !hasName) {
                                    console.log('üîß Fixing vendor schema...');
                                    
                                    // Add name column
                                    await db.executeRawQuery(\`ALTER TABLE vendors ADD COLUMN name TEXT\`);
                                    console.log('‚úÖ Added name column');
                                    
                                    // Copy data
                                    await db.executeRawQuery(\`UPDATE vendors SET name = vendor_name WHERE vendor_name IS NOT NULL AND vendor_name != ''\`);
                                    console.log('‚úÖ Copied data from vendor_name to name');
                                    
                                    // Set defaults
                                    await db.executeRawQuery(\`UPDATE vendors SET name = 'Unknown Vendor' WHERE name IS NULL OR name = ''\`);
                                    console.log('‚úÖ Set default values');
                                    
                                    alert('‚úÖ SUCCESS! Vendor schema fixed! You can now create vendors without errors.');
                                    console.log('üéâ VENDOR SCHEMA FIX COMPLETED!');
                                    
                                } else if (hasName) {
                                    alert('‚úÖ Vendor table already has correct schema');
                                    console.log('‚úÖ Schema already correct');
                                } else {
                                    // Add name column
                                    await db.executeRawQuery(\`ALTER TABLE vendors ADD COLUMN name TEXT NOT NULL DEFAULT 'Unknown Vendor'\`);
                                    alert('‚úÖ Added name column to vendor table');
                                    console.log('‚úÖ Added name column');
                                }
                                
                            } catch (error) {
                                console.error('‚ùå Fix failed:', error);
                                alert('‚ùå Fix failed: ' + error.message);
                            }
                        })();
                    `;
                    
                    mainWindow.document.head.appendChild(script);
                    log('‚úÖ Fix script injected into main application', false, true);
                    log('üí° Check the main application for results', false, false);
                    
                    document.getElementById('openAppBtn').style.display = 'block';
                    
                } else {
                    log('‚ùå Could not open main application window', true, false);
                    log('üìã MANUAL FIX INSTRUCTIONS:', false, false);
                    log('1. Open the main application: http://localhost:5173/', false, false);
                    log('2. Press F12 to open Developer Console', false, false);
                    log('3. Paste this command and press Enter:', false, false);
                    log('await db.immediateVendorSchemaFix()', false, false);
                }
                
            } catch (error) {
                log('‚ùå Error: ' + error.message, true, false);
                log('üìã MANUAL FIX INSTRUCTIONS:', false, false);
                log('1. Open http://localhost:5173/ in a new tab', false, false);
                log('2. Open Browser Console (F12)', false, false);
                log('3. Run: await db.immediateVendorSchemaFix()', false, false);
            }
        }

        function openMainApp() {
            window.open('http://localhost:5173/', '_blank');
        }

        // Auto-show instructions
        log('üéØ Ready to fix vendor schema error!', false, false);
        log('üí° Click "RUN IMMEDIATE FIX NOW" to start', false, false);
    </script>
</body>
</html>
