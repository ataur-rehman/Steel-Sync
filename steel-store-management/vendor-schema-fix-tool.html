<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Schema Fix Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #d32f2f;
            margin-bottom: 30px;
        }
        .button {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        .button:hover {
            background-color: #b71c1c;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .log {
            background-color: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            white-space: pre-wrap;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        .status.success {
            background-color: #e8f5e8;
            color: #2e7d2e;
            border: 1px solid #4caf50;
        }
        .status.error {
            background-color: #ffeaea;
            color: #d32f2f;
            border: 1px solid #f44336;
        }
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #2196f3;
        }
        .instructions {
            background-color: #fff3e0;
            padding: 20px;
            border-radius: 5px;
            border-left: 4px solid #ff9800;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Vendor Schema Fix Tool</h1>
            <p>This tool will fix the vendor table schema that's causing the "NOT NULL constraint failed: vendors.vendor_name" error</p>
        </div>

        <div class="instructions">
            <h3>üìã Instructions:</h3>
            <ol>
                <li>Make sure your Steel Store Management application is running (http://localhost:5173)</li>
                <li>Click the "Open Main Application" button to ensure the database is loaded</li>
                <li>Click "Run Schema Fix" to automatically fix the vendor table</li>
                <li>Test vendor creation in the main application</li>
            </ol>
        </div>

        <button class="button" onclick="openMainApp()">üåê Open Main Application</button>
        <button class="button" id="fixButton" onclick="runSchemaFix()">üîß Run Schema Fix</button>
        <button class="button" onclick="testVendorCreation()">üß™ Test Vendor Creation</button>

        <div id="status"></div>
        <div id="log" class="log" style="display: none;"></div>
    </div>

    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        let fixButton = document.getElementById('fixButton');

        function log(message, type = 'info') {
            console.log(message);
            logElement.style.display = 'block';
            logElement.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            logElement.scrollTop = logElement.scrollHeight;
        }

        function setStatus(message, type = 'info') {
            statusElement.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function openMainApp() {
            log('Opening main application...');
            const mainWindow = window.open('http://localhost:5173', '_blank');
            if (mainWindow) {
                setStatus('‚úÖ Main application opened. Please wait a moment for it to load, then return here to run the fix.', 'success');
                setTimeout(() => {
                    setStatus('üîß Ready to run schema fix. Click "Run Schema Fix" button.', 'info');
                }, 3000);
            } else {
                setStatus('‚ùå Failed to open main application. Please open http://localhost:5173 manually.', 'error');
            }
        }

        async function runSchemaFix() {
            log('üö® Starting comprehensive vendor schema fix...');
            setStatus('üîß Running schema fix... Please wait.', 'info');
            fixButton.disabled = true;

            try {
                // Try to access the main application's database
                const mainWindow = window.open('http://localhost:5173', 'mainApp');
                
                if (!mainWindow) {
                    throw new Error('Could not access main application. Please open http://localhost:5173 first.');
                }

                // Wait a moment for the window to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Inject and run the fix script
                const fixScript = `
                    (async function() {
                        try {
                            const db = window.dbService || window.db || window.databaseService;
                            
                            if (!db) {
                                throw new Error('Database service not found');
                            }

                            console.log('üîß Running vendor schema fix...');
                            
                            // Get current schema
                            const schema = await db.executeRawQuery('PRAGMA table_info(vendors)');
                            const columnNames = schema.map(col => col.name);
                            
                            console.log('Current columns:', columnNames);
                            
                            if (columnNames.includes('vendor_name')) {
                                console.log('‚ö†Ô∏è Found vendor_name column - migrating...');
                                
                                // Create new table with correct schema
                                await db.executeRawQuery(\`
                                    CREATE TABLE vendors_fixed (
                                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                                        vendor_code TEXT UNIQUE NOT NULL,
                                        name TEXT NOT NULL,
                                        company_name TEXT,
                                        phone TEXT,
                                        address TEXT,
                                        contact_person TEXT,
                                        payment_terms TEXT,
                                        notes TEXT,
                                        outstanding_balance REAL DEFAULT 0.0,
                                        is_active BOOLEAN DEFAULT 1,
                                        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                                        updated_at TEXT DEFAULT CURRENT_TIMESTAMP
                                    )
                                \`);
                                
                                // Copy data
                                await db.executeRawQuery(\`
                                    INSERT INTO vendors_fixed (
                                        id, vendor_code, name, company_name, phone, address,
                                        contact_person, payment_terms, notes, outstanding_balance,
                                        is_active, created_at, updated_at
                                    )
                                    SELECT 
                                        id,
                                        COALESCE(vendor_code, 'VEN' || id) as vendor_code,
                                        COALESCE(name, vendor_name, 'Unknown') as name,
                                        company_name, phone, address, contact_person, payment_terms, notes,
                                        COALESCE(outstanding_balance, 0.0), COALESCE(is_active, 1),
                                        COALESCE(created_at, datetime('now')), COALESCE(updated_at, datetime('now'))
                                    FROM vendors
                                \`);
                                
                                // Replace table
                                await db.executeRawQuery('DROP TABLE vendors');
                                await db.executeRawQuery('ALTER TABLE vendors_fixed RENAME TO vendors');
                                
                                console.log('‚úÖ Schema migration completed');
                            }
                            
                            // Test vendor creation
                            const testVendor = {
                                name: 'Schema Fix Test ' + Date.now(),
                                company_name: 'Test Company'
                            };
                            
                            const vendorId = await db.createVendor(testVendor);
                            console.log('‚úÖ Test vendor created with ID:', vendorId);
                            
                            // Clean up
                            await db.executeRawQuery('DELETE FROM vendors WHERE id = ?', [vendorId]);
                            console.log('üßπ Test vendor cleaned up');
                            
                            return { success: true, message: 'Schema fix completed successfully!' };
                            
                        } catch (error) {
                            console.error('‚ùå Fix failed:', error);
                            return { success: false, message: error.message };
                        }
                    })();
                `;

                // Execute the script in the main window
                mainWindow.eval(fixScript + '.then(result => { window.fixResult = result; });');

                // Wait for the fix to complete
                await new Promise(resolve => setTimeout(resolve, 5000));

                // Check the result
                let result;
                try {
                    result = mainWindow.fixResult;
                } catch (e) {
                    result = null;
                }

                if (result && result.success) {
                    log('‚úÖ Schema fix completed successfully!');
                    setStatus('üéâ SUCCESS! Vendor schema has been fixed. You can now create vendors without errors.', 'success');
                } else {
                    throw new Error(result ? result.message : 'Fix result not available');
                }

                // Close the temporary window
                if (mainWindow !== window) {
                    mainWindow.close();
                }

            } catch (error) {
                log('‚ùå Error: ' + error.message);
                setStatus('‚ùå Schema fix failed: ' + error.message + '. Please try running the script manually in the browser console.', 'error');
            } finally {
                fixButton.disabled = false;
            }
        }

        async function testVendorCreation() {
            log('üß™ Testing vendor creation...');
            setStatus('üß™ Testing vendor creation...', 'info');

            try {
                const mainWindow = window.open('http://localhost:5173', 'mainApp');
                
                if (!mainWindow) {
                    throw new Error('Could not access main application');
                }

                await new Promise(resolve => setTimeout(resolve, 2000));

                const testScript = `
                    (async function() {
                        try {
                            const db = window.dbService || window.db;
                            if (!db) throw new Error('Database not found');
                            
                            const testVendor = {
                                name: 'Test Vendor ' + Date.now(),
                                company_name: 'Test Company',
                                phone: '123-456-7890'
                            };
                            
                            const vendorId = await db.createVendor(testVendor);
                            
                            // Clean up
                            await db.executeRawQuery('DELETE FROM vendors WHERE id = ?', [vendorId]);
                            
                            return { success: true, vendorId };
                        } catch (error) {
                            return { success: false, error: error.message };
                        }
                    })();
                `;

                mainWindow.eval(testScript + '.then(result => { window.testResult = result; });');

                await new Promise(resolve => setTimeout(resolve, 3000));

                const result = mainWindow.testResult;
                
                if (result && result.success) {
                    log('‚úÖ Vendor creation test passed!');
                    setStatus('‚úÖ SUCCESS! Vendor creation is working correctly.', 'success');
                } else {
                    throw new Error(result ? result.error : 'Test failed');
                }

                if (mainWindow !== window) {
                    mainWindow.close();
                }

            } catch (error) {
                log('‚ùå Test failed: ' + error.message);
                setStatus('‚ùå Vendor creation test failed: ' + error.message, 'error');
            }
        }

        // Initial status
        setStatus('üìã Please follow the instructions above to fix the vendor schema issue.', 'info');
    </script>
</body>
</html>
