<!DOCTYPE html>
<html>
<head>
    <title>Direct Payment Channels Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 15px; margin: 5px; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
        .error { background: #ffebee; border-color: #f44336; }
        .success { background: #e8f5e8; border-color: #4caf50; }
    </style>
</head>
<body>
    <h1>Direct Payment Channels Test</h1>
    <button onclick="runDatabaseTest()">Run Database Test</button>
    <button onclick="createPaymentChannels()">Create Payment Channels</button>
    <button onclick="checkPaymentChannels()">Check Payment Channels</button>
    <div id="results"></div>

    <script>
        let resultsDiv = document.getElementById('results');
        
        function addResult(content, isError = false) {
            const div = document.createElement('div');
            div.className = `result ${isError ? 'error' : 'success'}`;
            div.innerHTML = content;
            resultsDiv.appendChild(div);
        }
        
        async function runDatabaseTest() {
            try {
                addResult('Testing Tauri SQL plugin...');
                
                // Use Tauri's invoke directly
                const { invoke } = window.__TAURI__.core;
                
                // Test basic query
                const result = await invoke('plugin:sql|execute', {
                    db: 'sqlite:store.db',
                    query: 'SELECT sqlite_version() as version',
                    values: []
                });
                
                addResult(`✅ SQLite working! Version: ${result[0]?.version || 'unknown'}`);
                return true;
            } catch (error) {
                addResult(`❌ Database test failed: ${error.message}`, true);
                return false;
            }
        }
        
        async function createPaymentChannels() {
            try {
                addResult('Creating payment channels table...');
                
                const { invoke } = window.__TAURI__.core;
                
                // Create table
                await invoke('plugin:sql|execute', {
                    db: 'sqlite:store.db',
                    query: `
                        CREATE TABLE IF NOT EXISTS payment_channels (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            name TEXT NOT NULL UNIQUE,
                            type TEXT NOT NULL,
                            description TEXT,
                            account_number TEXT,
                            bank_name TEXT,
                            is_active BOOLEAN NOT NULL DEFAULT true,
                            fee_percentage REAL DEFAULT 0,
                            fee_fixed REAL DEFAULT 0,
                            daily_limit REAL DEFAULT 0,
                            monthly_limit REAL DEFAULT 0,
                            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                        )
                    `,
                    values: []
                });
                
                addResult('✅ Payment channels table created');
                
                // Insert default channels
                const defaultChannels = [
                    { name: 'Cash', type: 'cash', description: 'Physical cash payments' },
                    { name: 'Bank Transfer', type: 'bank', description: 'Electronic bank transfers' },
                    { name: 'Credit Card', type: 'card', description: 'Credit card payments' },
                    { name: 'Cheque', type: 'cheque', description: 'Cheque payments' },
                    { name: 'JazzCash', type: 'digital', description: 'JazzCash mobile wallet' }
                ];
                
                for (const channel of defaultChannels) {
                    try {
                        await invoke('plugin:sql|execute', {
                            db: 'sqlite:store.db',
                            query: `
                                INSERT OR IGNORE INTO payment_channels 
                                (name, type, description, is_active) 
                                VALUES (?, ?, ?, 1)
                            `,
                            values: [channel.name, channel.type, channel.description]
                        });
                        addResult(`✅ Created payment channel: ${channel.name}`);
                    } catch (channelError) {
                        addResult(`⚠️ Channel ${channel.name} might already exist`);
                    }
                }
                
                addResult('✅ Default payment channels creation completed');
                
            } catch (error) {
                addResult(`❌ Failed to create payment channels: ${error.message}`, true);
            }
        }
        
        async function checkPaymentChannels() {
            try {
                addResult('Checking payment channels...');
                
                const { invoke } = window.__TAURI__.core;
                
                const channels = await invoke('plugin:sql|execute', {
                    db: 'sqlite:store.db',
                    query: 'SELECT * FROM payment_channels ORDER BY name',
                    values: []
                });
                
                addResult(`✅ Found ${channels.length} payment channels:`);
                channels.forEach(channel => {
                    addResult(`  • ${channel.name} (${channel.type}) - Active: ${channel.is_active ? 'Yes' : 'No'}`);
                });
                
                if (channels.length === 0) {
                    addResult('❌ No payment channels found! Try creating them first.', true);
                }
                
            } catch (error) {
                addResult(`❌ Failed to check payment channels: ${error.message}`, true);
            }
        }
        
        // Auto-run basic test when page loads
        window.addEventListener('load', () => {
            setTimeout(runDatabaseTest, 1000);
        });
    </script>
</body>
</html>
