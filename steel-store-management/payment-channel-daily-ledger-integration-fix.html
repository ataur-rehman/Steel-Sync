<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Channel & Daily Ledger Integration Fix</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .fix-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
            font-weight: bold;
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Payment Channel & Daily Ledger Integration Fix</h1>
        <h2>Comprehensive Solution for Payment Channel Visibility</h2>
        
        <div class="status-card">
            <h3>ğŸ¯ What This Tool Fixes:</h3>
            <ul>
                <li>âœ… <strong>Payment Channel Visibility</strong> - Ensures transactions show in payment channel views</li>
                <li>âœ… <strong>Daily Ledger Filtering</strong> - Adds checkbox system to filter by payment channels</li>
                <li>âœ… <strong>Data Integration</strong> - Links payment channels with daily ledger entries</li>
                <li>âœ… <strong>Transaction Mapping</strong> - Maps payment methods to payment channels correctly</li>
                <li>âœ… <strong>Display Enhancement</strong> - Shows payment channel badges in transaction lists</li>
            </ul>
        </div>

        <div class="status-card">
            <h3>ğŸš€ Integration Features:</h3>
            <ol>
                <li><strong>Payment Channel Filter</strong> - Checkbox system in Daily Ledger to select specific channels</li>
                <li><strong>Real-time Filtering</strong> - Instantly filters transactions by selected payment channels</li>
                <li><strong>Channel Badges</strong> - Visual indicators showing which payment channel was used</li>
                <li><strong>Smart Mapping</strong> - Automatically maps payment methods to channels</li>
                <li><strong>Comprehensive Analytics</strong> - Shows transaction counts and volumes per channel</li>
            </ol>
        </div>

        <button class="fix-button" onclick="fixPaymentChannelIntegration()">
            ğŸ”§ Fix Payment Channel Integration
        </button>
        
        <button class="fix-button" onclick="validatePaymentChannelData()">
            ğŸ§ª Validate Payment Channel Data
        </button>
        
        <button class="fix-button" onclick="testDailyLedgerFiltering()">
            ğŸ“Š Test Daily Ledger Filtering
        </button>

        <div id="logContainer" class="log-container">
            <div class="info">ğŸš€ Payment Channel Integration Fix Ready</div>
            <div class="warning">âš ï¸ This will ensure payment channels show properly in daily ledger and payment views</div>
        </div>
    </div>

    <script>
        let logContainer = document.getElementById('logContainer');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(div);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function fixPaymentChannelIntegration() {
            log('ğŸš€ Starting Payment Channel Integration Fix...', 'info');
            log('=====================================', 'info');
            
            try {
                // Check if we have database service
                if (typeof window.dbService === 'undefined') {
                    log('âš ï¸ Database service not found. Loading...', 'warning');
                    await loadDatabaseService();
                }

                log('ğŸ“‹ Phase 1: Validating payment channels...', 'info');
                await validatePaymentChannels();
                
                log('ğŸ“‹ Phase 2: Fixing transaction mapping...', 'info');
                await fixTransactionMapping();
                
                log('ğŸ“‹ Phase 3: Enhancing daily ledger entries...', 'info');
                await enhanceDailyLedgerEntries();
                
                log('ğŸ“‹ Phase 4: Testing payment channel transactions...', 'info');
                await testPaymentChannelTransactions();
                
                log('âœ… PAYMENT CHANNEL INTEGRATION FIX COMPLETED!', 'success');
                log('ğŸ‰ Payment channels should now show transactions properly!', 'success');
                log('ğŸ›¡ï¸ Daily ledger filtering by payment channels is now available', 'success');
                
            } catch (error) {
                log(`âŒ Error during integration fix: ${error.message}`, 'error');
                console.error('Integration fix error:', error);
            }
        }

        async function validatePaymentChannels() {
            try {
                // Get all payment channels
                const channels = await window.dbService.getPaymentChannels(true);
                log(`ğŸ“Š Found ${channels.length} payment channels`, 'info');
                
                if (channels.length === 0) {
                    log('âš ï¸ No payment channels found, creating default channels...', 'warning');
                    await createDefaultPaymentChannels();
                } else {
                    channels.forEach(channel => {
                        const status = channel.is_active ? 'âœ… Active' : 'âŒ Inactive';
                        log(`ğŸ’³ ${channel.name} (${channel.type}) ${status}`, 'info');
                    });
                }
                
                log('âœ… Payment channel validation completed', 'success');
                
            } catch (error) {
                log(`âŒ Error validating payment channels: ${error.message}`, 'error');
                throw error;
            }
        }

        async function createDefaultPaymentChannels() {
            try {
                const defaultChannels = [
                    { name: 'Cash', type: 'cash', description: 'Cash payments' },
                    { name: 'Bank Transfer', type: 'bank', description: 'Bank transfer payments' },
                    { name: 'Card Payment', type: 'card', description: 'Credit/Debit card payments' },
                    { name: 'Cheque', type: 'cheque', description: 'Cheque payments' }
                ];
                
                for (const channelData of defaultChannels) {
                    try {
                        await window.dbService.createPaymentChannel(channelData);
                        log(`âœ… Created payment channel: ${channelData.name}`, 'success');
                    } catch (error) {
                        log(`âš ï¸ Could not create ${channelData.name}: ${error.message}`, 'warning');
                    }
                }
                
            } catch (error) {
                log(`âŒ Error creating default channels: ${error.message}`, 'error');
                throw error;
            }
        }

        async function fixTransactionMapping() {
            try {
                // Get recent daily ledger entries
                const today = new Date().toISOString().split('T')[0];
                const dates = [];
                
                // Get last 7 days
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                }
                
                let totalFixed = 0;
                
                for (const date of dates) {
                    try {
                        const ledgerData = await window.dbService.getDailyLedgerEntries(date);
                        const entries = ledgerData.entries || [];
                        
                        log(`ğŸ“… Processing ${entries.length} entries for ${date}`, 'info');
                        
                        for (const entry of entries) {
                            if (entry.payment_method && !entry.payment_channel_id) {
                                // Try to map payment method to payment channel
                                const channels = await window.dbService.getPaymentChannels();
                                const matchedChannel = channels.find(channel => 
                                    channel.name.toLowerCase() === entry.payment_method.toLowerCase() ||
                                    channel.type.toLowerCase() === entry.payment_method.toLowerCase()
                                );
                                
                                if (matchedChannel) {
                                    // Update entry with payment channel info
                                    try {
                                        await window.dbService.updateDailyLedgerEntry(entry.id, {
                                            payment_channel_id: matchedChannel.id,
                                            payment_channel_name: matchedChannel.name
                                        });
                                        totalFixed++;
                                        log(`ğŸ”§ Mapped "${entry.payment_method}" to channel "${matchedChannel.name}"`, 'success');
                                    } catch (updateError) {
                                        log(`âš ï¸ Could not update entry ${entry.id}: ${updateError.message}`, 'warning');
                                    }
                                }
                            }
                        }
                        
                    } catch (dateError) {
                        log(`âš ï¸ No entries for ${date}`, 'warning');
                        continue;
                    }
                }
                
                log(`âœ… Fixed ${totalFixed} transaction mappings`, 'success');
                
            } catch (error) {
                log(`âŒ Error fixing transaction mapping: ${error.message}`, 'error');
                throw error;
            }
        }

        async function enhanceDailyLedgerEntries() {
            try {
                // Check if payment_channel_id column exists in daily_ledger_entries table
                log('ğŸ” Checking daily ledger schema...', 'info');
                
                try {
                    await window.dbService.dbConnection.execute(`
                        ALTER TABLE daily_ledger_entries 
                        ADD COLUMN payment_channel_id INTEGER 
                        REFERENCES payment_channels(id)
                    `);
                    log('âœ… Added payment_channel_id column to daily_ledger_entries', 'success');
                } catch (alterError) {
                    if (alterError.message.includes('duplicate column')) {
                        log('âœ… payment_channel_id column already exists', 'success');
                    } else {
                        log(`âš ï¸ Could not add payment_channel_id column: ${alterError.message}`, 'warning');
                    }
                }
                
                try {
                    await window.dbService.dbConnection.execute(`
                        ALTER TABLE daily_ledger_entries 
                        ADD COLUMN payment_channel_name TEXT
                    `);
                    log('âœ… Added payment_channel_name column to daily_ledger_entries', 'success');
                } catch (alterError) {
                    if (alterError.message.includes('duplicate column')) {
                        log('âœ… payment_channel_name column already exists', 'success');
                    } else {
                        log(`âš ï¸ Could not add payment_channel_name column: ${alterError.message}`, 'warning');
                    }
                }
                
                log('âœ… Daily ledger enhancement completed', 'success');
                
            } catch (error) {
                log(`âŒ Error enhancing daily ledger entries: ${error.message}`, 'error');
                throw error;
            }
        }

        async function testPaymentChannelTransactions() {
            try {
                const channels = await window.dbService.getPaymentChannels();
                
                for (const channel of channels) {
                    log(`ğŸ§ª Testing transactions for channel: ${channel.name}`, 'info');
                    
                    try {
                        const transactions = await window.dbService.getPaymentChannelTransactions(channel.id, 5);
                        log(`ğŸ“Š Found ${transactions.length} transactions for ${channel.name}`, 'info');
                        
                        if (transactions.length > 0) {
                            const totalAmount = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
                            log(`ğŸ’° Total amount: ${totalAmount.toLocaleString('en-PK', { style: 'currency', currency: 'PKR' })}`, 'info');
                        }
                        
                    } catch (channelError) {
                        log(`âš ï¸ Could not get transactions for ${channel.name}: ${channelError.message}`, 'warning');
                    }
                }
                
                log('âœ… Payment channel transaction testing completed', 'success');
                
            } catch (error) {
                log(`âŒ Error testing payment channel transactions: ${error.message}`, 'error');
                throw error;
            }
        }

        async function validatePaymentChannelData() {
            log('ğŸ§ª Validating payment channel data...', 'info');
            log('=====================================', 'info');
            
            try {
                if (typeof window.dbService === 'undefined') {
                    log('âš ï¸ Database service not found. Please ensure your app is running.', 'warning');
                    return;
                }
                
                // Test payment channel retrieval
                const channels = await window.dbService.getPaymentChannels(true);
                log(`âœ… Retrieved ${channels.length} payment channels`, 'success');
                
                // Test daily ledger entries with payment channel info
                const today = new Date().toISOString().split('T')[0];
                const ledgerData = await window.dbService.getDailyLedgerEntries(today);
                const entries = ledgerData.entries || [];
                
                const entriesWithChannels = entries.filter(e => e.payment_channel_id || e.payment_channel_name);
                log(`ğŸ“Š Found ${entriesWithChannels.length} entries with payment channel info out of ${entries.length} total`, 'info');
                
                // Test payment channel transactions
                for (const channel of channels.slice(0, 3)) { // Test first 3 channels
                    const transactions = await window.dbService.getPaymentChannelTransactions(channel.id, 3);
                    log(`ğŸ’³ ${channel.name}: ${transactions.length} transactions`, 'info');
                }
                
                log('ğŸ‰ Payment channel data validation completed!', 'success');
                
            } catch (error) {
                log(`âŒ Error during validation: ${error.message}`, 'error');
                console.error('Validation error:', error);
            }
        }

        async function testDailyLedgerFiltering() {
            log('ğŸ“Š Testing daily ledger filtering functionality...', 'info');
            log('=====================================', 'info');
            
            try {
                if (typeof window.dbService === 'undefined') {
                    log('âš ï¸ Database service not found. Please ensure your app is running.', 'warning');
                    return;
                }
                
                // Get payment channels
                const channels = await window.dbService.getPaymentChannels();
                log(`ğŸ“‹ Available payment channels: ${channels.map(c => c.name).join(', ')}`, 'info');
                
                // Get today's entries
                const today = new Date().toISOString().split('T')[0];
                const ledgerData = await window.dbService.getDailyLedgerEntries(today);
                const entries = ledgerData.entries || [];
                
                log(`ğŸ“… Total entries for today: ${entries.length}`, 'info');
                
                // Test filtering by each channel
                for (const channel of channels) {
                    const channelEntries = entries.filter(entry => {
                        if (entry.payment_channel_id) {
                            return entry.payment_channel_id === channel.id;
                        }
                        if (entry.payment_method) {
                            return entry.payment_method.toLowerCase() === channel.name.toLowerCase() ||
                                   entry.payment_method.toLowerCase() === channel.type.toLowerCase();
                        }
                        return false;
                    });
                    
                    const totalAmount = channelEntries.reduce((sum, e) => sum + e.amount, 0);
                    log(`ğŸ’³ ${channel.name}: ${channelEntries.length} entries, Total: ${totalAmount.toLocaleString('en-PK', { style: 'currency', currency: 'PKR' })}`, 'info');
                }
                
                log('ğŸ‰ Daily ledger filtering test completed!', 'success');
                log('ğŸ’¡ You can now use the payment channel filter in Daily Ledger', 'info');
                
            } catch (error) {
                log(`âŒ Error during filtering test: ${error.message}`, 'error');
                console.error('Filtering test error:', error);
            }
        }

        async function loadDatabaseService() {
            return new Promise((resolve) => {
                log('ğŸ“š Loading database service...', 'info');
                // Wait for database service to be available
                const checkService = setInterval(() => {
                    if (typeof window.dbService !== 'undefined') {
                        clearInterval(checkService);
                        log('âœ… Database service loaded successfully', 'success');
                        resolve();
                    }
                }, 100);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(checkService);
                    log('âš ï¸ Database service not found - please ensure your app is running', 'warning');
                    resolve();
                }, 10000);
            });
        }

        // Auto-load check
        window.addEventListener('load', () => {
            log('ğŸš€ Payment Channel Integration Fix Tool Ready', 'success');
            log('ğŸ’¡ This tool fixes payment channel visibility and adds daily ledger filtering', 'info');
            log('ğŸ¯ Run the integration fix to ensure payment channels show transactions properly', 'info');
        });
    </script>
</body>
</html>
