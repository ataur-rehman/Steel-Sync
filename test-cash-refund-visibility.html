<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Refund Visibility Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
        }

        .result {
            padding: 10px;
            margin: 10px 0;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>Cash Refund Daily Ledger Visibility Test</h1>

    <div class="test-section">
        <h3>Test 1: Check if entry ID 58 exists in database</h3>
        <div id="test1-result" class="result">Running...</div>
    </div>

    <div class="test-section">
        <h3>Test 2: Check if entry shows in daily ledger with no filters</h3>
        <div id="test2-result" class="result">Running...</div>
    </div>

    <div class="test-section">
        <h3>Test 3: Check if entry shows with customer filter active</h3>
        <div id="test3-result" class="result">Running...</div>
    </div>

    <div class="test-section">
        <h3>Test 4: Check if entry shows with payment channel filter active</h3>
        <div id="test4-result" class="result">Running...</div>
    </div>

    <div class="test-section">
        <h3>Test 5: Check entry details and filtering criteria</h3>
        <div id="test5-result" class="result">Running...</div>
    </div>

    <script>
        const { invoke } = window.__TAURI__.tauri;

        async function runTests() {
            try {
                // Test 1: Check if entry exists in database
                console.log('Test 1: Checking database for entry ID 58...');
                const entry58 = await invoke('execute_sql', {
                    query: 'SELECT * FROM ledger_entries WHERE id = 58',
                    params: []
                });

                if (entry58 && entry58.length > 0) {
                    document.getElementById('test1-result').className = 'result success';
                    document.getElementById('test1-result').innerHTML =
                        '<strong>‚úÖ PASS:</strong> Entry ID 58 found in database<br>' +
                        '<pre>' + JSON.stringify(entry58[0], null, 2) + '</pre>';
                } else {
                    document.getElementById('test1-result').className = 'result error';
                    document.getElementById('test1-result').innerHTML = '<strong>‚ùå FAIL:</strong> Entry ID 58 not found in database';
                    return; // Can't continue tests without the entry
                }

                // Test 2: Check daily ledger with no filters
                console.log('Test 2: Getting daily ledger entries with no filters...');
                const allEntries = await invoke('get_daily_ledger_entries', {
                    startDate: '2024-01-01',
                    endDate: '2024-12-31',
                    customerId: null,
                    paymentChannelIds: []
                });

                const entry58InAll = allEntries.find(e => e.id === 58);
                if (entry58InAll) {
                    document.getElementById('test2-result').className = 'result success';
                    document.getElementById('test2-result').innerHTML = '<strong>‚úÖ PASS:</strong> Entry ID 58 appears in unfiltered daily ledger';
                } else {
                    document.getElementById('test2-result').className = 'result error';
                    document.getElementById('test2-result').innerHTML = '<strong>‚ùå FAIL:</strong> Entry ID 58 missing from unfiltered daily ledger';
                }

                // Test 3: Check with customer filter (customer_id = 7)
                console.log('Test 3: Getting daily ledger entries with customer filter...');
                const customerFilteredEntries = await invoke('get_daily_ledger_entries', {
                    startDate: '2024-01-01',
                    endDate: '2024-12-31',
                    customerId: 7,
                    paymentChannelIds: []
                });

                const entry58WithCustomer = customerFilteredEntries.find(e => e.id === 58);
                if (entry58WithCustomer) {
                    document.getElementById('test3-result').className = 'result success';
                    document.getElementById('test3-result').innerHTML = '<strong>‚úÖ PASS:</strong> Entry ID 58 appears with customer filter (customer_id = 7)';
                } else {
                    document.getElementById('test3-result').className = 'result warning';
                    document.getElementById('test3-result').innerHTML = '<strong>‚ö†Ô∏è ISSUE:</strong> Entry ID 58 missing with customer filter - this might be the UI filtering issue';
                }

                // Test 4: Check payment channels
                console.log('Test 4: Getting payment channels and testing filter...');
                const channels = await invoke('get_payment_channels');
                const channelIds = channels.map(c => c.id);

                const paymentChannelFilteredEntries = await invoke('get_daily_ledger_entries', {
                    startDate: '2024-01-01',
                    endDate: '2024-12-31',
                    customerId: null,
                    paymentChannelIds: channelIds
                });

                const entry58WithPaymentFilter = paymentChannelFilteredEntries.find(e => e.id === 58);
                if (entry58WithPaymentFilter) {
                    document.getElementById('test4-result').className = 'result success';
                    document.getElementById('test4-result').innerHTML = '<strong>‚úÖ PASS:</strong> Entry ID 58 appears with payment channel filter';
                } else {
                    document.getElementById('test4-result').className = 'result warning';
                    document.getElementById('test4-result').innerHTML = '<strong>‚ö†Ô∏è ISSUE:</strong> Entry ID 58 missing with payment channel filter - refunds should bypass this filter';
                }

                // Test 5: Show detailed entry info
                const detailedEntry = entry58[0];
                document.getElementById('test5-result').className = 'result';
                document.getElementById('test5-result').innerHTML =
                    '<strong>üìã Entry Details:</strong><br>' +
                    `<strong>ID:</strong> ${detailedEntry.id}<br>` +
                    `<strong>Date:</strong> ${detailedEntry.date}<br>` +
                    `<strong>Description:</strong> ${detailedEntry.description}<br>` +
                    `<strong>Reference Type:</strong> ${detailedEntry.reference_type}<br>` +
                    `<strong>Customer ID:</strong> ${detailedEntry.customer_id}<br>` +
                    `<strong>Amount:</strong> ${detailedEntry.credit_amount || detailedEntry.debit_amount}<br>` +
                    `<strong>Payment Channel ID:</strong> ${detailedEntry.payment_channel_id || 'None'}<br>` +
                    `<strong>Payment Method:</strong> ${detailedEntry.payment_method || 'None'}<br>` +
                    '<br><strong>Filtering Criteria Analysis:</strong><br>' +
                    `‚Ä¢ Should pass customer filter (customer_id = 7): ${detailedEntry.customer_id === 7 ? 'YES' : 'NO'}<br>` +
                    `‚Ä¢ Should pass payment channel filter: ${!detailedEntry.payment_channel_id && !detailedEntry.payment_method ? 'YES (system entry)' : 'Depends on channels'}<br>` +
                    `‚Ä¢ Reference type 'other' should be included: ${detailedEntry.reference_type === 'other' ? 'YES' : 'NO'}`;

            } catch (error) {
                console.error('Test error:', error);
                document.querySelectorAll('[id$="-result"]').forEach(el => {
                    if (el.innerHTML === 'Running...') {
                        el.className = 'result error';
                        el.innerHTML = '<strong>‚ùå ERROR:</strong> ' + error.message;
                    }
                });
            }
        }

        // Run tests when page loads
        window.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>

</html>