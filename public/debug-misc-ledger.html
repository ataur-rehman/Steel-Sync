<!DOCTYPE html>
<html>

<head>
    <title>Debug Miscellaneous Item Ledger Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .error {
            background: #ffe6e6;
            color: #d00;
        }

        .success {
            background: #e6ffe6;
            color: #060;
        }

        .info {
            background: #e6f3ff;
            color: #006;
        }
    </style>
</head>

<body>
    <h1>üîç Debug Miscellaneous Item Ledger Creation</h1>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = message;
            output.appendChild(div);
            console.log(message);
        }

        async function runDebugTest() {
            log('üîç Starting miscellaneous item ledger debug test');

            // Test the exact data from your debug output
            const testItem = {
                productName: 'Service Charge2',
                productNameLower: 'service charge2',
                is_misc_item: 1,
                is_non_stock_item: 0,
                isTIronByName: false,
                shouldShowNonStock: false,
                misc_description: 'Service Charge2',
                total_price: 100
            };

            log('üìù Test item data: ' + JSON.stringify(testItem, null, 2));

            // Test the conditions
            const booleanCheck = Boolean(testItem.is_misc_item);
            const hasDescription = !!testItem.misc_description;
            const hasPositivePrice = testItem.total_price > 0;
            const willCreateLedger = booleanCheck && hasDescription && hasPositivePrice;

            log(`üß™ Condition tests:
- Boolean(is_misc_item): ${booleanCheck} (is_misc_item = ${testItem.is_misc_item})
- Has description: ${hasDescription} (misc_description = "${testItem.misc_description}")
- Has positive price: ${hasPositivePrice} (total_price = ${testItem.total_price})
- Will create ledger: ${willCreateLedger}`);

            if (!willCreateLedger) {
                log('‚ùå Conditions not met for ledger creation!', 'error');
                return;
            }

            // Test database access
            if (typeof window !== 'undefined' && window.db) {
                log('üîç Database available, testing ledger creation...');

                try {
                    // Try creating a test ledger entry directly
                    await window.db.createMiscellaneousItemLedgerEntry({
                        miscDescription: testItem.misc_description,
                        amount: testItem.total_price,
                        invoiceNumber: 'TEST-001',
                        customerName: 'Test Customer',
                        invoiceId: 999999,
                        date: '2025-01-22'
                    });

                    log('‚úÖ Miscellaneous item ledger entry created successfully!', 'success');

                    // Check if it was actually created
                    const entries = await window.db.getDailyLedgerEntries('2025-01-22', { customer_id: null });
                    const testEntry = entries.entries.find(e => e.description.includes('Service Charge2'));

                    if (testEntry) {
                        log('‚úÖ Ledger entry found in database: ' + JSON.stringify(testEntry, null, 2), 'success');
                    } else {
                        log('‚ùå Ledger entry NOT found in database despite successful creation!', 'error');
                    }

                } catch (error) {
                    log('‚ùå Failed to create miscellaneous item ledger entry: ' + error.message, 'error');
                    console.error('Full error:', error);
                }
            } else {
                log('‚ùå window.db not available - cannot test database operations', 'error');
            }
        }

        // Wait for page to load, then run test
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', runDebugTest);
        } else {
            runDebugTest();
        }
    </script>
</body>

</html>