<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß T-Iron Data Flow Debug (19√ó15 Issue)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #dc3545;
            background: #f8d7da;
        }

        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .info {
            border-left-color: #17a2b8;
            background: #d1ecf1;
        }

        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #c82333;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 500px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.4;
        }

        .scenario {
            background: #ffebee;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #f44336;
        }

        .expected {
            color: #28a745;
            font-weight: bold;
        }

        .actual {
            color: #dc3545;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th,
        td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #e9ecef;
        }

        .critical {
            background: #ffebee;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîß T-Iron Data Flow Debug - 19√ó15 Issue</h1>

        <div class="scenario">
            <h2>üö® CRITICAL BUG REPORT</h2>
            <p><strong>Calculator Input:</strong> 19 Pieces √ó 15 Length/pc √ó 112 Price/ft</p>
            <p><strong>Expected Display:</strong> <span class="expected">T Iron (19pcs √ó 15ft/pcs √ó Rs.112)</span></p>
            <p><strong>Actual Display:</strong> <span class="actual">T Iron (24pcs √ó 12ft/pcs √ó Rs.112) ‚ö†Ô∏è</span></p>
            <p><strong>Total Feet:</strong> 285 ft ‚úÖ (Correct: 19 √ó 15 = 285)</p>
            <p><strong>Problem:</strong> T-Iron data is NOT being saved to database ‚Üí falls back to smart reconstruction
            </p>
        </div>

        <div class="test-section info">
            <h2>üîç Debug Plan</h2>
            <ol>
                <li>Test exact user scenario: 19pcs √ó 15ft √ó 112Rs</li>
                <li>Check if T-Iron schema exists in database</li>
                <li>Verify data save operation</li>
                <li>Check data retrieval from database</li>
                <li>Test smart reconstruction fallback (should show 19√ó15, not 24√ó12)</li>
                <li>Check date/time formatting issue</li>
            </ol>
        </div>

        <div class="test-section">
            <h2>üß™ Critical Debug Tests</h2>
            <button onclick="testUserScenario19x15()">üéØ Test 19√ó15√ó112 Scenario</button>
            <button onclick="checkTIronSchema()">üîß Check T-Iron Schema</button>
            <button onclick="testDataSaveLoad()">üíæ Test Save/Load Process</button>
            <button onclick="testSmartReconstruction285()">ü§ñ Test Reconstruction for 285ft</button>
            <button onclick="testDateTime()">üïê Test Date/Time Issue</button>
            <button onclick="clearResults()">üßπ Clear</button>
        </div>

        <div id="results" class="test-section info">
            <h2>üìã Debug Results</h2>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîß',
                'critical': 'üö®'
            }[type] || '‚ÑπÔ∏è';

            testLog.push(`[${timestamp}] ${typeIcon} ${message}`);
            updateDisplay();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateDisplay() {
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            document.getElementById('testLog').scrollTop = document.getElementById('testLog').scrollHeight;
        }

        function clearResults() {
            testLog = [];
            updateDisplay();
            log('üîß T-Iron Data Flow Debug Ready', 'info');
        }

        async function testUserScenario19x15() {
            log('üéØ TESTING: User scenario 19pcs √ó 15ft √ó 112Rs = 285ft', 'critical');

            try {
                // Create test invoice
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Debug 19x15 Customer',
                    bill_number: 'DEBUG-19x15-' + Date.now(),
                    subtotal: 31920,
                    total_amount: 31920,
                    grand_total: 31920
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                log(`üìã Created test invoice: ${invoiceId}`, 'success');

                // Add T-Iron item EXACTLY as calculator should produce
                const calculatorOutput = {
                    product_id: null,
                    product_name: 'T Iron',
                    quantity: 285, // 19 √ó 15 = 285
                    unit_price: 112,
                    total_price: 31920, // 285 √ó 112 = 31920
                    unit: 'ft',
                    t_iron_pieces: 19, // ‚Üê USER INPUT
                    t_iron_length_per_piece: 15, // ‚Üê USER INPUT
                    t_iron_total_feet: 285,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                log('üíæ SAVING: T-Iron with exact calculator output:', 'debug');
                log(`   Pieces: ${calculatorOutput.t_iron_pieces}`, 'debug');
                log(`   Length/piece: ${calculatorOutput.t_iron_length_per_piece}`, 'debug');
                log(`   Total feet: ${calculatorOutput.t_iron_total_feet}`, 'debug');
                log(`   Price/foot: ${calculatorOutput.unit_price}`, 'debug');
                log(`   Total amount: ${calculatorOutput.total_price}`, 'debug');

                const itemIds = await window.db.addInvoiceItems(invoiceId, [calculatorOutput]);
                log(`‚úÖ Added T-Iron item with ID: ${itemIds[0]}`, 'success');

                // CRITICAL: Retrieve and check what was actually saved
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    log('üîç CRITICAL: Database storage verification:', 'critical');
                    log(`   Raw pieces: ${savedItem.t_iron_pieces} (type: ${typeof savedItem.t_iron_pieces})`, 'debug');
                    log(`   Raw length: ${savedItem.t_iron_length_per_piece} (type: ${typeof savedItem.t_iron_length_per_piece})`, 'debug');
                    log(`   Raw total: ${savedItem.t_iron_total_feet} (type: ${typeof savedItem.t_iron_total_feet})`, 'debug');
                    log(`   Raw unit: ${savedItem.t_iron_unit}`, 'debug');

                    // Test display logic conditions
                    const hasTPieces = savedItem.t_iron_pieces !== null && savedItem.t_iron_pieces !== undefined;
                    const hasTLength = savedItem.t_iron_length_per_piece !== null && savedItem.t_iron_length_per_piece !== undefined;

                    log(`üîç Display logic conditions:`, 'debug');
                    log(`   Has t_iron_pieces: ${hasTPieces} (${savedItem.t_iron_pieces})`, hasTPieces ? 'success' : 'error');
                    log(`   Has t_iron_length_per_piece: ${hasTLength} (${savedItem.t_iron_length_per_piece})`, hasTLength ? 'success' : 'error');

                    if (hasTPieces && hasTLength) {
                        // Test enhanced type conversion
                        const pieces = Number(savedItem.t_iron_pieces);
                        const lengthPerPiece = Number(savedItem.t_iron_length_per_piece);
                        const unitPrice = Number(savedItem.unit_price);

                        log(`üîß Type conversion test:`, 'debug');
                        log(`   ${savedItem.t_iron_pieces} ‚Üí ${pieces} (valid: ${pieces > 0})`, pieces > 0 ? 'success' : 'error');
                        log(`   ${savedItem.t_iron_length_per_piece} ‚Üí ${lengthPerPiece} (valid: ${lengthPerPiece > 0})`, lengthPerPiece > 0 ? 'success' : 'error');

                        if (pieces > 0 && lengthPerPiece > 0) {
                            const unit = savedItem.t_iron_unit || 'pcs';
                            const displayText = `(${pieces}${unit} √ó ${lengthPerPiece}ft/${unit} √ó Rs.${unitPrice})`;

                            log('üéâ ENHANCED DISPLAY WOULD SHOW:', 'success');
                            log(`   "T Iron ${displayText}"`, 'success');

                            if (pieces === 19 && lengthPerPiece === 15) {
                                log('üéâ SUCCESS! Shows exact user input: 19pcs √ó 15ft', 'success');
                            } else {
                                log(`‚ùå WRONG VALUES: ${pieces}pcs √ó ${lengthPerPiece}ft (expected 19√ó15)`, 'error');
                            }
                        } else {
                            log('‚ùå TYPE CONVERSION FAILED - Would fall back to reconstruction', 'error');
                        }
                    } else {
                        log('üö® CRITICAL: T-Iron data NOT SAVED - Would use reconstruction', 'critical');
                        log('   This is why you see 24√ó12 instead of 19√ó15!', 'critical');

                        // Test reconstruction for 285 feet
                        testReconstructionForValue(285);
                    }
                } else {
                    log('‚ùå Could not retrieve saved item', 'error');
                }

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function checkTIronSchema() {
            log('üîß CHECKING: T-Iron database schema', 'info');

            try {
                // Test if T-Iron fields exist in the database
                log('üîç Testing T-Iron schema existence...', 'debug');

                // Create a minimal test invoice to check schema
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Schema Test Customer',
                    bill_number: 'SCHEMA-' + Date.now(),
                    subtotal: 100,
                    total_amount: 100,
                    grand_total: 100
                };

                const invoiceId = await window.db.createInvoice(testInvoice);

                // Try to add an item with T-Iron fields
                const testItem = {
                    product_id: null,
                    product_name: 'Schema Test Item',
                    quantity: '10',
                    unit_price: 10,
                    total_price: 100,
                    unit: 'ft',
                    t_iron_pieces: 5,
                    t_iron_length_per_piece: 2,
                    t_iron_total_feet: 10,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                const itemIds = await window.db.addInvoiceItems(invoiceId, [testItem]);
                log(`‚úÖ Successfully added item with T-Iron fields: ${itemIds[0]}`, 'success');

                // Retrieve and check if T-Iron fields were preserved
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    const schemaFields = {
                        't_iron_pieces': savedItem.t_iron_pieces,
                        't_iron_length_per_piece': savedItem.t_iron_length_per_piece,
                        't_iron_total_feet': savedItem.t_iron_total_feet,
                        't_iron_unit': savedItem.t_iron_unit
                    };

                    log('üîç T-Iron schema verification:', 'debug');
                    for (const [field, value] of Object.entries(schemaFields)) {
                        const exists = value !== null && value !== undefined;
                        log(`   ${field}: ${value} (${exists ? 'EXISTS' : 'MISSING'})`, exists ? 'success' : 'error');
                    }

                    const allFieldsExist = Object.values(schemaFields).every(v => v !== null && v !== undefined);
                    if (allFieldsExist) {
                        log('‚úÖ T-Iron schema is COMPLETE and working', 'success');
                    } else {
                        log('‚ùå T-Iron schema is INCOMPLETE or not working', 'error');
                        log('   This explains why T-Iron data is not being preserved!', 'error');
                    }
                } else {
                    log('‚ùå Could not retrieve schema test item', 'error');
                }

            } catch (error) {
                log(`‚ùå Schema check failed: ${error.message}`, 'error');
                log('   This indicates T-Iron schema is not properly configured', 'error');
            }
        }

        async function testDataSaveLoad() {
            log('üíæ TESTING: Complete data save/load cycle', 'info');

            try {
                const testCases = [
                    { desc: "User's 19√ó15", pieces: 19, length: 15, price: 112 },
                    { desc: "Simple 10√ó12", pieces: 10, length: 12, price: 100 },
                    { desc: "Edge case 1√ó285", pieces: 1, length: 285, price: 112 }
                ];

                for (const testCase of testCases) {
                    log(`üß™ Testing: ${testCase.desc}`, 'debug');

                    const totalFeet = testCase.pieces * testCase.length;
                    const totalAmount = totalFeet * testCase.price;

                    const testInvoice = {
                        customer_id: 1,
                        customer_name: `Test ${testCase.desc}`,
                        bill_number: `TEST-${Date.now()}-${Math.random()}`,
                        subtotal: totalAmount,
                        total_amount: totalAmount,
                        grand_total: totalAmount
                    };

                    const invoiceId = await window.db.createInvoice(testInvoice);

                    const testItem = {
                        product_id: null,
                        product_name: 'T Iron',
                        quantity: totalFeet.toString(),
                        unit_price: testCase.price,
                        total_price: totalAmount,
                        unit: 'ft',
                        t_iron_pieces: testCase.pieces,
                        t_iron_length_per_piece: testCase.length,
                        t_iron_total_feet: totalFeet,
                        t_iron_unit: 'pcs',
                        is_non_stock_item: 1
                    };

                    const itemIds = await window.db.addInvoiceItems(invoiceId, [testItem]);
                    const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                    const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                    if (savedItem) {
                        const piecesOK = Number(savedItem.t_iron_pieces) === testCase.pieces;
                        const lengthOK = Number(savedItem.t_iron_length_per_piece) === testCase.length;

                        if (piecesOK && lengthOK) {
                            log(`   ‚úÖ ${testCase.desc}: Data preserved correctly`, 'success');
                        } else {
                            log(`   ‚ùå ${testCase.desc}: Data corrupted!`, 'error');
                            log(`     Expected: ${testCase.pieces}√ó${testCase.length}`, 'error');
                            log(`     Got: ${savedItem.t_iron_pieces}√ó${savedItem.t_iron_length_per_piece}`, 'error');
                        }
                    } else {
                        log(`   ‚ùå ${testCase.desc}: Could not retrieve`, 'error');
                    }
                }

            } catch (error) {
                log(`‚ùå Data save/load test failed: ${error.message}`, 'error');
            }
        }

        function testSmartReconstruction285() {
            log('ü§ñ TESTING: Smart reconstruction for 285 feet', 'warning');
            testReconstructionForValue(285);
        }

        function testReconstructionForValue(totalFeet) {
            try {
                log(`üîß Testing reconstruction algorithm for ${totalFeet} feet`, 'debug');

                // Simulate the enhanced algorithm
                const commonLengths = [14, 12, 10, 16, 8, 20];
                let bestFit = { pieces: Math.round(totalFeet / 12), length: 12, difference: Math.abs(totalFeet % 12) };

                log('üßÆ Testing common lengths:', 'debug');
                for (const length of commonLengths) {
                    const pieces = Math.round(totalFeet / length);
                    const calculatedTotal = pieces * length;
                    const difference = Math.abs(totalFeet - calculatedTotal);

                    log(`   ${pieces} √ó ${length} = ${calculatedTotal} (diff: ${difference})`, 'debug');

                    if (difference < bestFit.difference && pieces > 0) {
                        bestFit = { pieces, length, difference };
                        log(`     ‚≠ê New best fit!`, 'debug');
                    } else if (difference === bestFit.difference && difference === 0) {
                        if (pieces < bestFit.pieces && length > bestFit.length) {
                            bestFit = { pieces, length, difference };
                            log(`     ‚≠ê Better perfect match (fewer pieces, longer length)!`, 'debug');
                        }
                    }
                }

                log(`üéØ RECONSTRUCTION RESULT: ${bestFit.pieces}pcs √ó ${bestFit.length}ft/pcs`, 'warning');

                if (bestFit.pieces === 19 && bestFit.length === 15) {
                    log('üéâ Reconstruction would show correct 19√ó15!', 'success');
                } else if (bestFit.pieces === 24 && bestFit.length === 12) {
                    log('‚ö†Ô∏è Reconstruction shows 24√ó12 (current wrong behavior)', 'warning');
                    log('   This explains what user is seeing!', 'warning');
                } else {
                    log(`ü§î Reconstruction shows: ${bestFit.pieces}√ó${bestFit.length}`, 'warning');
                }

                // Check for exact match
                if (285 % 15 === 0) {
                    const exactPieces = 285 / 15;
                    log(`üîç EXACT MATCH POSSIBLE: ${exactPieces} √ó 15 = ${285}`, 'info');
                    if (exactPieces === 19) {
                        log('‚úÖ 19√ó15 is a perfect match for 285 feet!', 'success');
                    }
                }

            } catch (error) {
                log(`‚ùå Reconstruction test failed: ${error.message}`, 'error');
            }
        }

        function testDateTime() {
            log('üïê TESTING: Date/Time formatting issue', 'info');

            try {
                log('üîç Current system date/time:', 'debug');
                const now = new Date();
                log(`   JavaScript Date: ${now.toString()}`, 'debug');
                log(`   Locale Date String: ${now.toLocaleDateString()}`, 'debug');
                log(`   Locale Time String: ${now.toLocaleTimeString()}`, 'debug');

                // User reported system time: 08/23/25 01:20 AM
                // But app showed: 22/08/25 08:20 PM
                log('üö® REPORTED TIME BUG:', 'warning');
                log('   System: 08/23/25 01:20 AM', 'warning');
                log('   App showed: 22/08/25 08:20 PM', 'warning');
                log('   Issues: Wrong date (22 vs 23), wrong time (20:20 vs 01:20)', 'warning');

                // Check if there's a timezone issue
                log('üîç Timezone investigation:', 'debug');
                log(`   UTC: ${now.toISOString()}`, 'debug');
                log(`   Timezone offset: ${now.getTimezoneOffset()} minutes`, 'debug');

                // Test custom date formatting
                const testDate = new Date();
                const formatOptions = {
                    day: '2-digit',
                    month: '2-digit',
                    year: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                };

                log(`üìÖ Formatted test: ${testDate.toLocaleDateString('en-US', formatOptions)}`, 'debug');

            } catch (error) {
                log(`‚ùå DateTime test failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üîß T-Iron Data Flow Debug Ready - 19√ó15 Issue', 'info');
        log('üìã Click "Test 19√ó15√ó112 Scenario" to debug the exact issue', 'info');
    </script>
</body>

</html>