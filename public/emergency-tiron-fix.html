<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° T-Iron Database Emergency Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #ff6b6b;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .emergency {
            background: #ff4757;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .fix-section {
            background: #2f3542;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .success {
            background: #2ed573;
            color: #333;
        }

        button {
            background: #ff4757;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px 5px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
        }

        button.success {
            background: #2ed573;
            color: #333;
        }

        button.warning {
            background: #ffa502;
            color: #333;
        }

        button:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }

        .log {
            background: #1e272e;
            border: 2px solid #ff4757;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
        }

        .status.critical {
            background: #ff4757;
        }

        .status.success {
            background: #2ed573;
            color: #333;
        }

        .status.warning {
            background: #ffa502;
            color: #333;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="emergency">
            <h1>‚ö° EMERGENCY T-IRON DATABASE FIX</h1>
            <h2>üö® CRITICAL: T-Iron columns are empty!</h2>
            <p><strong>Impact:</strong> Smart reconstruction instead of actual user input</p>
        </div>

        <div class="fix-section">
            <h2>üîß Emergency Actions</h2>
            <button onclick="emergencySchemaCheck()" class="warning">üîç EMERGENCY SCHEMA CHECK</button>
            <button onclick="forceSchemaRecreation()" class="critical">üö® FORCE SCHEMA RECREATION</button>
            <button onclick="emergencyColumnAdd()" class="success">‚ö° ADD MISSING COLUMNS</button>
        </div>

        <div id="emergency-status" class="status critical">
            SYSTEM STATUS: T-Iron columns not saving data - CRITICAL FAILURE
        </div>

        <div class="fix-section">
            <h3>üìã Emergency Log</h3>
            <div id="emergencyLog" class="log">Emergency T-Iron database fix tool ready...\nClick "EMERGENCY SCHEMA
                CHECK" to diagnose the problem.</div>
        </div>

        <div class="fix-section">
            <h3>üéØ Quick Fix Commands</h3>
            <button onclick="testQuickFix()" class="success">üöÄ TEST QUICK FIX</button>
            <button onclick="verifyFix()" class="warning">‚úÖ VERIFY FIX WORKED</button>
        </div>
    </div>

    <script>
        let emergencyLog = [];

        function eLog(message, urgent = false) {
            const timestamp = new Date().toLocaleTimeString();
            const urgentMark = urgent ? 'üö® URGENT: ' : '';
            emergencyLog.push(`[${timestamp}] ${urgentMark}${message}`);
            updateEmergencyLog();
            if (urgent) console.error(message);
            else console.log(message);
        }

        function updateEmergencyLog() {
            document.getElementById('emergencyLog').innerHTML = emergencyLog.join('\n');
            document.getElementById('emergencyLog').scrollTop = document.getElementById('emergencyLog').scrollHeight;
        }

        function updateStatus(message, type = 'critical') {
            const statusEl = document.getElementById('emergency-status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        async function emergencySchemaCheck() {
            eLog('üö® EMERGENCY SCHEMA CHECK INITIATED', true);

            try {
                if (!window.db) {
                    eLog('‚ùå CRITICAL: No database connection!', true);
                    updateStatus('NO DATABASE CONNECTION - SYSTEM FAILURE', 'critical');
                    return;
                }

                eLog('üîç Checking invoice_items table schema...');
                const tableInfo = await window.db.execute(`PRAGMA table_info(invoice_items)`);

                eLog(`üìä Found ${tableInfo.length} columns in invoice_items table`);

                const requiredColumns = ['t_iron_pieces', 't_iron_length_per_piece', 't_iron_total_feet', 't_iron_unit'];
                const existingColumns = tableInfo.map(col => col.name);
                const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));

                eLog('üîç T-Iron column status:');
                for (const col of requiredColumns) {
                    const exists = existingColumns.includes(col);
                    eLog(`   ${col}: ${exists ? '‚úÖ EXISTS' : '‚ùå MISSING'}`, !exists);
                }

                if (missingColumns.length > 0) {
                    eLog(`üö® CRITICAL: ${missingColumns.length} T-Iron columns missing!`, true);
                    updateStatus(`MISSING COLUMNS: ${missingColumns.join(', ')}`, 'critical');
                } else {
                    eLog('‚úÖ All T-Iron columns exist in schema');

                    // If columns exist, check if data is being saved
                    eLog('üîç Checking if T-Iron data is actually being saved...');
                    try {
                        const recentTIron = await window.db.execute(`
                            SELECT id, product_name, t_iron_pieces, t_iron_length_per_piece, t_iron_total_feet
                            FROM invoice_items 
                            WHERE product_name LIKE '%Iron%' 
                            ORDER BY id DESC 
                            LIMIT 5
                        `);

                        eLog(`üìä Found ${recentTIron.length} recent T-Iron items`);
                        let hasValidData = false;

                        for (const item of recentTIron) {
                            const hasData = item.t_iron_pieces && item.t_iron_length_per_piece;
                            eLog(`   ID ${item.id}: Pieces=${item.t_iron_pieces}, Length=${item.t_iron_length_per_piece} ${hasData ? '‚úÖ' : '‚ùå'}`);
                            if (hasData) hasValidData = true;
                        }

                        if (!hasValidData) {
                            eLog('üö® CRITICAL: T-Iron columns exist but NO DATA is being saved!', true);
                            updateStatus('COLUMNS EXIST BUT DATA NOT SAVING - LOGIC ERROR', 'critical');
                        } else {
                            eLog('‚úÖ Some T-Iron data found - partial fix may be needed');
                            updateStatus('PARTIAL DATA FOUND - NEEDS INVESTIGATION', 'warning');
                        }

                    } catch (dataError) {
                        eLog(`‚ùå Error checking T-Iron data: ${dataError.message}`, true);
                    }
                }

            } catch (error) {
                eLog(`‚ùå EMERGENCY SCHEMA CHECK FAILED: ${error.message}`, true);
                updateStatus('SCHEMA CHECK FAILED - SYSTEM ERROR', 'critical');
            }
        }

        async function forceSchemaRecreation() {
            eLog('üö® FORCE SCHEMA RECREATION INITIATED', true);

            try {
                if (!window.db) {
                    eLog('‚ùå No database connection', true);
                    return;
                }

                eLog('‚ö†Ô∏è WARNING: This will recreate the invoice_items table');
                eLog('üì¶ Backing up existing data...');

                let backupData = [];
                try {
                    backupData = await window.db.execute('SELECT * FROM invoice_items');
                    eLog(`‚úÖ Backed up ${backupData.length} existing items`);
                } catch (backupError) {
                    eLog('‚ö†Ô∏è No existing data to backup');
                }

                eLog('üîß Dropping existing table...');
                await window.db.execute('DROP TABLE IF EXISTS invoice_items');

                eLog('üîß Creating new table with T-Iron support...');
                await window.db.execute(`
                    CREATE TABLE invoice_items (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        invoice_id INTEGER NOT NULL,
                        product_id INTEGER DEFAULT NULL,
                        product_name TEXT NOT NULL,
                        quantity TEXT DEFAULT '1',
                        unit_price REAL NOT NULL CHECK (unit_price >= 0),
                        rate REAL NOT NULL CHECK (rate > 0),
                        total_price REAL NOT NULL CHECK (total_price >= 0),
                        amount REAL NOT NULL CHECK (amount >= 0),
                        unit TEXT DEFAULT 'piece',
                        length REAL DEFAULT NULL,
                        pieces REAL DEFAULT NULL,
                        is_misc_item BOOLEAN DEFAULT 0,
                        misc_description TEXT DEFAULT NULL,
                        is_non_stock_item BOOLEAN DEFAULT 0,
                        t_iron_pieces INTEGER DEFAULT NULL,
                        t_iron_length_per_piece REAL DEFAULT NULL,
                        t_iron_total_feet REAL DEFAULT NULL,
                        t_iron_unit TEXT DEFAULT NULL,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (invoice_id) REFERENCES invoices(id) ON DELETE CASCADE
                    )
                `);

                eLog('‚úÖ New table created with full T-Iron support!');

                // Restore backup data
                if (backupData.length > 0) {
                    eLog('üì¶ Restoring backup data...');
                    for (const item of backupData) {
                        try {
                            await window.db.execute(`
                                INSERT INTO invoice_items (
                                    id, invoice_id, product_id, product_name, quantity, unit_price, 
                                    rate, total_price, amount, unit, length, pieces, is_misc_item, 
                                    misc_description, is_non_stock_item, t_iron_pieces, 
                                    t_iron_length_per_piece, t_iron_total_feet, t_iron_unit, 
                                    created_at, updated_at
                                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                            `, [
                                item.id, item.invoice_id, item.product_id, item.product_name,
                                item.quantity, item.unit_price, item.rate || item.unit_price,
                                item.total_price, item.amount || item.total_price, item.unit || 'piece',
                                item.length, item.pieces, item.is_misc_item || 0, item.misc_description,
                                item.is_non_stock_item || 0, item.t_iron_pieces,
                                item.t_iron_length_per_piece, item.t_iron_total_feet, item.t_iron_unit,
                                item.created_at, item.updated_at
                            ]);
                        } catch (restoreError) {
                            eLog(`‚ö†Ô∏è Failed to restore item ${item.id}: ${restoreError.message}`);
                        }
                    }
                    eLog('‚úÖ Data restoration completed');
                }

                eLog('üéâ SCHEMA RECREATION COMPLETED!', true);
                updateStatus('SCHEMA RECREATED SUCCESSFULLY - T-IRON SUPPORT ACTIVE', 'success');

            } catch (error) {
                eLog(`‚ùå SCHEMA RECREATION FAILED: ${error.message}`, true);
                updateStatus('SCHEMA RECREATION FAILED - MANUAL INTERVENTION NEEDED', 'critical');
            }
        }

        async function emergencyColumnAdd() {
            eLog('‚ö° EMERGENCY COLUMN ADDITION INITIATED', true);

            try {
                if (!window.db) {
                    eLog('‚ùå No database connection', true);
                    return;
                }

                const columnsToAdd = [
                    { name: 't_iron_pieces', type: 'INTEGER DEFAULT NULL' },
                    { name: 't_iron_length_per_piece', type: 'REAL DEFAULT NULL' },
                    { name: 't_iron_total_feet', type: 'REAL DEFAULT NULL' },
                    { name: 't_iron_unit', type: 'TEXT DEFAULT NULL' }
                ];

                eLog('üîß Adding T-Iron columns...');
                for (const column of columnsToAdd) {
                    try {
                        await window.db.execute(`ALTER TABLE invoice_items ADD COLUMN ${column.name} ${column.type}`);
                        eLog(`‚úÖ Added column: ${column.name}`);
                    } catch (columnError) {
                        if (columnError.message.includes('duplicate')) {
                            eLog(`‚ÑπÔ∏è Column ${column.name} already exists`);
                        } else {
                            eLog(`‚ùå Failed to add ${column.name}: ${columnError.message}`, true);
                        }
                    }
                }

                eLog('üéâ EMERGENCY COLUMN ADDITION COMPLETED!', true);
                updateStatus('T-IRON COLUMNS ADDED SUCCESSFULLY', 'success');

            } catch (error) {
                eLog(`‚ùå COLUMN ADDITION FAILED: ${error.message}`, true);
                updateStatus('COLUMN ADDITION FAILED', 'critical');
            }
        }

        async function testQuickFix() {
            eLog('üöÄ TESTING QUICK FIX...', true);

            try {
                // Create test invoice
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Emergency Test',
                    bill_number: 'EMERGENCY-' + Date.now(),
                    subtotal: 1000,
                    total_amount: 1000,
                    grand_total: 1000
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                eLog(`‚úÖ Test invoice created: ${invoiceId}`);

                // Add T-Iron item
                const testTIron = {
                    product_id: null,
                    product_name: 'T Iron Emergency Test',
                    quantity: '132',
                    unit_price: 124,
                    total_price: 16368,
                    unit: 'ft',
                    t_iron_pieces: 11,
                    t_iron_length_per_piece: 12,
                    t_iron_total_feet: 132,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                eLog('üíæ Saving T-Iron test item...');
                const itemIds = await window.db.addInvoiceItems(invoiceId, [testTIron]);
                eLog(`‚úÖ Item saved with ID: ${itemIds[0]}`);

                // Verify
                const saved = await window.db.getInvoiceDetails(invoiceId);
                const item = saved.items[0];

                eLog('üîç Verification results:');
                eLog(`   Pieces: ${item.t_iron_pieces}`);
                eLog(`   Length: ${item.t_iron_length_per_piece}`);
                eLog(`   Total: ${item.t_iron_total_feet}`);

                if (item.t_iron_pieces && item.t_iron_length_per_piece) {
                    eLog('üéâ QUICK FIX SUCCESSFUL!', true);
                    updateStatus('QUICK FIX WORKED - T-IRON DATA SAVING', 'success');
                } else {
                    eLog('‚ùå QUICK FIX FAILED - DATA STILL NOT SAVING', true);
                    updateStatus('QUICK FIX FAILED - DEEPER ISSUE PRESENT', 'critical');
                }

            } catch (error) {
                eLog(`‚ùå QUICK FIX TEST FAILED: ${error.message}`, true);
                updateStatus('QUICK FIX TEST FAILED', 'critical');
            }
        }

        async function verifyFix() {
            eLog('‚úÖ VERIFYING FIX STATUS...');

            try {
                if (!window.db) {
                    eLog('‚ùå No database connection');
                    return;
                }

                // Check schema
                const tableInfo = await window.db.execute(`PRAGMA table_info(invoice_items)`);
                const tIronCols = tableInfo.filter(col => col.name.includes('t_iron'));

                eLog(`üìä T-Iron columns found: ${tIronCols.length}/4`);

                if (tIronCols.length === 4) {
                    eLog('‚úÖ Schema is correct');

                    // Check recent data
                    const recentData = await window.db.execute(`
                        SELECT t_iron_pieces, t_iron_length_per_piece 
                        FROM invoice_items 
                        WHERE product_name LIKE '%Iron%' 
                        AND t_iron_pieces IS NOT NULL 
                        ORDER BY id DESC 
                        LIMIT 3
                    `);

                    if (recentData.length > 0) {
                        eLog(`‚úÖ Found ${recentData.length} items with valid T-Iron data`);
                        updateStatus('FIX VERIFIED - T-IRON SYSTEM OPERATIONAL', 'success');
                    } else {
                        eLog('‚ö†Ô∏è Schema correct but no T-Iron data found');
                        updateStatus('SCHEMA OK BUT NO DATA - NEEDS TESTING', 'warning');
                    }
                } else {
                    eLog('‚ùå Schema still incomplete');
                    updateStatus('SCHEMA STILL BROKEN - RETRY FIX', 'critical');
                }

            } catch (error) {
                eLog(`‚ùå Verification failed: ${error.message}`);
            }
        }

        // Initialize
        eLog('‚ö° Emergency T-Iron Database Fix Tool Ready');
        eLog('üö® CRITICAL: T-Iron data not saving - immediate action required');
    </script>
</body>

</html>