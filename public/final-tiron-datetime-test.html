<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Final T-Iron & DateTime Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007acc;
            background: #f8f9fa;
        }

        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .critical {
            border-left-color: #dc3545;
            background: #ffebee;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button.critical {
            background: #dc3545;
        }

        button:hover {
            opacity: 0.9;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 600px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .scenario {
            background: #fff3cd;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
        }

        .expected {
            color: #28a745;
            font-weight: bold;
            font-size: 16px;
        }

        .actual {
            color: #dc3545;
            font-weight: bold;
            font-size: 16px;
        }

        .fixed {
            color: #28a745;
            font-weight: bold;
            font-size: 16px;
        }

        .highlight {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .status-ok {
            color: #28a745;
            font-weight: bold;
        }

        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéØ Final T-Iron & DateTime Fix Verification</h1>

        <div class="scenario">
            <h2>üö® CRITICAL ISSUES TO FIX</h2>
            <h3>Issue 1: T-Iron Display</h3>
            <p><strong>Input:</strong> 19 Pieces √ó 15 Length/pc √ó 112 Price/ft = 285 ft total</p>
            <p><strong>Wrong Display:</strong> <span class="actual">T Iron (24pcs √ó 12ft/pcs √ó Rs.112) ‚ö†Ô∏è</span></p>
            <p><strong>Expected Display:</strong> <span class="expected">T Iron (19pcs √ó 15ft/pcs √ó Rs.112)</span></p>

            <h3>Issue 2: Date/Time Display</h3>
            <p><strong>System Time:</strong> 08/23/25 01:20 AM</p>
            <p><strong>Wrong Display:</strong> <span class="actual">Added: 22/08/25 08:20 PM</span></p>
            <p><strong>Expected Display:</strong> <span class="expected">Added: 23/08/25 01:20 AM</span></p>
        </div>

        <div class="test-section">
            <h2>üîß Applied Fixes</h2>
            <ul>
                <li>‚úÖ Enhanced T-Iron data type conversion (Number() casting)</li>
                <li>‚úÖ Improved T-Iron condition checking (robust null/undefined handling)</li>
                <li>‚úÖ Added 15ft to common lengths array for smart reconstruction</li>
                <li>‚úÖ Enhanced logging for debugging data flow</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üß™ Comprehensive Tests</h2>
            <button onclick="testCompleteUserScenario()" class="critical">üéØ Test Complete User Scenario
                (19√ó15)</button>
            <button onclick="testDateTimeAccuracy()">üïê Test DateTime Accuracy</button>
            <button onclick="testTIronReconstructionFix()">ü§ñ Test T-Iron Reconstruction Fix</button>
            <button onclick="testDatabaseSchemaIntegrity()">üîß Test Database Schema</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
        </div>

        <div id="results" class="test-section">
            <h2>üìã Test Results</h2>
            <div id="testLog" class="log">Ready to test the complete fix...</div>
        </div>
    </div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîß',
                'critical': 'üö®',
                'fixed': 'üéâ'
            }[type] || '‚ÑπÔ∏è';

            testLog.push(`[${timestamp}] ${typeIcon} ${message}`);
            updateDisplay();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateDisplay() {
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            document.getElementById('testLog').scrollTop = document.getElementById('testLog').scrollHeight;
        }

        function clearResults() {
            testLog = [];
            updateDisplay();
            log('üéØ Final T-Iron & DateTime Fix Test Ready', 'info');
        }

        async function testCompleteUserScenario() {
            log('üö® TESTING: Complete user scenario (19√ó15√ó112 + DateTime)', 'critical');

            try {
                // Test current system time first
                const systemTime = new Date();
                log('üïê Current system time verification:', 'debug');
                log(`   Browser time: ${systemTime.toString()}`, 'debug');
                log(`   Locale string: ${systemTime.toLocaleString()}`, 'debug');
                log(`   Expected by user: 08/23/25 01:20 AM`, 'debug');

                // Create test invoice with current timestamp
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Final Test Customer 19x15',
                    bill_number: 'FINAL-19x15-' + Date.now(),
                    subtotal: 31920,
                    total_amount: 31920,
                    grand_total: 31920
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                log(`üìã Created test invoice: ${invoiceId}`, 'success');

                // Add T-Iron item exactly as user entered
                const userTIronItem = {
                    product_id: null,
                    product_name: 'T Iron',
                    quantity: '285', // 19 √ó 15 = 285
                    unit_price: 112,
                    total_price: 31920, // 285 √ó 112 = 31920
                    unit: 'ft',
                    t_iron_pieces: 19, // ‚Üê USER INPUT
                    t_iron_length_per_piece: 15, // ‚Üê USER INPUT
                    t_iron_total_feet: 285,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                log('üíæ SAVING: T-Iron with user data + timestamp:', 'debug');
                log(`   Pieces: ${userTIronItem.t_iron_pieces}`, 'debug');
                log(`   Length: ${userTIronItem.t_iron_length_per_piece}`, 'debug');
                log(`   Total: ${userTIronItem.t_iron_total_feet}`, 'debug');
                log(`   Save time: ${systemTime.toLocaleString()}`, 'debug');

                const startTime = Date.now();
                const itemIds = await window.db.addInvoiceItems(invoiceId, [userTIronItem]);
                const endTime = Date.now();

                log(`‚úÖ Saved T-Iron item with ID: ${itemIds[0]} (took ${endTime - startTime}ms)`, 'success');

                // CRITICAL: Retrieve and verify both display and timestamp
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    log('üîç COMPLETE VERIFICATION:', 'critical');

                    // Test 1: T-Iron Display Logic
                    log('üì∫ T-Iron Display Test:', 'debug');
                    log(`   Raw pieces: ${savedItem.t_iron_pieces} (${typeof savedItem.t_iron_pieces})`, 'debug');
                    log(`   Raw length: ${savedItem.t_iron_length_per_piece} (${typeof savedItem.t_iron_length_per_piece})`, 'debug');

                    // Apply enhanced conditions from fix
                    const hasTIronPieces = savedItem.t_iron_pieces !== null && savedItem.t_iron_pieces !== undefined && savedItem.t_iron_pieces !== 0;
                    const hasTIronLength = savedItem.t_iron_length_per_piece !== null && savedItem.t_iron_length_per_piece !== undefined && savedItem.t_iron_length_per_piece !== 0;

                    log(`   Has pieces: ${hasTIronPieces}`, hasTIronPieces ? 'success' : 'error');
                    log(`   Has length: ${hasTIronLength}`, hasTIronLength ? 'success' : 'error');

                    if (hasTIronPieces && hasTIronLength) {
                        // Apply enhanced type conversion from fix
                        const pieces = Number(savedItem.t_iron_pieces);
                        const lengthPerPiece = Number(savedItem.t_iron_length_per_piece);
                        const unitPrice = Number(savedItem.unit_price);

                        if (pieces > 0 && lengthPerPiece > 0) {
                            const unit = savedItem.t_iron_unit || 'pcs';
                            const displayText = `(${pieces}${unit} √ó ${lengthPerPiece}ft/${unit} √ó Rs.${unitPrice})`;

                            log('üéâ T-IRON DISPLAY RESULT:', 'fixed');
                            log(`   Generated: "T Iron ${displayText}"`, 'fixed');

                            if (pieces === 19 && lengthPerPiece === 15) {
                                log('üéâ SUCCESS! T-Iron shows CORRECT 19pcs √ó 15ft', 'fixed');
                            } else {
                                log(`‚ùå T-Iron STILL WRONG: ${pieces}pcs √ó ${lengthPerPiece}ft`, 'error');
                            }
                        } else {
                            log('‚ùå Type conversion failed', 'error');
                        }
                    } else {
                        log('üö® T-Iron data missing - would use reconstruction', 'critical');

                        // Test the enhanced reconstruction for 285 feet
                        log('ü§ñ Testing enhanced reconstruction for 285 feet:', 'warning');
                        const totalFeet = 285;
                        const commonLengths = [14, 15, 12, 10, 16, 8, 20]; // Note: 15 is now included!
                        let bestFit = { pieces: Math.round(totalFeet / 12), length: 12, difference: Math.abs(totalFeet % 12) };

                        for (const length of commonLengths) {
                            const pieces = Math.round(totalFeet / length);
                            const calculatedTotal = pieces * length;
                            const difference = Math.abs(totalFeet - calculatedTotal);

                            if (difference < bestFit.difference && pieces > 0) {
                                bestFit = { pieces, length, difference };
                            } else if (difference === bestFit.difference && difference === 0) {
                                if (pieces < bestFit.pieces && length > bestFit.length) {
                                    bestFit = { pieces, length, difference };
                                }
                            }
                        }

                        log(`   Reconstruction result: ${bestFit.pieces}√ó${bestFit.length}`, 'warning');
                        if (bestFit.pieces === 19 && bestFit.length === 15) {
                            log('‚úÖ Reconstruction now shows correct 19√ó15!', 'success');
                        } else {
                            log(`‚ö†Ô∏è Reconstruction shows ${bestFit.pieces}√ó${bestFit.length} (not ideal)`, 'warning');
                        }
                    }

                    // Test 2: DateTime Display
                    log('üïê DateTime Display Test:', 'debug');
                    log(`   Raw created_at: ${savedItem.created_at}`, 'debug');

                    if (savedItem.created_at) {
                        // Test the formatDateTime function
                        const formattedDateTime = new Date(savedItem.created_at).toLocaleString();
                        log(`   Formatted: ${formattedDateTime}`, 'debug');

                        const now = new Date();
                        const savedTime = new Date(savedItem.created_at);
                        const timeDiff = Math.abs(now.getTime() - savedTime.getTime());

                        log(`   Time difference: ${Math.round(timeDiff / 1000)} seconds`, 'debug');

                        if (timeDiff < 60000) { // Within 1 minute
                            log('‚úÖ DateTime is current and accurate!', 'success');
                        } else {
                            log(`‚ö†Ô∏è DateTime seems off by ${Math.round(timeDiff / 60000)} minutes`, 'warning');
                        }

                        // Check for the specific wrong time issue
                        const dateStr = formattedDateTime;
                        if (dateStr.includes('22/08') || dateStr.includes('20:')) {
                            log('‚ùå Still showing wrong date/time format!', 'error');
                        } else {
                            log('‚úÖ Date/time format appears correct', 'success');
                        }
                    } else {
                        log('‚ùå No created_at timestamp found', 'error');
                    }

                } else {
                    log('‚ùå Could not retrieve saved item', 'error');
                }

            } catch (error) {
                log(`‚ùå Complete test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        async function testDateTimeAccuracy() {
            log('üïê TESTING: System date/time accuracy', 'info');

            try {
                const now = new Date();
                log('üîç Current system analysis:', 'debug');
                log(`   JavaScript Date: ${now.toString()}`, 'debug');
                log(`   UTC: ${now.toISOString()}`, 'debug');
                log(`   Local: ${now.toLocaleString()}`, 'debug');
                log(`   Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`, 'debug');
                log(`   Offset: ${now.getTimezoneOffset()} minutes`, 'debug');

                // User's expected values
                log('üë§ User reported expectations:', 'debug');
                log('   System shows: 08/23/25 01:20 AM', 'debug');
                log('   App showed: 22/08/25 08:20 PM (WRONG)', 'debug');

                // Check current values vs expected
                const currentDate = now.toLocaleDateString('en-GB'); // dd/mm/yyyy format
                const currentTime = now.toLocaleTimeString('en-US', { hour12: true });

                log('üìÖ Current formatted values:', 'debug');
                log(`   Date: ${currentDate}`, 'debug');
                log(`   Time: ${currentTime}`, 'debug');

                // Check if we're close to user's expected time (allowing for some time passage)
                const expectedHour = 1; // 01:20 AM
                const currentHour = now.getHours();

                if (Math.abs(currentHour - expectedHour) < 2) {
                    log('‚úÖ System time appears to match user expectations', 'success');
                } else {
                    log(`‚ö†Ô∏è System time differs from user expectation (${currentHour} vs ${expectedHour})`, 'warning');
                }

            } catch (error) {
                log(`‚ùå DateTime test failed: ${error.message}`, 'error');
            }
        }

        function testTIronReconstructionFix() {
            log('ü§ñ TESTING: Enhanced T-Iron reconstruction (15ft fix)', 'info');

            try {
                const testCases = [
                    { feet: 285, expected: { pieces: 19, length: 15 }, desc: "User's 19√ó15=285" },
                    { feet: 210, expected: { pieces: 14, length: 15 }, desc: "Previous 14√ó15=210" },
                    { feet: 180, expected: { pieces: 15, length: 12 }, desc: "Common 15√ó12=180" },
                    { feet: 160, expected: { pieces: 10, length: 16 }, desc: "Standard 10√ó16=160" }
                ];

                for (const testCase of testCases) {
                    log(`üß™ Testing: ${testCase.desc} (${testCase.feet} feet)`, 'debug');

                    // Apply enhanced reconstruction algorithm
                    const totalFeet = testCase.feet;
                    const commonLengths = [14, 15, 12, 10, 16, 8, 20]; // Note: 15 is now included!
                    let bestFit = { pieces: Math.round(totalFeet / 12), length: 12, difference: Math.abs(totalFeet % 12) };

                    for (const length of commonLengths) {
                        const pieces = Math.round(totalFeet / length);
                        const calculatedTotal = pieces * length;
                        const difference = Math.abs(totalFeet - calculatedTotal);

                        if (difference < bestFit.difference && pieces > 0) {
                            bestFit = { pieces, length, difference };
                        } else if (difference === bestFit.difference && difference === 0) {
                            if (pieces < bestFit.pieces && length > bestFit.length) {
                                bestFit = { pieces, length, difference };
                            }
                        }
                    }

                    const isCorrect = bestFit.pieces === testCase.expected.pieces && bestFit.length === testCase.expected.length;

                    log(`   Result: ${bestFit.pieces}√ó${bestFit.length} (${isCorrect ? 'CORRECT' : 'WRONG'})`, isCorrect ? 'success' : 'warning');

                    if (!isCorrect) {
                        log(`   Expected: ${testCase.expected.pieces}√ó${testCase.expected.length}`, 'warning');
                    }
                }

            } catch (error) {
                log(`‚ùå Reconstruction test failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseSchemaIntegrity() {
            log('üîß TESTING: Database schema integrity for T-Iron', 'info');

            try {
                // Create minimal test to verify schema
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Schema Test',
                    bill_number: 'SCHEMA-' + Date.now(),
                    subtotal: 100,
                    total_amount: 100,
                    grand_total: 100
                };

                const invoiceId = await window.db.createInvoice(testInvoice);

                // Test all T-Iron fields
                const schemaTestItem = {
                    product_id: null,
                    product_name: 'Schema Test',
                    quantity: '50',
                    unit_price: 100,
                    total_price: 5000,
                    unit: 'ft',
                    t_iron_pieces: 5,
                    t_iron_length_per_piece: 10,
                    t_iron_total_feet: 50,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                const itemIds = await window.db.addInvoiceItems(invoiceId, [schemaTestItem]);
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    const fields = [
                        't_iron_pieces',
                        't_iron_length_per_piece',
                        't_iron_total_feet',
                        't_iron_unit'
                    ];

                    let allGood = true;
                    for (const field of fields) {
                        const value = savedItem[field];
                        const exists = value !== null && value !== undefined;
                        log(`   ${field}: ${value} (${exists ? 'OK' : 'MISSING'})`, exists ? 'success' : 'error');
                        if (!exists) allGood = false;
                    }

                    if (allGood) {
                        log('‚úÖ Database schema is complete and working!', 'success');
                    } else {
                        log('‚ùå Database schema has missing T-Iron fields!', 'error');
                    }
                } else {
                    log('‚ùå Could not retrieve schema test item', 'error');
                }

            } catch (error) {
                log(`‚ùå Schema test failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üéØ Final T-Iron & DateTime Fix Test Ready', 'info');
        log('üìã Click "Test Complete User Scenario" for full verification', 'info');
    </script>
</body>

</html>