<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Ledger Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
        }

        .error {
            background: #f8d7da;
        }

        .warning {
            background: #fff3cd;
        }

        .info {
            background: #d1ecf1;
        }

        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f2f2f2;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: black;
        }

        input,
        select {
            padding: 5px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>Daily Ledger Debug Tool</h1>

    <div class="section">
        <h3>Step 1: Check Database Tables</h3>
        <button class="btn-primary" onclick="checkTables()">Check Available Tables</button>
        <div id="tables-result"></div>
    </div>

    <div class="section">
        <h3>Step 2: Search for Cash Refund Entries</h3>
        <button class="btn-primary" onclick="searchCashRefunds()">Find All Cash Refund Entries</button>
        <div id="refunds-result"></div>
    </div>

    <div class="section">
        <h3>Step 3: Test Daily Ledger Query</h3>
        <label>Date: <input type="date" id="test-date" value="2024-12-27"></label>
        <label>Customer ID: <input type="number" id="customer-id" placeholder="Leave empty for all"></label>
        <button class="btn-primary" onclick="testDailyLedgerQuery()">Test Query</button>
        <div id="query-result"></div>
    </div>

    <div class="section">
        <h3>Step 4: Check Specific Entry</h3>
        <label>Entry ID: <input type="number" id="entry-id" value="58" placeholder="Enter entry ID"></label>
        <button class="btn-primary" onclick="checkSpecificEntry()">Check Entry</button>
        <div id="entry-result"></div>
    </div>

    <div class="section">
        <h3>Step 5: Test Filtering Logic</h3>
        <button class="btn-warning" onclick="testFiltering()">Test All Filtering Scenarios</button>
        <div id="filtering-result"></div>
    </div>

    <script>
        const { invoke } = window.__TAURI__.tauri;

        async function checkTables() {
            try {
                const result = document.getElementById('tables-result');
                result.innerHTML = 'Checking tables...';

                const tables = await invoke('execute_sql', {
                    query: "SELECT name FROM sqlite_master WHERE type='table' ORDER BY name",
                    params: []
                });

                result.innerHTML = `<div class="success">
                    <h4>Available Tables (${tables.length}):</h4>
                    <ul>${tables.map(t => `<li>${t.name}</li>`).join('')}</ul>
                </div>`;
            } catch (error) {
                document.getElementById('tables-result').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function searchCashRefunds() {
            try {
                const result = document.getElementById('refunds-result');
                result.innerHTML = 'Searching for cash refunds...';

                // Try different possible table names and queries
                const queries = [
                    "SELECT * FROM ledger_entries WHERE description LIKE '%refund%' OR description LIKE '%Cash refund%'",
                    "SELECT * FROM daily_ledger_entries WHERE description LIKE '%refund%'",
                    "SELECT * FROM transactions WHERE description LIKE '%refund%'",
                    "SELECT * FROM ledger_entries WHERE reference_type = 'other'",
                    "SELECT * FROM ledger_entries WHERE id = 58"
                ];

                let foundEntries = [];
                let workingTable = null;

                for (let query of queries) {
                    try {
                        const entries = await invoke('execute_sql', { query, params: [] });
                        if (entries && entries.length > 0) {
                            foundEntries = entries;
                            workingTable = query.split(' ')[3]; // Extract table name
                            break;
                        }
                    } catch (e) {
                        console.log(`Query failed: ${query} - ${e.message}`);
                    }
                }

                if (foundEntries.length > 0) {
                    result.innerHTML = `<div class="success">
                        <h4>Found ${foundEntries.length} cash refund entries in ${workingTable}:</h4>
                        <table>
                            <tr><th>ID</th><th>Date</th><th>Description</th><th>Amount</th><th>Customer ID</th><th>Reference Type</th></tr>
                            ${foundEntries.map(e => `<tr>
                                <td>${e.id}</td>
                                <td>${e.date}</td>
                                <td>${e.description}</td>
                                <td>${e.credit_amount || e.debit_amount || e.amount}</td>
                                <td>${e.customer_id || 'N/A'}</td>
                                <td>${e.reference_type || 'N/A'}</td>
                            </tr>`).join('')}
                        </table>
                    </div>`;
                } else {
                    result.innerHTML = `<div class="warning">No cash refund entries found in any table</div>`;
                }
            } catch (error) {
                document.getElementById('refunds-result').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testDailyLedgerQuery() {
            try {
                const result = document.getElementById('query-result');
                result.innerHTML = 'Testing daily ledger query...';

                const date = document.getElementById('test-date').value;
                const customerId = document.getElementById('customer-id').value || null;

                const entries = await invoke('get_daily_ledger_entries', {
                    startDate: date,
                    endDate: date,
                    customerId: customerId ? parseInt(customerId) : null,
                    paymentChannelIds: []
                });

                result.innerHTML = `<div class="info">
                    <h4>Daily Ledger Entries for ${date} (Customer: ${customerId || 'All'}):</h4>
                    <p>Found ${entries.length} entries</p>
                    <table>
                        <tr><th>ID</th><th>Time</th><th>Description</th><th>Type</th><th>Amount</th><th>Customer ID</th></tr>
                        ${entries.map(e => `<tr>
                            <td>${e.id}</td>
                            <td>${e.time}</td>
                            <td>${e.description}</td>
                            <td>${e.type}</td>
                            <td>${e.amount}</td>
                            <td>${e.customer_id || 'N/A'}</td>
                        </tr>`).join('')}
                    </table>
                </div>`;
            } catch (error) {
                document.getElementById('query-result').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function checkSpecificEntry() {
            try {
                const result = document.getElementById('entry-result');
                result.innerHTML = 'Checking specific entry...';

                const entryId = document.getElementById('entry-id').value;

                // Try different table names
                const tableQueries = [
                    `SELECT * FROM ledger_entries WHERE id = ${entryId}`,
                    `SELECT * FROM daily_ledger_entries WHERE id = ${entryId}`,
                    `SELECT * FROM transactions WHERE id = ${entryId}`
                ];

                let foundEntry = null;
                let workingTable = null;

                for (let query of tableQueries) {
                    try {
                        const entries = await invoke('execute_sql', { query, params: [] });
                        if (entries && entries.length > 0) {
                            foundEntry = entries[0];
                            workingTable = query.split(' ')[3];
                            break;
                        }
                    } catch (e) {
                        console.log(`Query failed: ${query}`);
                    }
                }

                if (foundEntry) {
                    result.innerHTML = `<div class="success">
                        <h4>Entry ${entryId} found in ${workingTable}:</h4>
                        <pre>${JSON.stringify(foundEntry, null, 2)}</pre>
                    </div>`;
                } else {
                    result.innerHTML = `<div class="error">Entry ${entryId} not found in any table</div>`;
                }
            } catch (error) {
                document.getElementById('entry-result').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testFiltering() {
            try {
                const result = document.getElementById('filtering-result');
                result.innerHTML = 'Testing filtering scenarios...';

                const testDate = '2024-12-27';

                const scenarios = [
                    { name: 'No filters', customerId: null, paymentChannels: [] },
                    { name: 'Customer ID 7', customerId: 7, paymentChannels: [] },
                    { name: 'Customer ID 0', customerId: 0, paymentChannels: [] },
                    { name: 'All payment channels', customerId: null, paymentChannels: [1, 2, 3] }
                ];

                let html = '<div class="info"><h4>Filtering Test Results:</h4>';

                for (let scenario of scenarios) {
                    try {
                        const entries = await invoke('get_daily_ledger_entries', {
                            startDate: testDate,
                            endDate: testDate,
                            customerId: scenario.customerId,
                            paymentChannelIds: scenario.paymentChannels
                        });

                        const refundEntries = entries.filter(e =>
                            e.description?.includes('refund') ||
                            e.description?.includes('Cash refund') ||
                            e.reference_type === 'other'
                        );

                        html += `<p><strong>${scenario.name}:</strong> ${entries.length} total entries, ${refundEntries.length} refund entries</p>`;
                    } catch (e) {
                        html += `<p><strong>${scenario.name}:</strong> Error - ${e.message}</p>`;
                    }
                }

                html += '</div>';
                result.innerHTML = html;
            } catch (error) {
                document.getElementById('filtering-result').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Auto-run initial checks
        window.addEventListener('DOMContentLoaded', () => {
            checkTables();
        });
    </script>
</body>

</html>