<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Ledger Testing Verification</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #1f2937;
            text-align: center;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
        }

        .test-section h3 {
            color: #374151;
            margin-top: 0;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: 500;
        }

        .success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #dbeafe;
        }

        .warning {
            background: #fefce8;
            color: #ca8a04;
            border: 1px solid #fef3c7;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }

        button:hover {
            background: #2563eb;
        }

        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
        }

        .checklist {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .checklist h4 {
            color: #0369a1;
            margin-top: 0;
        }

        .checklist ul {
            margin: 0;
            padding-left: 20px;
        }

        .checklist li {
            margin: 8px 0;
            color: #0f172a;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Daily Ledger Testing Verification</h1>

        <div class="checklist">
            <h4>‚úÖ Pre-Testing Checklist</h4>
            <ul>
                <li>Database service is initialized</li>
                <li>DailyLedger component uses database-only storage</li>
                <li>No localStorage dependencies for manual entries</li>
                <li>Manual entries use <code>ledger_entries</code> table with <code>is_manual = 1</code></li>
                <li>Edit/Delete operations work directly with database</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîå 1. Database Connection Test</h3>
            <p>Verify that the database connection is working properly</p>
            <button onclick="testDatabaseConnection()">Test Database Connection</button>
            <div id="dbConnectionResult"></div>
        </div>

        <div class="test-section">
            <h3>üìã 2. Ledger Entries Table Test</h3>
            <p>Check if ledger_entries table exists and can handle manual entries</p>
            <button onclick="testLedgerTable()">Test Ledger Table</button>
            <div id="ledgerTableResult"></div>
        </div>

        <div class="test-section">
            <h3>‚úèÔ∏è 3. Manual Entry Creation Test</h3>
            <p>Test creating a manual entry directly in database</p>
            <button onclick="testManualEntryCreation()">Create Test Manual Entry</button>
            <div id="manualEntryResult"></div>
        </div>

        <div class="test-section">
            <h3>üìñ 4. Entry Retrieval Test</h3>
            <p>Test loading entries for today's date</p>
            <button onclick="testEntryRetrieval()">Load Today's Entries</button>
            <div id="entryRetrievalResult"></div>
        </div>

        <div class="test-section">
            <h3>üîÑ 5. Database Reset Test</h3>
            <p>Test that the system works after database reset (WARNING: This will reset your database!)</p>
            <button onclick="testDatabaseReset()">Reset Database (TESTING ONLY)</button>
            <div id="resetTestResult"></div>
        </div>

        <div class="test-section">
            <h3>üßπ 6. localStorage Independence Test</h3>
            <p>Verify that manual entries work without localStorage</p>
            <button onclick="testLocalStorageIndependence()">Test localStorage Independence</button>
            <div id="localStorageResult"></div>
        </div>

        <div class="status info">
            <strong>üîß For Developers:</strong><br>
            Open browser console to see detailed test logs and results.
        </div>
    </div>

    <script>
        // Testing utilities for Daily Ledger bulletproof implementation

        async function testDatabaseConnection() {
            const result = document.getElementById('dbConnectionResult');
            result.innerHTML = '<div class="status info">üîÑ Testing database connection...</div>';

            try {
                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available. Please load the application first.');
                }

                // Test basic database operation
                const testResult = await window.db.executeRawQuery('SELECT 1 as test');

                if (testResult && testResult.length > 0) {
                    result.innerHTML = '<div class="status success">‚úÖ Database connection successful!</div>';
                    console.log('‚úÖ Database connection test passed');
                } else {
                    throw new Error('Database query returned no results');
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Database connection failed: ${error.message}</div>`;
                console.error('‚ùå Database connection test failed:', error);
            }
        }

        async function testLedgerTable() {
            const result = document.getElementById('ledgerTableResult');
            result.innerHTML = '<div class="status info">üîÑ Testing ledger_entries table...</div>';

            try {
                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available');
                }

                // Check table structure
                const tableInfo = await window.db.executeRawQuery('PRAGMA table_info(ledger_entries)');

                // Check for required columns
                const hasIsManual = tableInfo.some(col => col.name === 'is_manual');
                const hasAmount = tableInfo.some(col => col.name === 'amount');
                const hasDescription = tableInfo.some(col => col.name === 'description');

                if (hasIsManual && hasAmount && hasDescription) {
                    result.innerHTML = `
                        <div class="status success">‚úÖ ledger_entries table structure verified!</div>
                        <pre>Columns found: ${tableInfo.map(col => col.name).join(', ')}</pre>
                    `;
                    console.log('‚úÖ Ledger table test passed', tableInfo);
                } else {
                    throw new Error('Missing required columns in ledger_entries table');
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Ledger table test failed: ${error.message}</div>`;
                console.error('‚ùå Ledger table test failed:', error);
            }
        }

        async function testManualEntryCreation() {
            const result = document.getElementById('manualEntryResult');
            result.innerHTML = '<div class="status info">üîÑ Creating test manual entry...</div>';

            try {
                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available');
                }

                const testEntry = {
                    date: new Date().toISOString().split('T')[0],
                    type: 'incoming',
                    category: 'Test Entry',
                    description: 'BULLETPROOF TEST - Manual Entry',
                    amount: 100,
                    customer_id: null,
                    customer_name: null,
                    payment_method: 'Cash',
                    payment_channel_id: null,
                    payment_channel_name: 'Cash',
                    notes: 'Test entry for bulletproof verification',
                    is_manual: true
                };

                const entryId = await window.db.addDailyLedgerEntry(testEntry);

                if (entryId) {
                    result.innerHTML = `
                        <div class="status success">‚úÖ Manual entry created successfully!</div>
                        <pre>Entry ID: ${entryId}</pre>
                    `;
                    console.log('‚úÖ Manual entry creation test passed', entryId);
                } else {
                    throw new Error('Failed to create manual entry');
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Manual entry creation failed: ${error.message}</div>`;
                console.error('‚ùå Manual entry creation test failed:', error);
            }
        }

        async function testEntryRetrieval() {
            const result = document.getElementById('entryRetrievalResult');
            result.innerHTML = '<div class="status info">üîÑ Loading today\'s entries...</div>';

            try {
                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available');
                }

                const today = new Date().toISOString().split('T')[0];
                const entries = await window.db.getDailyLedgerEntries(today, { customer_id: null });

                const manualEntries = entries.entries?.filter(e => e.is_manual) || [];
                const systemEntries = entries.entries?.filter(e => !e.is_manual) || [];

                result.innerHTML = `
                    <div class="status success">‚úÖ Entries loaded successfully!</div>
                    <pre>Total entries: ${entries.entries?.length || 0}
Manual entries: ${manualEntries.length}
System entries: ${systemEntries.length}</pre>
                `;
                console.log('‚úÖ Entry retrieval test passed', entries);
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Entry retrieval failed: ${error.message}</div>`;
                console.error('‚ùå Entry retrieval test failed:', error);
            }
        }

        async function testDatabaseReset() {
            const result = document.getElementById('resetTestResult');

            if (!confirm('‚ö†Ô∏è This will reset your database! Are you sure? (Only for testing)')) {
                result.innerHTML = '<div class="status warning">‚ö†Ô∏è Database reset cancelled by user</div>';
                return;
            }

            result.innerHTML = '<div class="status info">üîÑ Resetting database...</div>';

            try {
                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available');
                }

                // Reset database
                const resetResult = await window.db.resetDatabase();

                if (resetResult.success) {
                    result.innerHTML = `
                        <div class="status success">‚úÖ Database reset successful!</div>
                        <pre>${resetResult.message}</pre>
                        <div class="status info">üîÑ Now test creating a manual entry to verify functionality...</div>
                    `;
                    console.log('‚úÖ Database reset test passed', resetResult);
                } else {
                    throw new Error(resetResult.message || 'Database reset failed');
                }
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå Database reset failed: ${error.message}</div>`;
                console.error('‚ùå Database reset test failed:', error);
            }
        }

        async function testLocalStorageIndependence() {
            const result = document.getElementById('localStorageResult');
            result.innerHTML = '<div class="status info">üîÑ Testing localStorage independence...</div>';

            try {
                // Clear any existing localStorage data
                const keysToRemove = Object.keys(localStorage).filter(key =>
                    key.startsWith('daily_ledger_') || key.startsWith('closing_balance_')
                );

                keysToRemove.forEach(key => localStorage.removeItem(key));

                // Test that the system works without localStorage
                const today = new Date().toISOString().split('T')[0];

                if (typeof window.db === 'undefined') {
                    throw new Error('Database service not available');
                }

                const entries = await window.db.getDailyLedgerEntries(today, { customer_id: null });

                result.innerHTML = `
                    <div class="status success">‚úÖ localStorage independence verified!</div>
                    <pre>Cleared localStorage keys: ${keysToRemove.length}
Loaded entries without localStorage: ${entries.entries?.length || 0}
System works independently: ‚úÖ YES</pre>
                `;
                console.log('‚úÖ localStorage independence test passed');
            } catch (error) {
                result.innerHTML = `<div class="status error">‚ùå localStorage independence test failed: ${error.message}</div>`;
                console.error('‚ùå localStorage independence test failed:', error);
            }
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            console.log('üß™ Daily Ledger Testing Verification loaded');
            console.log('üí° Run individual tests by clicking the buttons above');
        });
    </script>
</body>

</html>