<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Return Button Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .test-title {
            font-weight: bold;
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        .result {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }

        .pass {
            color: #28a745;
        }

        .fail {
            color: #dc3545;
        }

        .info {
            color: #007bff;
        }

        .debug-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .invoice-simulation {
            border: 2px solid #007bff;
            background: #e7f3ff;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîß Return Button Debug Test</h1>
        <p>This test simulates the return eligibility logic to understand why return buttons might be disabled for
            unpaid invoices.</p>

        <div class="test-section invoice-simulation">
            <div class="test-title">üìã Invoice Return Eligibility Simulation</div>
            <div id="eligibility-results"></div>
            <button onclick="runEligibilityTest()">üîç Test Return Eligibility</button>
        </div>

        <div class="test-section">
            <div class="test-title">üßÆ Payment Status Logic Test</div>
            <div id="payment-status-results"></div>
            <button onclick="runPaymentStatusTest()">üìä Test Payment Status Logic</button>
        </div>

        <div class="test-section">
            <div class="test-title">üì¶ Returnable Quantity Logic Test</div>
            <div id="quantity-results"></div>
            <button onclick="runQuantityTest()">üìà Test Quantity Logic</button>
        </div>

        <div class="test-section">
            <div class="test-title">üîò Button State Simulation</div>
            <div id="button-state-results"></div>
            <button onclick="runButtonStateTest()">üéØ Test Button State</button>
        </div>
    </div>

    <script>
        // Simulate the payment status logic from checkReturnEligibility
        function checkPaymentStatus(invoice) {
            const remainingBalance = Math.round((invoice.remaining_balance + Number.EPSILON) * 100) / 100;
            const totalAmount = Math.round((invoice.total_amount + Number.EPSILON) * 100) / 100;

            const isFullyPaid = remainingBalance <= 0.01;
            const isUnpaid = Math.abs(remainingBalance - totalAmount) <= 0.01;
            const isPartiallyPaid = remainingBalance > 0.01 && remainingBalance < (totalAmount - 0.01);

            return {
                remainingBalance,
                totalAmount,
                isFullyPaid,
                isUnpaid,
                isPartiallyPaid,
                canReturn: isFullyPaid || isUnpaid
            };
        }

        // Simulate returnable quantity logic
        function simulateReturnableQuantity(item) {
            // Simulate what getReturnableQuantity would return
            const originalQuantity = parseFloat(item.quantity) || 0;
            const totalReturned = 0; // Assume no returns yet
            const returnableQuantity = Math.max(0, originalQuantity - totalReturned);

            return {
                originalQuantity,
                totalReturned,
                returnableQuantity
            };
        }

        // Test invoice scenarios
        const testInvoices = [
            {
                id: 1,
                description: "Unpaid Invoice",
                total_amount: 1000,
                remaining_balance: 1000,
                paid_amount: 0,
                items: [
                    { id: 1, product_id: 101, product_name: "Test Product 1", quantity: "5", is_misc_item: false },
                    { id: 2, product_id: 102, product_name: "Test Product 2", quantity: "2.5", is_misc_item: false }
                ]
            },
            {
                id: 2,
                description: "Fully Paid Invoice",
                total_amount: 1000,
                remaining_balance: 0,
                paid_amount: 1000,
                items: [
                    { id: 3, product_id: 103, product_name: "Test Product 3", quantity: "10", is_misc_item: false }
                ]
            },
            {
                id: 3,
                description: "Partially Paid Invoice",
                total_amount: 1000,
                remaining_balance: 500,
                paid_amount: 500,
                items: [
                    { id: 4, product_id: 104, product_name: "Test Product 4", quantity: "3", is_misc_item: false }
                ]
            },
            {
                id: 4,
                description: "Invoice with kg-grams format",
                total_amount: 500,
                remaining_balance: 500,
                paid_amount: 0,
                items: [
                    { id: 5, product_id: 105, product_name: "Test Product 5", quantity: "12-980", is_misc_item: false }
                ]
            },
            {
                id: 5,
                description: "Invoice with misc item",
                total_amount: 300,
                remaining_balance: 300,
                paid_amount: 0,
                items: [
                    { id: 6, product_id: null, product_name: "Misc Item", quantity: "1", is_misc_item: true },
                    { id: 7, product_id: 106, product_name: "Regular Item", quantity: "2", is_misc_item: false }
                ]
            }
        ];

        function runEligibilityTest() {
            const resultsDiv = document.getElementById('eligibility-results');
            let html = '<div class="debug-section">';

            testInvoices.forEach(invoice => {
                const paymentStatus = checkPaymentStatus(invoice);

                html += `<div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                html += `<h4>${invoice.description} (ID: ${invoice.id})</h4>`;
                html += `<div class="result info">Total: $${invoice.total_amount}, Remaining: $${invoice.remaining_balance}, Paid: $${invoice.paid_amount}</div>`;
                html += `<div class="result">Payment Status:</div>`;
                html += `<div class="result">- Rounded Remaining: $${paymentStatus.remainingBalance}</div>`;
                html += `<div class="result">- Rounded Total: $${paymentStatus.totalAmount}</div>`;
                html += `<div class="result ${paymentStatus.isFullyPaid ? 'pass' : ''}">- Is Fully Paid: ${paymentStatus.isFullyPaid}</div>`;
                html += `<div class="result ${paymentStatus.isUnpaid ? 'pass' : ''}">- Is Unpaid: ${paymentStatus.isUnpaid}</div>`;
                html += `<div class="result ${paymentStatus.isPartiallyPaid ? 'fail' : 'pass'}">- Is Partially Paid: ${paymentStatus.isPartiallyPaid}</div>`;
                html += `<div class="result ${paymentStatus.canReturn ? 'pass' : 'fail'}"><strong>Can Return: ${paymentStatus.canReturn}</strong></div>`;

                // Check individual items
                html += `<div class="result">Items:</div>`;
                invoice.items.forEach(item => {
                    const quantityInfo = simulateReturnableQuantity(item);
                    const buttonEnabled = !item.is_misc_item && item.product_id && paymentStatus.canReturn && quantityInfo.returnableQuantity > 0;

                    html += `<div class="result">  - ${item.product_name}: Qty ${item.quantity}, Returnable: ${quantityInfo.returnableQuantity}, Button: <span class="${buttonEnabled ? 'pass' : 'fail'}">${buttonEnabled ? 'ENABLED' : 'DISABLED'}</span></div>`;
                });

                html += `</div>`;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function runPaymentStatusTest() {
            const resultsDiv = document.getElementById('payment-status-results');

            // Test edge cases for floating point precision
            const edgeCases = [
                { total: 100.00, remaining: 100.00, description: "Exactly unpaid" },
                { total: 100.00, remaining: 0.00, description: "Exactly paid" },
                { total: 100.00, remaining: 0.005, description: "Very small remaining (should be paid)" },
                { total: 100.00, remaining: 99.995, description: "Very close to total (should be unpaid)" },
                { total: 100.00, remaining: 50.00, description: "Exactly half paid" },
                { total: 100.33, remaining: 100.33, description: "Decimal total, unpaid" },
                { total: 100.99, remaining: 0.01, description: "Boundary case - 0.01 remaining" },
                { total: 100.00, remaining: 99.99, description: "Boundary case - 0.01 paid" }
            ];

            let html = '<div class="debug-section">';

            edgeCases.forEach((testCase, index) => {
                const mockInvoice = {
                    total_amount: testCase.total,
                    remaining_balance: testCase.remaining,
                    paid_amount: testCase.total - testCase.remaining
                };

                const status = checkPaymentStatus(mockInvoice);

                html += `<div class="result">Test ${index + 1}: ${testCase.description}</div>`;
                html += `<div class="result">  Total: $${testCase.total}, Remaining: $${testCase.remaining}</div>`;
                html += `<div class="result">  Status: Paid=${status.isFullyPaid}, Unpaid=${status.isUnpaid}, Partial=${status.isPartiallyPaid}</div>`;
                html += `<div class="result ${status.canReturn ? 'pass' : 'fail'}">  Can Return: ${status.canReturn}</div>`;
                html += `<br>`;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function runQuantityTest() {
            const resultsDiv = document.getElementById('quantity-results');

            const quantityTestCases = [
                { quantity: "5", description: "Simple integer" },
                { quantity: "2.5", description: "Decimal" },
                { quantity: "12-980", description: "kg-grams format" },
                { quantity: "0", description: "Zero quantity" },
                { quantity: "", description: "Empty string" },
                { quantity: "abc", description: "Invalid string" }
            ];

            let html = '<div class="debug-section">';

            quantityTestCases.forEach((testCase, index) => {
                const mockItem = { quantity: testCase.quantity };
                const result = simulateReturnableQuantity(mockItem);
                const hasReturnableQty = result.returnableQuantity > 0;

                html += `<div class="result">Test ${index + 1}: ${testCase.description}</div>`;
                html += `<div class="result">  Input: "${testCase.quantity}"</div>`;
                html += `<div class="result">  Parsed: ${result.originalQuantity}</div>`;
                html += `<div class="result ${hasReturnableQty ? 'pass' : 'fail'}">  Returnable: ${result.returnableQuantity} (${hasReturnableQty ? 'Valid' : 'Invalid'})</div>`;
                html += `<br>`;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function runButtonStateTest() {
            const resultsDiv = document.getElementById('button-state-results');

            let html = '<div class="debug-section">';
            html += '<h4>Button State Logic Summary</h4>';
            html += '<div class="result info">A return button is ENABLED when ALL conditions are met:</div>';
            html += '<div class="result">1. !item.is_misc_item (item is not a misc item)</div>';
            html += '<div class="result">2. item.product_id (item has a valid product ID)</div>';
            html += '<div class="result">3. returnEligibility.canReturn (invoice allows returns)</div>';
            html += '<div class="result">4. returnableQuantity > 0 (there is quantity to return)</div>';
            html += '<br>';

            html += '<h4>Real-world Scenario Simulation</h4>';

            // Test the actual conditions that might cause issues
            const realWorldTests = [
                {
                    scenario: "Unpaid invoice with regular item",
                    invoice: { total_amount: 1000, remaining_balance: 1000 },
                    item: { is_misc_item: false, product_id: 123, quantity: "5" },
                    expected: "ENABLED"
                },
                {
                    scenario: "Unpaid invoice with misc item",
                    invoice: { total_amount: 1000, remaining_balance: 1000 },
                    item: { is_misc_item: true, product_id: null, quantity: "1" },
                    expected: "DISABLED (misc item)"
                },
                {
                    scenario: "Unpaid invoice with zero quantity",
                    invoice: { total_amount: 1000, remaining_balance: 1000 },
                    item: { is_misc_item: false, product_id: 123, quantity: "0" },
                    expected: "DISABLED (no returnable quantity)"
                },
                {
                    scenario: "Partially paid invoice",
                    invoice: { total_amount: 1000, remaining_balance: 500 },
                    item: { is_misc_item: false, product_id: 123, quantity: "5" },
                    expected: "DISABLED (partially paid)"
                },
                {
                    scenario: "Item without product_id",
                    invoice: { total_amount: 1000, remaining_balance: 1000 },
                    item: { is_misc_item: false, product_id: null, quantity: "5" },
                    expected: "DISABLED (no product_id)"
                }
            ];

            realWorldTests.forEach((test, index) => {
                const paymentStatus = checkPaymentStatus(test.invoice);
                const quantityInfo = simulateReturnableQuantity(test.item);

                const condition1 = !test.item.is_misc_item;
                const condition2 = test.item.product_id;
                const condition3 = paymentStatus.canReturn;
                const condition4 = quantityInfo.returnableQuantity > 0;

                const finalResult = condition1 && condition2 && condition3 && condition4;

                html += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                html += `<div class="result info">Scenario ${index + 1}: ${test.scenario}</div>`;
                html += `<div class="result">Expected: ${test.expected}</div>`;
                html += `<div class="result">Conditions:</div>`;
                html += `<div class="result ${condition1 ? 'pass' : 'fail'}">  ‚úì Not misc item: ${condition1}</div>`;
                html += `<div class="result ${condition2 ? 'pass' : 'fail'}">  ‚úì Has product_id: ${condition2}</div>`;
                html += `<div class="result ${condition3 ? 'pass' : 'fail'}">  ‚úì Can return (payment status): ${condition3}</div>`;
                html += `<div class="result ${condition4 ? 'pass' : 'fail'}">  ‚úì Returnable quantity > 0: ${condition4}</div>`;
                html += `<div class="result ${finalResult ? 'pass' : 'fail'}"><strong>Final Result: Button ${finalResult ? 'ENABLED' : 'DISABLED'}</strong></div>`;
                html += `</div>`;
            });

            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        // Auto-run tests on page load
        window.onload = function () {
            console.log('üîß Return Button Debug Test loaded');
            console.log('Click the buttons to run individual tests or wait for auto-run...');

            setTimeout(() => {
                runEligibilityTest();
                runPaymentStatusTest();
                runQuantityTest();
                runButtonStateTest();
            }, 1000);
        };
    </script>
</body>

</html>