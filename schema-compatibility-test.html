<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schema Compatibility Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-3xl font-bold mb-6 text-green-600">🧪 Schema Compatibility Test</h1>
        <p class="text-gray-700 mb-6">
            This tool verifies that your database schema is compatible with the staff and salary management system.
        </p>

        <div class="space-y-4">
            <button onclick="testSchemaCompatibility()"
                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                🔍 Test Schema Compatibility
            </button>

            <button onclick="insertTestSalaryPayment()"
                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                💰 Test Salary Payment Insert
            </button>

            <button onclick="queryTestData()"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                📊 Query Test Data
            </button>
        </div>

        <div id="output"
            class="mt-6 p-4 bg-gray-900 text-green-400 rounded-lg font-mono text-sm whitespace-pre-wrap hidden"></div>
    </div>

    <script type="module">
        import Database from '/node_modules/@tauri-apps/plugin-sql/dist/index.js';

        function log(message) {
            const output = document.getElementById('output');
            output.classList.remove('hidden');
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        window.testSchemaCompatibility = async function () {
            try {
                const db = await Database.load('sqlite:database.db');
                log('🔧 Testing schema compatibility...\n');

                // Test 1: Check if staff_management table exists and has correct structure
                log('1️⃣ Testing staff_management table...');
                const staffTable = await db.select('PRAGMA table_info(staff_management)');
                if (staffTable.length > 0) {
                    log('✅ staff_management table exists');
                    log(`   Found ${staffTable.length} columns`);

                    // Check for required fields
                    const requiredFields = ['id', 'full_name', 'employee_id', 'salary', 'is_active'];
                    const existingFields = staffTable.map(col => col.name);

                    for (const field of requiredFields) {
                        if (existingFields.includes(field)) {
                            log(`   ✅ ${field} column exists`);
                        } else {
                            log(`   ❌ ${field} column missing`);
                        }
                    }
                } else {
                    log('❌ staff_management table does not exist');
                }

                // Test 2: Check salary_payments table
                log('\n2️⃣ Testing salary_payments table...');
                const salaryTable = await db.select('PRAGMA table_info(salary_payments)');
                if (salaryTable.length > 0) {
                    log('✅ salary_payments table exists');
                    log(`   Found ${salaryTable.length} columns`);

                    // Check for required fields
                    const requiredFields = ['id', 'staff_id', 'staff_name', 'payment_amount', 'payment_date'];
                    const existingFields = salaryTable.map(col => col.name);

                    for (const field of requiredFields) {
                        if (existingFields.includes(field)) {
                            log(`   ✅ ${field} column exists`);
                        } else {
                            log(`   ❌ ${field} column missing`);
                        }
                    }

                    // Check for constraints
                    const schema = await db.select('SELECT sql FROM sqlite_master WHERE type="table" AND name="salary_payments"');
                    if (schema.length > 0) {
                        const sql = schema[0].sql;
                        if (sql.includes('CHECK')) {
                            log('   ⚠️ Table still has CHECK constraints - may cause errors');
                        } else {
                            log('   ✅ No CHECK constraints found - flexible schema');
                        }
                    }
                } else {
                    log('❌ salary_payments table does not exist');
                }

                // Test 3: Check payment_channels table
                log('\n3️⃣ Testing payment_channels table...');
                const channelsTable = await db.select('PRAGMA table_info(payment_channels)');
                if (channelsTable.length > 0) {
                    log('✅ payment_channels table exists');

                    const channelsData = await db.select('SELECT COUNT(*) as count FROM payment_channels WHERE is_active = 1');
                    log(`   Found ${channelsData[0].count} active payment channels`);
                } else {
                    log('❌ payment_channels table does not exist');
                }

                log('\n🎉 Schema compatibility test complete!');

            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        };

        window.insertTestSalaryPayment = async function () {
            try {
                const db = await Database.load('sqlite:database.db');
                log('💰 Testing salary payment insertion...\n');

                // First check if we have any staff
                const staffCount = await db.select('SELECT COUNT(*) as count FROM staff_management');
                if (staffCount[0].count === 0) {
                    log('⚠️ No staff found, creating test staff member...');
                    await db.execute(`
                        INSERT INTO staff_management (
                            staff_code, employee_id, full_name, name, salary, hire_date, is_active
                        ) VALUES (?, ?, ?, ?, ?, ?, ?)
                    `, ['TEST001', 'EMP-TEST-001', 'Test Employee', 'Test Employee', 50000, '2025-01-01', 1]);
                    log('✅ Test staff member created');
                }

                // Get a staff member
                const staff = await db.select('SELECT * FROM staff_management LIMIT 1');
                const staffMember = staff[0];

                log(`Testing salary payment for: ${staffMember.full_name}`);

                // Insert test salary payment
                await db.execute(`
                    INSERT INTO salary_payments (
                        staff_id, staff_name, employee_id, payment_amount, 
                        payment_date, payment_method, payment_type, 
                        basic_salary, allowances, bonuses, tax_deduction, other_deductions,
                        payment_month, payment_year, status, notes, created_by
                    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                `, [
                    staffMember.id,
                    staffMember.full_name,
                    staffMember.employee_id,
                    45000,
                    '2025-08-20',
                    'bank_transfer',
                    'full',
                    50000,
                    0,
                    0,
                    5000,
                    0,
                    '2025-08',
                    2025,
                    'completed',
                    'Test payment via compatibility checker',
                    'system'
                ]);

                log('✅ Test salary payment inserted successfully!');

                // Verify the insertion
                const paymentCount = await db.select('SELECT COUNT(*) as count FROM salary_payments WHERE staff_id = ?', [staffMember.id]);
                log(`📊 Staff member now has ${paymentCount[0].count} salary payment(s)`);

            } catch (error) {
                log('❌ Error: ' + error.message);
                log('This indicates a schema compatibility issue that needs to be fixed.');
            }
        };

        window.queryTestData = async function () {
            try {
                const db = await Database.load('sqlite:database.db');
                log('📊 Querying test data...\n');

                // Query staff data
                const staff = await db.select('SELECT id, full_name, employee_id, salary, is_active FROM staff_management LIMIT 5');
                log(`👥 Found ${staff.length} staff members:`);
                staff.forEach(s => {
                    log(`   ${s.full_name} (${s.employee_id}) - PKR ${s.salary} - ${s.is_active ? 'Active' : 'Inactive'}`);
                });

                // Query salary payments
                const payments = await db.select(`
                    SELECT sp.*, sm.full_name as staff_name_verify
                    FROM salary_payments sp
                    LEFT JOIN staff_management sm ON sp.staff_id = sm.id
                    ORDER BY sp.payment_date DESC
                    LIMIT 5
                `);
                log(`\n💰 Found ${payments.length} salary payments:`);
                payments.forEach(p => {
                    const date = new Date(p.payment_date).toLocaleDateString();
                    log(`   ${p.staff_name} - PKR ${p.payment_amount} - ${date} - ${p.payment_method}`);
                });

                // Check for any orphaned records
                const orphaned = await db.select(`
                    SELECT sp.id, sp.staff_name, sp.staff_id
                    FROM salary_payments sp
                    LEFT JOIN staff_management sm ON sp.staff_id = sm.id
                    WHERE sm.id IS NULL
                `);

                if (orphaned.length > 0) {
                    log(`\n⚠️ Found ${orphaned.length} orphaned salary payments (staff deleted)`);
                } else {
                    log('\n✅ All salary payments have valid staff references');
                }

                log('\n🎉 Data query complete!');

            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        };
    </script>
</body>

</html>