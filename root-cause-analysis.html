<!DOCTYPE html>
<html>

<head>
    <title>üîç Root Cause Analysis - Balance Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .alert-danger {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 11px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background: #f8f9fa;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        .debit {
            color: #dc3545;
            font-weight: bold;
        }

        .credit {
            color: #28a745;
            font-weight: bold;
        }

        .adjustment {
            color: #6c757d;
            font-style: italic;
        }

        .mismatch {
            background: #ffebee;
        }

        .match {
            background: #e8f5e8;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        .calculation-box {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }

        .debug {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .entry-issues {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Root Cause Analysis - Balance Calculation Issue</h1>

        <div class="alert alert-danger">
            <h3>üö® PROBLEM IDENTIFIED</h3>
            <p><strong>Database stored balance:</strong> Rs. 10,688 (CORRECT)</p>
            <p><strong>System calculated balance:</strong> Rs. 17,838 (WRONG)</p>
            <p><strong>Issue:</strong> Balance calculation is overwriting correct stored balance with wrong calculated
                value</p>
        </div>

        <button onclick="analyzeRootCause()">üîç Find Root Cause</button>
        <button onclick="debugLedgerEntries()">üìä Debug All Entries</button>
        <button onclick="identifyWrongEntries()">üéØ Identify Problem Entries</button>

        <div id="analysis"></div>
    </div>

    <script type="module">
        let db;

        async function initializeDB() {
            try {
                const module = await import('./src/services/database.ts');
                db = new module.DatabaseService();
                await db.initialize();
                return true;
            } catch (error) {
                console.error('Database init failed:', error);
                return false;
            }
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('analysis');
            const alertClass = type === 'error' ? 'alert-danger' :
                type === 'success' ? 'alert-info' :
                    type === 'warning' ? 'alert-warning' : 'alert-info';
            results.innerHTML += `<div class="alert ${alertClass}">${message}</div>`;
        }

        window.analyzeRootCause = async function () {
            const results = document.getElementById('analysis');
            results.innerHTML = '<h2>üîç Root Cause Analysis</h2>';

            if (!await initializeDB()) {
                addResult('‚ùå Database connection failed', 'error');
                return;
            }

            try {
                // Find Ata's customer
                const customers = await db.executeRawQuery(\`
                    SELECT id, name, balance 
                    FROM customers 
                    WHERE name LIKE '%Ata%' 
                    LIMIT 1
                \`);

                if (customers.length === 0) {
                    addResult('Customer not found', 'error');
                    return;
                }

                const ata = customers[0];
                addResult(\`üéØ Analyzing: \${ata.name} (ID: \${ata.id})\`);
                addResult(\`üí∞ Current stored balance: Rs. \${(ata.balance || 0).toFixed(2)}\`);

                // Step 1: Get the EXACT calculation that the system is using
                addResult('<h3>üìä STEP 1: System Calculation Analysis</h3>');
                
                const systemCalc = await db.executeRawQuery(\`
                    SELECT 
                        COALESCE(SUM(CASE WHEN entry_type = 'debit' THEN amount ELSE 0 END), 0) as total_debits,
                        COALESCE(SUM(CASE WHEN entry_type = 'credit' THEN amount ELSE 0 END), 0) as total_credits,
                        COALESCE(SUM(CASE WHEN entry_type = 'debit' THEN amount ELSE -amount END), 0) as calculated_balance,
                        COUNT(*) as total_entries,
                        COUNT(CASE WHEN entry_type = 'debit' THEN 1 END) as debit_count,
                        COUNT(CASE WHEN entry_type = 'credit' THEN 1 END) as credit_count,
                        COUNT(CASE WHEN entry_type = 'adjustment' THEN 1 END) as adjustment_count,
                        COUNT(CASE WHEN entry_type NOT IN ('debit', 'credit', 'adjustment') THEN 1 END) as unknown_count
                    FROM customer_ledger_entries 
                    WHERE customer_id = ?
                \`, [ata.id]);

                const calc = systemCalc[0];
                addResult(\`
                    <div class="calculation-box">
                        <h4>üñ•Ô∏è System SQL Calculation Results:</h4>
                        <p><strong>Total Entries:</strong> \${calc.total_entries}</p>
                        <p><strong>Debit Entries:</strong> \${calc.debit_count} (Total: Rs. \${parseFloat(calc.total_debits || 0).toFixed(2)})</p>
                        <p><strong>Credit Entries:</strong> \${calc.credit_count} (Total: Rs. \${parseFloat(calc.total_credits || 0).toFixed(2)})</p>
                        <p><strong>Adjustment Entries:</strong> \${calc.adjustment_count}</p>
                        <p><strong>Unknown Type Entries:</strong> \${calc.unknown_count}</p>
                        <p><strong>Calculated Balance:</strong> Rs. \${parseFloat(calc.calculated_balance || 0).toFixed(2)}</p>
                    </div>
                \`);

                // Step 2: Compare with manual ledger from UI
                addResult('<h3>üìã STEP 2: Expected vs Actual Analysis</h3>');
                addResult(\`
                    <div class="calculation-box">
                        <h4>üìä Comparison:</h4>
                        <p><strong>Expected (from UI ledger):</strong> Debits: Rs. 32,128, Credits: Rs. 21,440 = Balance: Rs. 10,688</p>
                        <p><strong>Actual (from database):</strong> Debits: Rs. \${parseFloat(calc.total_debits || 0).toFixed(2)}, Credits: Rs. \${parseFloat(calc.total_credits || 0).toFixed(2)} = Balance: Rs. \${parseFloat(calc.calculated_balance || 0).toFixed(2)}</p>
                        <p><strong>Debit Difference:</strong> Rs. \${(parseFloat(calc.total_debits || 0) - 32128).toFixed(2)}</p>
                        <p><strong>Credit Difference:</strong> Rs. \${(parseFloat(calc.total_credits || 0) - 21440).toFixed(2)}</p>
                        <p><strong>Balance Difference:</strong> Rs. \${(parseFloat(calc.calculated_balance || 0) - 10688).toFixed(2)}</p>
                    </div>
                \`);

                // Step 3: Identify the problem
                const debitDiff = parseFloat(calc.total_debits || 0) - 32128;
                const creditDiff = parseFloat(calc.total_credits || 0) - 21440;
                const balanceDiff = parseFloat(calc.calculated_balance || 0) - 10688;

                addResult('<h3>üéØ STEP 3: Problem Identification</h3>');
                
                if (Math.abs(debitDiff) > 0.01) {
                    addResult(\`üî• DEBIT ISSUE: Database has Rs. \${Math.abs(debitDiff).toFixed(2)} \${debitDiff > 0 ? 'EXTRA' : 'MISSING'} debits\`, 'error');
                }
                
                if (Math.abs(creditDiff) > 0.01) {
                    addResult(\`üî• CREDIT ISSUE: Database has Rs. \${Math.abs(creditDiff).toFixed(2)} \${creditDiff > 0 ? 'EXTRA' : 'MISSING'} credits\`, 'error');
                }

                if (Math.abs(balanceDiff) > 0.01) {
                    addResult(\`üö® BALANCE CALCULATION IS Rs. \${Math.abs(balanceDiff).toFixed(2)} \${balanceDiff > 0 ? 'TOO HIGH' : 'TOO LOW'}\`, 'error');
                }

                // Step 4: Specific diagnosis
                if (debitDiff === 0 && creditDiff < 0) {
                    addResult('üí° DIAGNOSIS: Missing credit entries - payments not properly recorded as credits', 'warning');
                } else if (debitDiff > 0 && creditDiff === 0) {
                    addResult('üí° DIAGNOSIS: Extra debit entries - duplicate invoices or incorrect debits', 'warning');
                } else if (creditDiff > 0) {
                    addResult('üí° DIAGNOSIS: Extra credit entries - duplicate payments or incorrect credits', 'warning');
                } else if (calc.adjustment_count > 0) {
                    addResult('üí° DIAGNOSIS: Adjustment entries might be affecting calculation incorrectly', 'warning');
                }

            } catch (error) {
                addResult(\`‚ùå Error: \${error.message}\`, 'error');
            }
        };

        window.debugLedgerEntries = async function() {
            if (!await initializeDB()) return;

            const results = document.getElementById('analysis');
            results.innerHTML += '<h2>üìä Debug All Ledger Entries</h2>';

            try {
                const customers = await db.executeRawQuery(\`
                    SELECT id FROM customers WHERE name LIKE '%Ata%' LIMIT 1
                \`);
                
                if (customers.length === 0) return;
                const ataId = customers[0].id;

                // Get ALL entries with detailed info
                const allEntries = await db.executeRawQuery(\`
                    SELECT 
                        id, entry_type, transaction_type, amount, description, 
                        reference_id, reference_number, balance_before, balance_after,
                        date, time, created_by, notes
                    FROM customer_ledger_entries 
                    WHERE customer_id = ?
                    ORDER BY date ASC, time ASC, id ASC
                \`, [ataId]);

                addResult(\`üìù Total entries found: \${allEntries.length}\`);

                // Build detailed table
                let table = \`<table>
                    <tr>
                        <th>ID</th><th>Date/Time</th><th>Type</th><th>Transaction</th><th>Amount</th>
                        <th>Description</th><th>Ref</th><th>Balance Before</th><th>Balance After</th><th>Issues</th>
                    </tr>\`;

                let runningDebits = 0;
                let runningCredits = 0;
                let issueCount = 0;

                for (const entry of allEntries) {
                    const amount = parseFloat(entry.amount || 0);
                    let issues = [];
                    let rowClass = 'match';

                    // Track totals
                    if (entry.entry_type === 'debit') {
                        runningDebits += amount;
                    } else if (entry.entry_type === 'credit') {
                        runningCredits += amount;
                    }

                    // Identify issues
                    if (!entry.entry_type) {
                        issues.push('NULL TYPE');
                        rowClass = 'mismatch';
                    }
                    if (amount <= 0 && entry.entry_type !== 'adjustment') {
                        issues.push('ZERO/NEG AMOUNT');
                        rowClass = 'mismatch';
                    }
                    if (entry.description && entry.description.includes('REFERENCE ONLY')) {
                        issues.push('REF ONLY');
                        if (amount > 0) {
                            issues.push('REF ONLY WITH AMOUNT');
                            rowClass = 'mismatch';
                        }
                    }
                    if (entry.entry_type === 'adjustment' && amount !== 0) {
                        issues.push('ADJ WITH AMOUNT');
                        rowClass = 'mismatch';
                    }

                    if (issues.length > 0) {
                        issueCount++;
                    }

                    const amountClass = entry.entry_type === 'debit' ? 'debit' : 
                                      entry.entry_type === 'credit' ? 'credit' : 'adjustment';

                    table += \`<tr class="\${rowClass}">
                        <td>\${entry.id}</td>
                        <td>\${entry.date} \${entry.time}</td>
                        <td>\${entry.entry_type || 'NULL'}</td>
                        <td>\${entry.transaction_type || ''}</td>
                        <td class="\${amountClass}">Rs. \${amount.toFixed(2)}</td>
                        <td>\${(entry.description || '').substring(0, 50)}...</td>
                        <td>\${entry.reference_number || ''}</td>
                        <td>Rs. \${(entry.balance_before || 0).toFixed(2)}</td>
                        <td>Rs. \${(entry.balance_after || 0).toFixed(2)}</td>
                        <td>\${issues.join(', ') || 'OK'}</td>
                    </tr>\`;
                }

                table += '</table>';
                results.innerHTML += table;

                // Summary
                addResult(\`
                    <div class="calculation-box">
                        <h4>üìä Detailed Entry Analysis:</h4>
                        <p><strong>Total Debits from entries:</strong> Rs. \${runningDebits.toFixed(2)}</p>
                        <p><strong>Total Credits from entries:</strong> Rs. \${runningCredits.toFixed(2)}</p>
                        <p><strong>Manual Balance:</strong> Rs. \${(runningDebits - runningCredits).toFixed(2)}</p>
                        <p><strong>Entries with issues:</strong> \${issueCount}</p>
                    </div>
                \`);

            } catch (error) {
                addResult(\`‚ùå Error: \${error.message}\`, 'error');
            }
        };

        window.identifyWrongEntries = async function() {
            if (!await initializeDB()) return;

            const results = document.getElementById('analysis');
            results.innerHTML += '<h2>üéØ Identify Problem Entries</h2>';

            try {
                const customers = await db.executeRawQuery(\`
                    SELECT id FROM customers WHERE name LIKE '%Ata%' LIMIT 1
                \`);
                
                if (customers.length === 0) return;
                const ataId = customers[0].id;

                // Find problematic entries
                addResult('<h3>üîç Searching for problematic entries...</h3>');

                // 1. Adjustment entries with non-zero amounts
                const adjWithAmount = await db.executeRawQuery(\`
                    SELECT id, amount, description 
                    FROM customer_ledger_entries 
                    WHERE customer_id = ? AND entry_type = 'adjustment' AND amount != 0
                \`, [ataId]);

                if (adjWithAmount.length > 0) {
                    addResult(\`üî• Found \${adjWithAmount.length} adjustment entries with non-zero amounts:\`, 'error');
                    for (const entry of adjWithAmount) {
                        addResult(\`  ‚Ä¢ ID \${entry.id}: Rs. \${entry.amount} - \${entry.description}\`, 'error');
                    }
                }

                // 2. Duplicate entries
                const duplicates = await db.executeRawQuery(\`
                    SELECT reference_number, COUNT(*) as count, SUM(amount) as total_amount
                    FROM customer_ledger_entries 
                    WHERE customer_id = ? AND reference_number IS NOT NULL
                    GROUP BY reference_number
                    HAVING COUNT(*) > 1
                \`, [ataId]);

                if (duplicates.length > 0) {
                    addResult(\`üî• Found \${duplicates.length} potential duplicate references:\`, 'error');
                    for (const dup of duplicates) {
                        addResult(\`  ‚Ä¢ \${dup.reference_number}: \${dup.count} entries, Total: Rs. \${dup.total_amount}\`, 'error');
                    }
                }

                // 3. Zero amount entries that should have amounts
                const zeroAmounts = await db.executeRawQuery(\`
                    SELECT id, entry_type, description 
                    FROM customer_ledger_entries 
                    WHERE customer_id = ? AND amount = 0 AND entry_type IN ('debit', 'credit')
                \`, [ataId]);

                if (zeroAmounts.length > 0) {
                    addResult(\`üî• Found \${zeroAmounts.length} debit/credit entries with zero amounts:\`, 'error');
                    for (const entry of zeroAmounts) {
                        addResult(\`  ‚Ä¢ ID \${entry.id} (\${entry.entry_type}): \${entry.description}\`, 'error');
                    }
                }

                // 4. Find the exact Rs. 7,150 discrepancy source
                const discrepancyAmount = 17838 - 10688; // Rs. 7,150
                addResult(\`<h3>üéØ Looking for Rs. \${discrepancyAmount} discrepancy source...</h3>\`);

                const matchingAmounts = await db.executeRawQuery(\`
                    SELECT id, entry_type, amount, description, reference_number
                    FROM customer_ledger_entries 
                    WHERE customer_id = ? AND ABS(amount - ?) < 0.01
                \`, [ataId, discrepancyAmount]);

                if (matchingAmounts.length > 0) {
                    addResult(\`üéØ Found entries matching discrepancy amount Rs. \${discrepancyAmount}:\`, 'warning');
                    for (const entry of matchingAmounts) {
                        addResult(\`  ‚Ä¢ ID \${entry.id} (\${entry.entry_type}): Rs. \${entry.amount} - \${entry.description}\`, 'warning');
                    }
                }

            } catch (error) {
                addResult(\`‚ùå Error: \${error.message}\`, 'error');
            }
        };

        // Initialize on load
        initializeDB();
    </script>
</body>

</html>