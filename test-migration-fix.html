<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Test Fixed Migration System</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 10px;
        }

        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-family: inherit;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button.success {
            background-color: #28a745;
        }

        .button.success:hover {
            background-color: #218838;
        }

        .output {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 600px;
            overflow-y: auto;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Test Fixed Migration System</h1>
            <p>Testing the corrected automatic production migration</p>
        </div>

        <div>
            <button class="button success" onclick="testMigrationSystem()">
                üß™ Test Migration System
            </button>
            <button class="button" onclick="checkDatabaseSchema()">
                üîç Check Database Schema
            </button>
            <button class="button" onclick="testBasicQueries()">
                üìä Test Basic Queries
            </button>
            <button class="button" onclick="clearOutput()">
                üóëÔ∏è Clear Output
            </button>
        </div>

        <div id="output" class="output">
            Ready to test the migration system. Click "Test Migration System" to start.

            This will test:
            ‚úÖ Database connection
            ‚úÖ Basic query functionality
            ‚úÖ Migration detection
            ‚úÖ Migration execution (if needed)
            ‚úÖ Validation of results
        </div>
    </div>

    <script type="module">
        import { db } from './src/services/database.ts';

        window.db = db;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            let className = '';

            if (type === 'error') className = 'error';
            else if (type === 'success') className = 'success';
            else if (type === 'warning') className = 'warning';
            else if (type === 'info') className = 'info';

            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        window.testMigrationSystem = async function () {
            log('üß™ === TESTING MIGRATION SYSTEM ===', 'info');

            try {
                if (!window.db) {
                    log('‚ùå Database instance not available', 'error');
                    return;
                }

                log('‚úÖ Database instance available', 'success');

                // Test database connection
                log('üîç Testing database connection...', 'info');
                try {
                    const dbConnection = window.db.dbConnection;
                    if (dbConnection) {
                        log('‚úÖ Database connection available', 'success');
                    } else {
                        log('‚ùå Database connection not available', 'error');
                        return;
                    }
                } catch (dbError) {
                    log(`‚ùå Database connection error: ${dbError.message}`, 'error');
                    return;
                }

                // Test basic query
                log('üìä Testing basic query...', 'info');
                try {
                    const invoiceCount = await window.db.dbConnection.select('SELECT COUNT(*) as count FROM invoices');
                    log(`‚úÖ Found ${invoiceCount[0]?.count || 0} invoices in database`, 'success');
                } catch (queryError) {
                    log(`‚ùå Basic query failed: ${queryError.message}`, 'error');
                    return;
                }

                // Test migration system
                log('üöÄ Testing automatic migration...', 'info');
                try {
                    const { runAutomaticProductionMigration } = await import('./src/utils/automatic-production-migration.ts');
                    log('‚úÖ Migration module imported successfully', 'success');

                    log('üîß Running migration...', 'info');
                    const result = await runAutomaticProductionMigration(window.db.dbConnection);

                    log('üìä === MIGRATION RESULTS ===', 'info');
                    log(`Success: ${result.success}`, result.success ? 'success' : 'error');
                    log(`Total time: ${result.totalTime}ms`, 'info');
                    log(`Triggers updated: ${result.operations.triggersUpdated}`, 'info');
                    log(`Invoices fixed: ${result.operations.invoicesFixed}`, 'info');
                    log(`Customers fixed: ${result.operations.customersFixed}`, 'info');
                    log(`Validation passed: ${result.operations.validationPassed}`, 'info');

                    if (result.errors.length > 0) {
                        log('‚ö†Ô∏è Migration errors:', 'warning');
                        result.errors.forEach(error => {
                            log(`   ${error}`, 'warning');
                        });
                    }

                    if (result.success) {
                        log('üéâ MIGRATION COMPLETED SUCCESSFULLY!', 'success');
                    } else {
                        log('‚ùå MIGRATION FAILED', 'error');
                    }

                } catch (migrationError) {
                    log(`‚ùå Migration test failed: ${migrationError.message}`, 'error');
                    console.error('Migration error details:', migrationError);
                }

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };

        window.checkDatabaseSchema = async function () {
            log('üîç === CHECKING DATABASE SCHEMA ===', 'info');

            try {
                if (!window.db?.dbConnection) {
                    log('‚ùå Database connection not available', 'error');
                    return;
                }

                // Check for return_items table
                log('üìã Checking return_items table...', 'info');
                try {
                    const returnItemsSchema = await window.db.dbConnection.select("PRAGMA table_info(return_items)");
                    if (returnItemsSchema.length > 0) {
                        log('‚úÖ return_items table exists', 'success');
                        log('üìã return_items columns:', 'info');
                        returnItemsSchema.forEach(col => {
                            log(`   ${col.name}: ${col.type}`, 'info');
                        });
                    } else {
                        log('‚ö†Ô∏è return_items table does not exist', 'warning');
                    }
                } catch (error) {
                    log('‚ùå return_items table check failed', 'error');
                }

                // Check for invoice_items table
                log('üìã Checking invoice_items table...', 'info');
                try {
                    const invoiceItemsSchema = await window.db.dbConnection.select("PRAGMA table_info(invoice_items)");
                    if (invoiceItemsSchema.length > 0) {
                        log('‚úÖ invoice_items table exists', 'success');
                        log('üìã invoice_items columns:', 'info');
                        invoiceItemsSchema.forEach(col => {
                            log(`   ${col.name}: ${col.type}`, 'info');
                        });
                    } else {
                        log('‚ö†Ô∏è invoice_items table does not exist', 'warning');
                    }
                } catch (error) {
                    log('‚ùå invoice_items table check failed', 'error');
                }

                // Check triggers
                log('üîß Checking triggers...', 'info');
                try {
                    const triggers = await window.db.dbConnection.select(`
                        SELECT name FROM sqlite_master 
                        WHERE type = 'trigger' 
                        AND name LIKE 'trg_invoice_payment%'
                        ORDER BY name
                    `);

                    if (triggers.length > 0) {
                        log(`‚úÖ Found ${triggers.length} payment triggers`, 'success');
                        triggers.forEach(trigger => {
                            log(`   ${trigger.name}`, 'info');
                        });
                    } else {
                        log('‚ö†Ô∏è No payment triggers found', 'warning');
                    }
                } catch (error) {
                    log('‚ùå Trigger check failed', 'error');
                }

            } catch (error) {
                log(`‚ùå Schema check failed: ${error.message}`, 'error');
            }
        };

        window.testBasicQueries = async function () {
            log('üìä === TESTING BASIC QUERIES ===', 'info');

            try {
                if (!window.db?.dbConnection) {
                    log('‚ùå Database connection not available', 'error');
                    return;
                }

                // Test invoice query
                log('üìÑ Testing invoice query...', 'info');
                try {
                    const invoices = await window.db.dbConnection.select('SELECT COUNT(*) as count FROM invoices LIMIT 1');
                    log(`‚úÖ Invoice query successful: ${invoices[0]?.count || 0} invoices`, 'success');
                } catch (error) {
                    log(`‚ùå Invoice query failed: ${error.message}`, 'error');
                }

                // Test customer query
                log('üë• Testing customer query...', 'info');
                try {
                    const customers = await window.db.dbConnection.select('SELECT COUNT(*) as count FROM customers LIMIT 1');
                    log(`‚úÖ Customer query successful: ${customers[0]?.count || 0} customers`, 'success');
                } catch (error) {
                    log(`‚ùå Customer query failed: ${error.message}`, 'error');
                }

                // Test precision issues
                log('üîç Testing for precision issues...', 'info');
                try {
                    const precisionIssues = await window.db.dbConnection.select(`
                        SELECT COUNT(*) as count FROM invoices 
                        WHERE remaining_balance != ROUND(remaining_balance, 2)
                           OR payment_amount != ROUND(payment_amount, 2)
                    `);
                    const count = precisionIssues[0]?.count || 0;
                    if (count > 0) {
                        log(`‚ö†Ô∏è Found ${count} invoices with precision issues`, 'warning');
                    } else {
                        log('‚úÖ No precision issues found in invoices', 'success');
                    }
                } catch (error) {
                    log(`‚ùå Precision check failed: ${error.message}`, 'error');
                }

                // Test customer status issues
                log('üîç Testing customer status logic...', 'info');
                try {
                    const statusIssues = await window.db.dbConnection.select(`
                        SELECT COUNT(*) as count FROM customers 
                        WHERE (total_balance <= 0.01 AND status = 'Outstanding')
                           OR (total_balance > 0.01 AND status != 'Outstanding')
                    `);
                    const count = statusIssues[0]?.count || 0;
                    if (count > 0) {
                        log(`‚ö†Ô∏è Found ${count} customers with status issues`, 'warning');
                    } else {
                        log('‚úÖ No customer status issues found', 'success');
                    }
                } catch (error) {
                    log(`‚ùå Status check failed: ${error.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Query test failed: ${error.message}`, 'error');
            }
        };

        window.clearOutput = function () {
            document.getElementById('output').innerHTML = 'Output cleared.\n';
        };

        // Initialize
        log('üöÄ Migration test system initialized', 'success');
        log('üí° Use the buttons above to test the migration system', 'info');
    </script>
</body>

</html>