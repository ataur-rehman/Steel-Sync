<!DOCTYPE html>
<html>

<head>
    <title>Balance Order Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .success {
            color: green;
            font-weight: bold;
        }

        .error {
            color: red;
            font-weight: bold;
        }

        .warning {
            color: orange;
            font-weight: bold;
        }

        .balance-correct {
            background-color: #d4edda;
        }

        .balance-wrong {
            background-color: #f8d7da;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }
    </style>
</head>

<body>
    <h1>üîç Balance Order Fix Test</h1>

    <div class="section">
        <h2>Test Customer Ledger Display Order</h2>
        <button class="btn-primary" onclick="testBalanceOrder()">üß™ Test Balance Order</button>
        <div id="testResults"></div>
    </div>

    <script type="module">
        let db;

        async function initializeDB() {
            try {
                const module = await import('./src/services/database.ts');
                db = new module.DatabaseService();
                await db.initialize();
                console.log('‚úÖ Database initialized');
                return true;
            } catch (error) {
                console.error('‚ùå Failed to initialize database:', error);
                document.getElementById('testResults').innerHTML = `<p class="error">‚ùå Failed to initialize database: ${error.message}</p>`;
                return false;
            }
        }

        window.testBalanceOrder = async function () {
            const results = document.getElementById('testResults');
            results.innerHTML = '<h3>üß™ Testing Balance Order</h3>';

            if (!await initializeDB()) return;

            try {
                // Get a customer with recent transactions
                const customers = await db.executeRawQuery(`
                    SELECT DISTINCT customer_id, customer_name 
                    FROM customer_ledger_entries 
                    ORDER BY created_at DESC 
                    LIMIT 5
                `);

                if (customers.length === 0) {
                    results.innerHTML += '<p class="warning">No customers with transactions found</p>';
                    return;
                }

                const testCustomer = customers[0];
                results.innerHTML += `<h4>Testing Customer: ${testCustomer.customer_name}</h4>`;

                // Get customer ledger using the fixed method
                const ledger = await db.getCustomerLedger(testCustomer.customer_id, {});

                if (!ledger.transactions || ledger.transactions.length === 0) {
                    results.innerHTML += '<p class="warning">No transactions found for this customer</p>';
                    return;
                }

                // Display the transactions
                results.innerHTML += '<table>';
                results.innerHTML += '<tr><th>Date & Time</th><th>Description</th><th>Type</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Status</th></tr>';

                let previousBalance = null;
                let correctOrder = true;

                ledger.transactions.forEach((tx, index) => {
                    const isDebit = tx.entry_type === 'debit';
                    const debitAmount = isDebit ? parseFloat(tx.amount || 0) : 0;
                    const creditAmount = !isDebit ? parseFloat(tx.amount || 0) : 0;
                    const currentBalance = parseFloat(tx.display_balance || tx.balance_after || 0);

                    // Check if balance calculation is logical
                    let balanceStatus = 'correct';
                    if (previousBalance !== null) {
                        const expectedBalance = isDebit ?
                            previousBalance + debitAmount :
                            previousBalance - creditAmount;

                        if (Math.abs(expectedBalance - currentBalance) > 0.01) {
                            balanceStatus = 'wrong';
                            correctOrder = false;
                        }
                    }

                    const rowClass = balanceStatus === 'correct' ? 'balance-correct' : 'balance-wrong';

                    results.innerHTML += `<tr class="${rowClass}">
                        <td>${tx.date} ${tx.time}</td>
                        <td>${tx.description || ''}</td>
                        <td>${tx.entry_type} (${tx.transaction_type})</td>
                        <td>${debitAmount > 0 ? debitAmount.toFixed(2) : '-'}</td>
                        <td>${creditAmount > 0 ? creditAmount.toFixed(2) : '-'}</td>
                        <td>${currentBalance.toFixed(2)}</td>
                        <td>${balanceStatus === 'correct' ? '‚úÖ' : '‚ùå'}</td>
                    </tr>`;

                    previousBalance = currentBalance;
                });

                results.innerHTML += '</table>';

                // Summary
                if (correctOrder) {
                    results.innerHTML += '<p class="success">‚úÖ Balance calculations are correct! The fix is working.</p>';
                } else {
                    results.innerHTML += '<p class="error">‚ùå Balance calculations are still incorrect. Manual inspection needed.</p>';
                }

                results.innerHTML += `<p><strong>Customer Current Balance:</strong> ${ledger.current_balance.toFixed(2)}</p>`;

            } catch (error) {
                results.innerHTML += `<p class="error">‚ùå Error during test: ${error.message}</p>`;
                console.error('Test error:', error);
            }
        };

        // Initialize when page loads
        initializeDB();
    </script>
</body>

</html>