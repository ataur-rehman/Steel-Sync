<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® CRITICAL: T-Iron Database Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .critical {
            background: #ffebee;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        button.success {
            background: #28a745;
        }

        button.info {
            background: #17a2b8;
        }

        button:hover {
            opacity: 0.9;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 600px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .schema-info {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .sql-code {
            background: #343a40;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }

        .field-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin: 2px;
        }

        .field-exists {
            background: #d4edda;
            color: #155724;
        }

        .field-missing {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üö® CRITICAL: T-Iron Database Schema Fix</h1>

        <div class="critical">
            <h2>üî• CRITICAL ISSUE DETECTED</h2>
            <p><strong>Problem:</strong> T-Iron data is NOT being saved to database!</p>
            <p><strong>Columns Empty:</strong> t_iron_pieces, t_iron_length_per_piece, t_iron_total_feet</p>
            <p><strong>Impact:</strong> System falls back to smart reconstruction (showing 11√ó12 instead of actual
                input)</p>
            <p><strong>Status:</strong> REQUIRES IMMEDIATE FIX</p>
        </div>

        <div class="info">
            <h2>üîß Database Schema Check</h2>
            <p>We need to verify the invoice_items table has the correct T-Iron columns and they're being populated
                properly.</p>
            <button onclick="checkDatabaseSchema()" class="info">üîç Check Database Schema</button>
            <button onclick="testTIronSave()" class="critical">üß™ Test T-Iron Save</button>
            <button onclick="fixDatabaseSchema()" class="success">üîß Fix Database Schema</button>
        </div>

        <div id="schemaResults" class="info" style="display:none;">
            <h3>üìã Schema Analysis Results</h3>
            <div id="schemaLog" class="log">Checking database schema...</div>
        </div>

        <div id="testResults" class="warning" style="display:none;">
            <h3>üß™ T-Iron Save Test Results</h3>
            <div id="testLog" class="log">Testing T-Iron data save...</div>
        </div>

        <div class="schema-info">
            <h3>üìä Required T-Iron Columns</h3>
            <div class="sql-code">
                ALTER TABLE invoice_items ADD COLUMN t_iron_pieces INTEGER;
                ALTER TABLE invoice_items ADD COLUMN t_iron_length_per_piece REAL;
                ALTER TABLE invoice_items ADD COLUMN t_iron_total_feet REAL;
                ALTER TABLE invoice_items ADD COLUMN t_iron_unit TEXT DEFAULT 'pcs';
            </div>
        </div>
    </div>

    <script>
        async function log(message, section = 'schemaLog') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById(section);
            logElement.innerHTML += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        async function checkDatabaseSchema() {
            document.getElementById('schemaResults').style.display = 'block';
            document.getElementById('schemaLog').innerHTML = '';

            try {
                await log('üîç CHECKING: Database schema for T-Iron columns');

                if (!window.db) {
                    await log('‚ùå Database not available');
                    return;
                }

                // Get table schema
                const schema = await window.db.execute(`PRAGMA table_info(invoice_items)`);
                await log('üìã Invoice Items Table Schema:');

                const requiredColumns = ['t_iron_pieces', 't_iron_length_per_piece', 't_iron_total_feet', 't_iron_unit'];
                const existingColumns = schema.map(col => col.name);

                for (const col of schema) {
                    const isRequired = requiredColumns.includes(col.name);
                    const status = isRequired ? '[T-IRON]' : '[STANDARD]';
                    await log(`   ${status} ${col.name}: ${col.type} ${col.notnull ? 'NOT NULL' : 'NULL'} ${col.dflt_value ? `DEFAULT ${col.dflt_value}` : ''}`);
                }

                // Check for missing T-Iron columns
                const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));

                if (missingColumns.length > 0) {
                    await log('üö® MISSING T-IRON COLUMNS:');
                    for (const col of missingColumns) {
                        await log(`   ‚ùå ${col}`);
                    }
                    await log('‚ö†Ô∏è Database schema needs to be updated!');
                } else {
                    await log('‚úÖ All T-Iron columns exist in schema');
                }

                // Test if we can query T-Iron specific data
                const testQuery = await window.db.execute(`
                    SELECT id, product_name, t_iron_pieces, t_iron_length_per_piece, t_iron_total_feet, t_iron_unit
                    FROM invoice_items 
                    WHERE product_name LIKE '%T%Iron%' OR product_name LIKE '%T-Iron%'
                    ORDER BY id DESC 
                    LIMIT 5
                `);

                await log('üìä Recent T-Iron Items in Database:');
                if (testQuery.length > 0) {
                    for (const item of testQuery) {
                        const hasData = item.t_iron_pieces && item.t_iron_length_per_piece;
                        await log(`   ID ${item.id}: ${item.product_name} - Pieces: ${item.t_iron_pieces}, Length: ${item.t_iron_length_per_piece}, Total: ${item.t_iron_total_feet} ${hasData ? '‚úÖ' : '‚ùå'}`);
                    }
                } else {
                    await log('   No T-Iron items found in database');
                }

            } catch (error) {
                await log(`‚ùå Schema check failed: ${error.message}`);
            }
        }

        async function testTIronSave() {
            document.getElementById('testResults').style.display = 'block';
            document.getElementById('testLog').innerHTML = '';

            try {
                await log('üß™ TESTING: T-Iron data save functionality', 'testLog');

                if (!window.db) {
                    await log('‚ùå Database not available', 'testLog');
                    return;
                }

                // Create test invoice
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'T-Iron Schema Test',
                    bill_number: 'TIRON-SCHEMA-' + Date.now(),
                    subtotal: 16368,
                    total_amount: 16368,
                    grand_total: 16368
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                await log(`üìã Created test invoice: ${invoiceId}`, 'testLog');

                // Create T-Iron item with explicit T-Iron data (simulating calculator output)
                const tIronTestItem = {
                    product_id: null,
                    product_name: 'T Iron',
                    quantity: '132', // Total feet
                    unit_price: 124, // Price per foot
                    total_price: 16368, // 132 √ó 124
                    unit: 'ft',
                    // CRITICAL: T-Iron specific data
                    t_iron_pieces: 11,
                    t_iron_length_per_piece: 12,
                    t_iron_total_feet: 132, // 11 √ó 12
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                await log('üíæ SAVING: T-Iron item with specific data:', 'testLog');
                await log(`   Pieces: ${tIronTestItem.t_iron_pieces}`, 'testLog');
                await log(`   Length per piece: ${tIronTestItem.t_iron_length_per_piece}`, 'testLog');
                await log(`   Total feet: ${tIronTestItem.t_iron_total_feet}`, 'testLog');
                await log(`   Unit: ${tIronTestItem.t_iron_unit}`, 'testLog');

                const itemIds = await window.db.addInvoiceItems(invoiceId, [tIronTestItem]);
                await log(`‚úÖ Item saved with ID: ${itemIds[0]}`, 'testLog');

                // CRITICAL: Retrieve and verify the saved data
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    await log('üîç VERIFICATION: Checking saved T-Iron data:', 'testLog');
                    await log(`   Retrieved pieces: ${savedItem.t_iron_pieces} (${typeof savedItem.t_iron_pieces})`, 'testLog');
                    await log(`   Retrieved length: ${savedItem.t_iron_length_per_piece} (${typeof savedItem.t_iron_length_per_piece})`, 'testLog');
                    await log(`   Retrieved total: ${savedItem.t_iron_total_feet} (${typeof savedItem.t_iron_total_feet})`, 'testLog');
                    await log(`   Retrieved unit: ${savedItem.t_iron_unit}`, 'testLog');

                    // Check if data was actually saved
                    const hasProperData = savedItem.t_iron_pieces && savedItem.t_iron_length_per_piece && savedItem.t_iron_total_feet;

                    if (hasProperData) {
                        await log('üéâ SUCCESS: T-Iron data was properly saved!', 'testLog');
                        await log(`   Display should show: (${savedItem.t_iron_pieces}pcs √ó ${savedItem.t_iron_length_per_piece}ft/pcs √ó Rs.${savedItem.unit_price})`, 'testLog');
                    } else {
                        await log('üö® CRITICAL: T-Iron data was NOT saved properly!', 'testLog');
                        await log('   This explains why smart reconstruction is being used', 'testLog');

                        if (!savedItem.t_iron_pieces) await log('   ‚ùå t_iron_pieces is null/undefined', 'testLog');
                        if (!savedItem.t_iron_length_per_piece) await log('   ‚ùå t_iron_length_per_piece is null/undefined', 'testLog');
                        if (!savedItem.t_iron_total_feet) await log('   ‚ùå t_iron_total_feet is null/undefined', 'testLog');
                    }

                    // Show what the display logic would do
                    await log('üñ•Ô∏è DISPLAY LOGIC TEST:', 'testLog');
                    if (savedItem.t_iron_pieces && savedItem.t_iron_length_per_piece) {
                        await log('   ‚úÖ Would use saved data for display', 'testLog');
                    } else {
                        await log('   ‚ö†Ô∏è Would use smart reconstruction for display', 'testLog');
                        // Simulate smart reconstruction
                        const totalFeet = parseInt(savedItem.quantity);
                        const commonLengths = [14, 15, 12, 10, 16, 8, 20];
                        let bestFit = { pieces: Math.round(totalFeet / 12), length: 12 };

                        for (const length of commonLengths) {
                            const pieces = Math.round(totalFeet / length);
                            const calculatedTotal = pieces * length;
                            const difference = Math.abs(totalFeet - calculatedTotal);

                            if (difference < Math.abs(totalFeet - (bestFit.pieces * bestFit.length))) {
                                bestFit = { pieces, length };
                            }
                        }

                        await log(`   Smart reconstruction result: ${bestFit.pieces}√ó${bestFit.length}`, 'testLog');
                    }

                } else {
                    await log('‚ùå Could not retrieve saved item', 'testLog');
                }

            } catch (error) {
                await log(`‚ùå T-Iron save test failed: ${error.message}`, 'testLog');
                console.error('Full error:', error);
            }
        }

        async function fixDatabaseSchema() {
            try {
                await log('üîß ATTEMPTING: Database schema fix');

                if (!window.db) {
                    await log('‚ùå Database not available');
                    return;
                }

                // Add missing T-Iron columns if they don't exist
                const alterCommands = [
                    `ALTER TABLE invoice_items ADD COLUMN t_iron_pieces INTEGER`,
                    `ALTER TABLE invoice_items ADD COLUMN t_iron_length_per_piece REAL`,
                    `ALTER TABLE invoice_items ADD COLUMN t_iron_total_feet REAL`,
                    `ALTER TABLE invoice_items ADD COLUMN t_iron_unit TEXT DEFAULT 'pcs'`
                ];

                for (const command of alterCommands) {
                    try {
                        await window.db.execute(command);
                        await log(`‚úÖ Executed: ${command}`);
                    } catch (error) {
                        if (error.message.includes('duplicate column')) {
                            await log(`‚ÑπÔ∏è Column already exists: ${command.split(' ')[4]}`);
                        } else {
                            await log(`‚ùå Failed: ${command} - ${error.message}`);
                        }
                    }
                }

                await log('üéâ Database schema fix completed!');
                await log('‚ÑπÔ∏è Please test T-Iron save again to verify fix');

            } catch (error) {
                await log(`‚ùå Schema fix failed: ${error.message}`);
            }
        }

        // Initialize
        console.log('üö® Critical T-Iron Database Fix Tool Ready');
    </script>
</body>

</html>