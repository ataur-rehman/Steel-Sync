<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ T-Iron Fix Verification - User Scenario</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #007acc;
            background: #f8f9fa;
        }

        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background: #005a9e;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }

        .scenario {
            background: #e9ecef;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #6c757d;
        }

        .expected {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }

        .actual {
            color: #dc3545;
            font-weight: bold;
            font-size: 18px;
        }

        .fixed {
            color: #28a745;
            font-weight: bold;
            font-size: 18px;
        }

        .highlight {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéØ T-Iron Display Fix Verification</h1>

        <div class="scenario">
            <h2>üìã Your Exact Bug Report</h2>
            <p><strong>User Input:</strong> 14 Pieces √ó 15 Length/pc (ft) √ó 116 Price/ft (Rs.)</p>
            <p><strong>Wrong Display:</strong> <span class="actual">T Iron (15pcs √ó 14ft/pcs √ó Rs.116) ‚ö†Ô∏è</span></p>
            <p><strong>Expected Display:</strong> <span class="expected">T Iron (14pcs √ó 15ft/pcs √ó Rs.116)</span></p>
            <p><strong>Total Feet:</strong> 210 ft (14 √ó 15 = 210) ‚úÖ</p>
        </div>

        <div class="test-section">
            <h2>üîß Applied Fixes</h2>
            <ul>
                <li>‚úÖ Enhanced type conversion for T-Iron data (numbers vs strings)</li>
                <li>‚úÖ Improved smart reconstruction algorithm with better logging</li>
                <li>‚úÖ Permanent auto-healing schema handler integration</li>
                <li>‚úÖ Preference for fewer pieces + longer length in reconstruction</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>üß™ Verification Tests</h2>
            <button onclick="testUserExactScenario()">üéØ Test User's Exact Scenario</button>
            <button onclick="testDisplayLogicDirectly()">üì∫ Test Display Logic Only</button>
            <button onclick="testReconstructionFix()">ü§ñ Test Reconstruction Fix</button>
            <button onclick="clearResults()">üßπ Clear Results</button>
        </div>

        <div id="results" class="test-section">
            <h2>üìã Test Results</h2>
            <div id="testLog" class="log">Ready to test the fix...</div>
        </div>
    </div>

    <script>
        let testLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'debug': 'üîß',
                'fixed': 'üéâ'
            }[type] || '‚ÑπÔ∏è';

            testLog.push(`[${timestamp}] ${typeIcon} ${message}`);
            updateDisplay();
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateDisplay() {
            document.getElementById('testLog').innerHTML = testLog.join('\n');
            document.getElementById('testLog').scrollTop = document.getElementById('testLog').scrollHeight;
        }

        function clearResults() {
            testLog = [];
            updateDisplay();
            log('üîß T-Iron Display Fix Verification Ready', 'info');
        }

        async function testUserExactScenario() {
            log('üéØ TESTING: User\'s exact scenario (14pcs √ó 15ft √ó 116Rs)', 'info');

            try {
                // Create test invoice
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'Fix Verification Customer',
                    bill_number: 'FIX-' + Date.now(),
                    subtotal: 24360,
                    total_amount: 24360,
                    grand_total: 24360
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                log(`üìã Created test invoice: ${invoiceId}`, 'success');

                // Add T-Iron item EXACTLY as user entered
                const userTIronItem = {
                    product_id: null,
                    product_name: 'T Iron',
                    quantity: '210', // 14 √ó 15 = 210
                    unit_price: 116,
                    total_price: 24360, // 210 √ó 116
                    unit: 'ft',
                    t_iron_pieces: 14, // ‚Üê USER'S INPUT
                    t_iron_length_per_piece: 15, // ‚Üê USER'S INPUT
                    t_iron_total_feet: 210,
                    t_iron_unit: 'pcs',
                    is_non_stock_item: 1
                };

                log('üíæ Saving T-Iron with EXACT user data:', 'debug');
                log(`   Pieces: ${userTIronItem.t_iron_pieces} (should be 14)`, 'debug');
                log(`   Length/piece: ${userTIronItem.t_iron_length_per_piece} (should be 15)`, 'debug');

                const itemIds = await window.db.addInvoiceItems(invoiceId, [userTIronItem]);
                log(`‚úÖ Saved T-Iron item with ID: ${itemIds[0]}`, 'success');

                // Retrieve and check what was actually saved
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const savedItem = savedInvoice.items.find(item => item.id === itemIds[0]);

                if (savedItem) {
                    log('üîç Database storage verification:', 'debug');
                    log(`   Saved pieces: ${savedItem.t_iron_pieces} (type: ${typeof savedItem.t_iron_pieces})`, 'debug');
                    log(`   Saved length: ${savedItem.t_iron_length_per_piece} (type: ${typeof savedItem.t_iron_length_per_piece})`, 'debug');
                    log(`   Saved total: ${savedItem.t_iron_total_feet}`, 'debug');

                    // Test the enhanced display logic
                    const pieces = Number(savedItem.t_iron_pieces);
                    const lengthPerPiece = Number(savedItem.t_iron_length_per_piece);
                    const unitPrice = Number(savedItem.unit_price);

                    log('üîß Type conversion test:', 'debug');
                    log(`   Converted pieces: ${pieces} (valid: ${pieces > 0})`, 'debug');
                    log(`   Converted length: ${lengthPerPiece} (valid: ${lengthPerPiece > 0})`, 'debug');

                    if (pieces > 0 && lengthPerPiece > 0) {
                        const unit = savedItem.t_iron_unit || 'pcs';
                        const displayText = `(${pieces}${unit} √ó ${lengthPerPiece}ft/${unit} √ó Rs.${unitPrice})`;

                        log('üéâ DISPLAY LOGIC TEST:', 'fixed');
                        log(`   Generated display: "T Iron ${displayText}"`, 'fixed');

                        if (pieces === 14 && lengthPerPiece === 15) {
                            log('üéâ SUCCESS! Display shows user\'s exact input: 14pcs √ó 15ft', 'fixed');
                            log('‚úÖ BUG FIXED: No more swapped values!', 'fixed');
                        } else {
                            log(`‚ùå Still showing wrong values: ${pieces}pcs √ó ${lengthPerPiece}ft`, 'error');
                        }
                    } else {
                        log('‚ùå Type conversion failed - would fall back to reconstruction', 'error');
                        testReconstructionForValue(210);
                    }
                } else {
                    log('‚ùå Could not retrieve saved item', 'error');
                }

            } catch (error) {
                log(`‚ùå Test failed: ${error.message}`, 'error');
                console.error('Full error:', error);
            }
        }

        function testDisplayLogicDirectly() {
            log('üì∫ TESTING: Display logic directly with mock data', 'info');

            try {
                // Mock item with user's exact data
                const mockItem = {
                    product_name: 'T Iron',
                    quantity: '210',
                    unit_price: 116,
                    t_iron_pieces: 14, // Number
                    t_iron_length_per_piece: 15, // Number
                    t_iron_total_feet: 210,
                    t_iron_unit: 'pcs',
                    is_misc_item: false
                };

                log('üîß Testing enhanced display logic:', 'debug');

                // Test type checking (new fix)
                const pieces = Number(mockItem.t_iron_pieces);
                const lengthPerPiece = Number(mockItem.t_iron_length_per_piece);
                const unitPrice = Number(mockItem.unit_price);

                log(`   Type conversion: ${mockItem.t_iron_pieces} ‚Üí ${pieces}`, 'debug');
                log(`   Type conversion: ${mockItem.t_iron_length_per_piece} ‚Üí ${lengthPerPiece}`, 'debug');
                log(`   Valid numbers: ${pieces > 0 && lengthPerPiece > 0}`, 'debug');

                if (pieces > 0 && lengthPerPiece > 0) {
                    const unit = mockItem.t_iron_unit || 'pcs';
                    const displayText = `(${pieces}${unit} √ó ${lengthPerPiece}ft/${unit} √ó Rs.${unitPrice})`;

                    log('‚úÖ ENHANCED LOGIC RESULT:', 'success');
                    log(`   Display: "T Iron ${displayText}"`, 'success');

                    if (displayText.includes('14pcs √ó 15ft')) {
                        log('üéâ PERFECT! Shows exactly what user entered', 'fixed');
                    } else {
                        log('‚ùå Still not showing user input correctly', 'error');
                    }
                } else {
                    log('‚ùå Enhanced logic failed, would use reconstruction', 'warning');
                }

                // Test with string values (potential issue)
                log('üîß Testing with string values (edge case):', 'debug');
                const mockItemStrings = {
                    ...mockItem,
                    t_iron_pieces: "14", // String
                    t_iron_length_per_piece: "15", // String
                };

                const piecesStr = Number(mockItemStrings.t_iron_pieces);
                const lengthStr = Number(mockItemStrings.t_iron_length_per_piece);

                if (piecesStr > 0 && lengthStr > 0) {
                    log('‚úÖ String conversion works correctly', 'success');
                    log(`   "14" ‚Üí ${piecesStr}, "15" ‚Üí ${lengthStr}`, 'success');
                } else {
                    log('‚ùå String conversion failed', 'error');
                }

            } catch (error) {
                log(`‚ùå Display logic test failed: ${error.message}`, 'error');
            }
        }

        function testReconstructionFix() {
            log('ü§ñ TESTING: Improved smart reconstruction algorithm', 'info');

            testReconstructionForValue(210);
        }

        function testReconstructionForValue(totalFeet) {
            try {
                log(`üîß Testing reconstruction for ${totalFeet} total feet`, 'debug');

                // Simulate improved algorithm from the fix
                const commonLengths = [14, 12, 10, 16, 8, 20];
                let bestFit = { pieces: Math.round(totalFeet / 12), length: 12, difference: Math.abs(totalFeet % 12) };

                log('üßÆ Testing common lengths:', 'debug');
                for (const length of commonLengths) {
                    const pieces = Math.round(totalFeet / length);
                    const calculatedTotal = pieces * length;
                    const difference = Math.abs(totalFeet - calculatedTotal);

                    log(`   ${pieces} √ó ${length} = ${calculatedTotal} (diff: ${difference})`, 'debug');

                    if (difference < bestFit.difference && pieces > 0) {
                        bestFit = { pieces, length, difference };
                        log(`     ‚≠ê New best fit!`, 'debug');
                    } else if (difference === bestFit.difference && difference === 0) {
                        // NEW FIX: Prefer fewer pieces with longer length
                        if (pieces < bestFit.pieces && length > bestFit.length) {
                            bestFit = { pieces, length, difference };
                            log(`     ‚≠ê Better perfect match (fewer pieces, longer length)!`, 'debug');
                        }
                    }
                }

                log(`üéØ RECONSTRUCTION RESULT: ${bestFit.pieces}pcs √ó ${bestFit.length}ft/pcs`, 'warning');

                if (bestFit.pieces === 14 && bestFit.length === 15) {
                    log('üéâ RECONSTRUCTION FIX WORKS! Now chooses 14√ó15 over 15√ó14', 'fixed');
                } else if (bestFit.pieces === 15 && bestFit.length === 14) {
                    log('‚ö†Ô∏è Reconstruction still chooses 15√ó14 (old behavior)', 'warning');
                    log('   But this should only be used when T-Iron data is missing', 'warning');
                } else {
                    log(`ü§î Reconstruction chose: ${bestFit.pieces}√ó${bestFit.length}`, 'warning');
                }

                // Test perfect matches identification
                const perfectMatches = [];
                for (const length of commonLengths) {
                    const pieces = Math.round(totalFeet / length);
                    if (pieces * length === totalFeet) {
                        perfectMatches.push(`${pieces}√ó${length}`);
                    }
                }

                if (perfectMatches.length > 1) {
                    log(`üîç Multiple perfect matches found: ${perfectMatches.join(', ')}`, 'info');
                    log('   Enhanced algorithm should prefer fewer pieces with longer length', 'info');
                }

            } catch (error) {
                log(`‚ùå Reconstruction test failed: ${error.message}`, 'error');
            }
        }

        // Initialize
        log('üéØ T-Iron Display Fix Verification Ready', 'info');
        log('üìã Click "Test User\'s Exact Scenario" to verify the fix', 'info');
    </script>
</body>

</html>