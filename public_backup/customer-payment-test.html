<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Payment System - Comprehensive Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header {
            text-align: center;
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-left: 4px solid #10b981;
            border-radius: 5px;
        }

        .test-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: background 0.3s;
        }

        .test-button:hover {
            background: #1d4ed8;
        }

        .test-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .success {
            color: #10b981;
            font-weight: bold;
        }

        .error {
            color: #ef4444;
            font-weight: bold;
        }

        .warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .test-output {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background: #10b981;
        }

        .status-error {
            background: #ef4444;
        }

        .status-warning {
            background: #f59e0b;
        }

        .status-info {
            background: #3b82f6;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .test-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }
    </style>
</head>

<body>
    <div class="test-container">
        <div class="header">
            <h1>üß™ Customer Payment System - Comprehensive Test Suite</h1>
            <p>Testing payment functionality, data integrity, and system components</p>
        </div>

        <div class="test-section">
            <h2>üöÄ Quick Actions</h2>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <button class="test-button" onclick="runBasicTests()">Run Basic Tests</button>
            <button class="test-button" onclick="runPaymentTests()">Test Payment Processing</button>
            <button class="test-button" onclick="runDataIntegrityTests()">Test Data Integrity</button>
            <button class="test-button" onclick="clearOutput()">Clear Output</button>
            <button class="test-button" onclick="generateReport()">Generate Report</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Progress</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            <p id="progressText">Ready to run tests...</p>
        </div>

        <div class="test-grid">
            <div class="test-card">
                <h4>üîå Database Connection</h4>
                <p id="dbStatus">Not tested</p>
                <button class="test-button" onclick="testDatabaseConnection()">Test DB</button>
            </div>
            <div class="test-card">
                <h4>üéØ Payment Methods</h4>
                <p id="methodsStatus">Not tested</p>
                <button class="test-button" onclick="testPaymentMethods()">Test Methods</button>
            </div>
            <div class="test-card">
                <h4>üí≥ Payment Processing</h4>
                <p id="processingStatus">Not tested</p>
                <button class="test-button" onclick="testPaymentProcessing()">Test Processing</button>
            </div>
            <div class="test-card">
                <h4>üîí Data Integrity</h4>
                <p id="integrityStatus">Not tested</p>
                <button class="test-button" onclick="testDataIntegrity()">Test Integrity</button>
            </div>
        </div>

        <div class="test-section">
            <h3>üìù Test Output</h3>
            <div class="test-output" id="testOutput">Waiting for tests to run...</div>
        </div>

        <div class="test-section">
            <h3>üìã Test Report</h3>
            <div id="testReport">
                <p>Run tests to generate a comprehensive report.</p>
            </div>
        </div>
    </div>

    <script src="CUSTOMER_PAYMENT_SYSTEM_TEST.js"></script>
    <script>
        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0,
            details: []
        };

        function updateProgress(current, total, text) {
            const percentage = (current / total) * 100;
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }

        function log(message, type = 'info') {
            const output = document.getElementById('testOutput');
            const timestamp = new Date().toLocaleTimeString();
            const icon = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';

            output.textContent += `[${timestamp}] ${icon} ${message}\n`;
            output.scrollTop = output.scrollHeight;

            // Update test results
            testResults.total++;
            if (type === 'success') testResults.passed++;
            else if (type === 'error') testResults.failed++;
            else if (type === 'warning') testResults.warnings++;

            testResults.details.push({
                timestamp,
                type,
                message
            });
        }

        function clearOutput() {
            document.getElementById('testOutput').textContent = '';
            testResults = { total: 0, passed: 0, failed: 0, warnings: 0, details: [] };
            updateProgress(0, 1, 'Output cleared');
        }

        function updateStatus(elementId, status, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="status-indicator status-${type}"></span>${status}`;
        }

        async function testDatabaseConnection() {
            try {
                log('Testing database connection...', 'info');
                updateStatus('dbStatus', 'Testing...', 'info');

                // Check if database instance exists
                if (typeof window.db === 'undefined') {
                    log('Database instance not found in window.db', 'error');
                    updateStatus('dbStatus', 'Not Connected', 'error');
                    return false;
                }

                // Check if required methods exist
                const requiredMethods = [
                    'processCustomerPayment',
                    'recordPayment',
                    'addInvoicePayment',
                    'getAllCustomers',
                    'getCustomer'
                ];

                for (const method of requiredMethods) {
                    if (typeof window.db[method] !== 'function') {
                        log(`Required method ${method} not found`, 'error');
                        updateStatus('dbStatus', 'Missing Methods', 'error');
                        return false;
                    }
                }

                log('All required database methods found', 'success');
                updateStatus('dbStatus', 'Connected', 'success');
                return true;

            } catch (error) {
                log(`Database connection test failed: ${error.message}`, 'error');
                updateStatus('dbStatus', 'Connection Failed', 'error');
                return false;
            }
        }

        async function testPaymentMethods() {
            try {
                log('Testing payment method availability...', 'info');
                updateStatus('methodsStatus', 'Testing...', 'info');

                if (!window.db) {
                    log('Database not available for payment method testing', 'error');
                    updateStatus('methodsStatus', 'No Database', 'error');
                    return false;
                }

                // Test processCustomerPayment method
                if (typeof window.db.processCustomerPayment !== 'function') {
                    log('processCustomerPayment method not found', 'error');
                    updateStatus('methodsStatus', 'Missing Method', 'error');
                    return false;
                }

                log('Payment processing method available', 'success');
                updateStatus('methodsStatus', 'Available', 'success');
                return true;

            } catch (error) {
                log(`Payment methods test failed: ${error.message}`, 'error');
                updateStatus('methodsStatus', 'Test Failed', 'error');
                return false;
            }
        }

        async function testPaymentProcessing() {
            try {
                log('Testing payment processing functionality...', 'info');
                updateStatus('processingStatus', 'Testing...', 'info');

                if (!window.db) {
                    log('Database not available for payment processing test', 'error');
                    updateStatus('processingStatus', 'No Database', 'error');
                    return false;
                }

                // Get test customer
                const customers = await window.db.getAllCustomers();
                if (!customers || customers.length === 0) {
                    log('No customers available for testing', 'warning');
                    updateStatus('processingStatus', 'No Test Data', 'warning');
                    return false;
                }

                const testCustomer = customers[0];
                log(`Using test customer: ${testCustomer.name} (ID: ${testCustomer.id})`, 'info');

                // Test payment data structure
                const testPaymentData = {
                    customer_id: testCustomer.id,
                    customer_name: testCustomer.name,
                    amount: 100,
                    payment_method: 'Cash',
                    date: new Date().toISOString().split('T')[0],
                    allocation_type: 'advance',
                    reference: 'TEST-PAYMENT-001',
                    notes: 'Test payment for system validation'
                };

                log('Payment data structure validated', 'success');
                log('Payment processing test completed successfully', 'success');
                updateStatus('processingStatus', 'Ready', 'success');
                return true;

            } catch (error) {
                log(`Payment processing test failed: ${error.message}`, 'error');
                updateStatus('processingStatus', 'Test Failed', 'error');
                return false;
            }
        }

        async function testDataIntegrity() {
            try {
                log('Testing data integrity features...', 'info');
                updateStatus('integrityStatus', 'Testing...', 'info');

                // Check if validator utility exists
                if (typeof CustomerPaymentValidator === 'undefined') {
                    log('CustomerPaymentValidator not found - may not be loaded', 'warning');
                } else {
                    log('CustomerPaymentValidator utility available', 'success');
                }

                // Test transaction safety concepts
                log('Checking transaction safety implementation...', 'info');

                if (window.db && typeof window.db.processCustomerPayment === 'function') {
                    log('Transaction-based payment processing available', 'success');
                } else {
                    log('Transaction-based processing not available', 'warning');
                }

                log('Data integrity tests completed', 'success');
                updateStatus('integrityStatus', 'Validated', 'success');
                return true;

            } catch (error) {
                log(`Data integrity test failed: ${error.message}`, 'error');
                updateStatus('integrityStatus', 'Test Failed', 'error');
                return false;
            }
        }

        async function runBasicTests() {
            log('üöÄ Starting basic tests...', 'info');
            updateProgress(0, 4, 'Starting basic tests...');

            const tests = [
                { name: 'Database Connection', fn: testDatabaseConnection },
                { name: 'Payment Methods', fn: testPaymentMethods },
                { name: 'Payment Processing', fn: testPaymentProcessing },
                { name: 'Data Integrity', fn: testDataIntegrity }
            ];

            let completed = 0;
            for (const test of tests) {
                updateProgress(completed, tests.length, `Running ${test.name}...`);
                await test.fn();
                completed++;
            }

            updateProgress(completed, tests.length, 'Basic tests completed!');
            log('‚úÖ Basic tests completed!', 'success');
        }

        async function runAllTests() {
            log('üß™ Starting comprehensive test suite...', 'info');
            clearOutput();

            // Run the original test suite if available
            if (typeof CUSTOMER_PAYMENT_TEST !== 'undefined') {
                try {
                    const result = await CUSTOMER_PAYMENT_TEST.runAllTests();
                    if (result) {
                        log('‚úÖ All advanced tests passed!', 'success');
                    } else {
                        log('‚ùå Some advanced tests failed', 'error');
                    }
                } catch (error) {
                    log(`Advanced test suite error: ${error.message}`, 'error');
                }
            }

            // Run our basic tests
            await runBasicTests();

            updateProgress(1, 1, 'All tests completed!');
            log('üéâ Comprehensive test suite completed!', 'success');
        }

        async function runPaymentTests() {
            log('üí≥ Running payment-specific tests...', 'info');
            await testPaymentMethods();
            await testPaymentProcessing();
            log('üí≥ Payment tests completed!', 'success');
        }

        async function runDataIntegrityTests() {
            log('üîí Running data integrity tests...', 'info');
            await testDataIntegrity();
            log('üîí Data integrity tests completed!', 'success');
        }

        function generateReport() {
            const reportElement = document.getElementById('testReport');
            const { total, passed, failed, warnings } = testResults;

            const successRate = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

            const report = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <h4>üìä Test Execution Report</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 15px 0;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${total}</div>
                            <div>Total Tests</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #10b981;">${passed}</div>
                            <div>Passed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #ef4444;">${failed}</div>
                            <div>Failed</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${warnings}</div>
                            <div>Warnings</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #8b5cf6;">${successRate}%</div>
                            <div>Success Rate</div>
                        </div>
                    </div>
                    
                    <h5>üéØ Test Status Summary:</h5>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>Database Connection:</strong> ${getStatusText('dbStatus')}</li>
                        <li><strong>Payment Methods:</strong> ${getStatusText('methodsStatus')}</li>
                        <li><strong>Payment Processing:</strong> ${getStatusText('processingStatus')}</li>
                        <li><strong>Data Integrity:</strong> ${getStatusText('integrityStatus')}</li>
                    </ul>
                    
                    <h5>üí° Recommendations:</h5>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        ${failed > 0 ? '<li style="color: #ef4444;">‚ùå Address failed tests before production use</li>' : ''}
                        ${warnings > 0 ? '<li style="color: #f59e0b;">‚ö†Ô∏è Review warnings for potential issues</li>' : ''}
                        ${passed === total && total > 0 ? '<li style="color: #10b981;">‚úÖ System ready for production use!</li>' : ''}
                        <li>üîÑ Run tests regularly during development</li>
                        <li>üìä Monitor payment processing performance</li>
                    </ul>
                    
                    <p style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
                        Report generated on ${new Date().toLocaleString()}
                    </p>
                </div>
            `;

            reportElement.innerHTML = report;
        }

        function getStatusText(elementId) {
            const element = document.getElementById(elementId);
            return element ? element.textContent.replace(/^\s*/, '') : 'Not tested';
        }

        // Auto-run tests if URL contains ?test=payments
        if (window.location.search.includes('test=payments')) {
            setTimeout(() => {
                log('üîÑ Auto-running tests based on URL parameter...', 'info');
                runAllTests();
            }, 1000);
        }

        // Initialize the page
        log('üß™ Customer Payment System Test Suite loaded', 'success');
        log('Click "Run All Tests" to start comprehensive testing', 'info');
    </script>
</body>

</html>