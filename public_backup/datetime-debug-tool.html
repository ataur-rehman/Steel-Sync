<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ• DateTime Debug Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .debug-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #007acc;
            border-radius: 5px;
        }

        .critical {
            border-left-color: #dc3545;
            background: #ffebee;
        }

        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .time-display {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .wrong {
            color: #dc3545;
        }

        .correct {
            color: #28a745;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ• DateTime Debug Tool</h1>

        <div class="debug-section critical">
            <h2>ğŸš¨ User's Report</h2>
            <p><strong>System Time:</strong> 08/23/25 01:20 AM</p>
            <p><strong>App Showed:</strong> <span class="wrong">22/08/25 08:20 PM</span> âš ï¸</p>
            <p><strong>Expected:</strong> <span class="correct">23/08/25 01:20 AM</span> âœ…</p>
        </div>

        <div class="debug-section">
            <h2>ğŸ” Current System Analysis</h2>
            <button onclick="analyzeCurrentDateTime()">ğŸ• Analyze Current DateTime</button>
            <button onclick="testDateTimeConversions()">ğŸ”„ Test DateTime Conversions</button>
            <button onclick="simulateUserScenario()">ğŸ‘¤ Simulate User Scenario</button>
            <div id="currentAnalysis" class="log">Click "Analyze Current DateTime" to start...</div>
        </div>

        <div class="debug-section">
            <h2>ğŸ“‹ Live Testing</h2>
            <button onclick="testRealTimeSave()">ğŸ’¾ Test Real-Time Save</button>
            <button onclick="clearResults()">ğŸ§¹ Clear Results</button>
            <div id="liveTest" class="log">Ready for live testing...</div>
        </div>
    </div>

    <script>
        let logMessages = [];

        function log(message, section = 'currentAnalysis') {
            const timestamp = new Date().toLocaleTimeString();
            logMessages.push(`[${timestamp}] ${message}`);
            document.getElementById(section).innerHTML = logMessages.join('\n');
            document.getElementById(section).scrollTop = document.getElementById(section).scrollHeight;
            console.log(message);
        }

        function clearResults() {
            logMessages = [];
            document.getElementById('currentAnalysis').innerHTML = 'Cleared...';
            document.getElementById('liveTest').innerHTML = 'Cleared...';
        }

        function analyzeCurrentDateTime() {
            logMessages = [];
            log('ğŸ” ANALYZING: Current system DateTime');

            const now = new Date();

            log('ğŸ“… Raw JavaScript Date Object:');
            log(`   toString(): ${now.toString()}`);
            log(`   toISOString(): ${now.toISOString()}`);
            log(`   valueOf(): ${now.valueOf()}`);

            log('ğŸŒ Localization Info:');
            log(`   Timezone: ${Intl.DateTimeFormat().resolvedOptions().timeZone}`);
            log(`   Offset: ${now.getTimezoneOffset()} minutes`);
            log(`   Locale: ${navigator.language}`);

            log('ğŸ“ Standard Formats:');
            log(`   toLocaleDateString(): ${now.toLocaleDateString()}`);
            log(`   toLocaleTimeString(): ${now.toLocaleTimeString()}`);
            log(`   toLocaleString(): ${now.toLocaleString()}`);

            log('ğŸ¯ App-Style Formats:');
            // Simulate app formatters
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear().toString().slice(-2);
            const appDate = `${day}/${month}/${year}`;

            const appTime = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });

            log(`   App Date Format: ${appDate}`);
            log(`   App Time Format: ${appTime}`);
            log(`   Combined: ${appDate} ${appTime}`);

            log('âš ï¸ Checking for Issues:');

            // Check if we're getting wrong date (day before)
            const expectedDay = 23; // User said system shows 08/23/25
            const actualDay = now.getDate();

            if (actualDay !== expectedDay) {
                log(`   ğŸš¨ DATE MISMATCH: Expected day ${expectedDay}, got ${actualDay}`, 'currentAnalysis');
            } else {
                log(`   âœ… Date looks correct: ${actualDay}`, 'currentAnalysis');
            }

            // Check if we're getting wrong time (PM vs AM)
            const expectedHour = 1; // User said 01:20 AM
            const actualHour = now.getHours();

            if (Math.abs(actualHour - expectedHour) > 12) {
                log(`   ğŸš¨ TIME MISMATCH: Expected ~${expectedHour} AM, got ${actualHour}`, 'currentAnalysis');
            } else {
                log(`   âœ… Time looks reasonable: ${actualHour}:xx`, 'currentAnalysis');
            }
        }

        function testDateTimeConversions() {
            log('ğŸ”„ TESTING: DateTime conversion scenarios');

            // Test various timestamp formats that might cause issues
            const testCases = [
                {
                    name: 'Current time',
                    input: new Date(),
                    desc: 'Direct Date object'
                },
                {
                    name: 'ISO string',
                    input: new Date().toISOString(),
                    desc: 'ISO format with Z (UTC)'
                },
                {
                    name: 'Database timestamp',
                    input: new Date().toISOString().replace('T', ' ').replace('Z', ''),
                    desc: 'Database format YYYY-MM-DD HH:MM:SS'
                },
                {
                    name: 'User expected time',
                    input: '2025-08-23 01:20:00',
                    desc: 'Simulated user system time'
                }
            ];

            for (const testCase of testCases) {
                log(`ğŸ“‹ Testing: ${testCase.name} (${testCase.desc})`);

                try {
                    const date = new Date(testCase.input);

                    if (isNaN(date.getTime())) {
                        log(`   âŒ Invalid date: ${testCase.input}`);
                        continue;
                    }

                    // Apply the app's formatDateTime logic
                    let d = date;

                    // Check for UTC conversion (from formatters.ts)
                    if (typeof testCase.input === 'string' && testCase.input.includes('Z')) {
                        log(`   ğŸŒ UTC detected, converting to Pakistan Time (+5)`);
                        d = new Date(d.getTime() + (5 * 60 * 60 * 1000));
                    }

                    const day = d.getDate().toString().padStart(2, '0');
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const year = d.getFullYear().toString().slice(-2);
                    const appDate = `${day}/${month}/${year}`;

                    const appTime = d.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    log(`   âœ… Result: ${appDate} ${appTime}`);

                } catch (error) {
                    log(`   âŒ Error: ${error.message}`);
                }
            }
        }

        function simulateUserScenario() {
            log('ğŸ‘¤ SIMULATING: User\'s exact scenario');

            // User said system time is "08/23/25 01:20 AM"
            // But app showed "22/08/25 08:20 PM"

            log('ğŸ“… Creating simulated timestamps:');

            // Create the time user expects
            const userExpectedTime = new Date('2025-08-23T01:20:00');
            log(`   User Expected: ${userExpectedTime.toString()}`);

            // Try different database timestamp formats that might cause the wrong display
            const problematicFormats = [
                '2025-08-22T20:20:00Z', // UTC that would show as 22nd 8PM in Pakistan
                '2025-08-22 20:20:00',  // Database format that might be misinterpreted
                '2025-08-23T01:20:00Z', // UTC that might be double-converted
            ];

            for (const format of problematicFormats) {
                log(`ğŸ§ª Testing problematic format: ${format}`);

                try {
                    let d = new Date(format);

                    // Apply app conversion logic
                    if (format.includes('Z')) {
                        log(`   ğŸŒ UTC detected, applying +5 hours conversion`);
                        d = new Date(d.getTime() + (5 * 60 * 60 * 1000));
                    }

                    const day = d.getDate().toString().padStart(2, '0');
                    const month = (d.getMonth() + 1).toString().padStart(2, '0');
                    const year = d.getFullYear().toString().slice(-2);
                    const appDate = `${day}/${month}/${year}`;

                    const appTime = d.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: true
                    });

                    const result = `${appDate} ${appTime}`;
                    log(`   ğŸ“º Display Result: ${result}`);

                    if (result.includes('22/08') && result.includes('08:20 PM')) {
                        log(`   ğŸš¨ FOUND THE BUG! This format produces the wrong display`);
                    } else if (result.includes('23/08') && result.includes('01:20 AM')) {
                        log(`   âœ… This format produces the correct display`);
                    }

                } catch (error) {
                    log(`   âŒ Error: ${error.message}`);
                }
            }
        }

        async function testRealTimeSave() {
            logMessages = [];
            log('ğŸ’¾ TESTING: Real-time save with current timestamp', 'liveTest');

            try {
                if (!window.db) {
                    log('âŒ Database not available', 'liveTest');
                    return;
                }

                const startTime = new Date();
                log(`ğŸ• Test started at: ${startTime.toLocaleString()}`, 'liveTest');

                // Create test invoice
                const testInvoice = {
                    customer_id: 1,
                    customer_name: 'DateTime Test Customer',
                    bill_number: 'DT-' + Date.now(),
                    subtotal: 100,
                    total_amount: 100,
                    grand_total: 100
                };

                const invoiceId = await window.db.createInvoice(testInvoice);
                log(`ğŸ“‹ Created invoice: ${invoiceId}`, 'liveTest');

                // Add test item
                const testItem = {
                    product_id: null,
                    product_name: 'DateTime Test Item',
                    quantity: '1',
                    unit_price: 100,
                    total_price: 100,
                    unit: 'pcs',
                    is_non_stock_item: 1
                };

                const itemIds = await window.db.addInvoiceItems(invoiceId, [testItem]);
                const saveTime = new Date();
                log(`ğŸ’¾ Saved item at: ${saveTime.toLocaleString()}`, 'liveTest');

                // Retrieve and check timestamps
                const savedInvoice = await window.db.getInvoiceDetails(invoiceId);
                const retrieveTime = new Date();
                log(`ğŸ“¥ Retrieved at: ${retrieveTime.toLocaleString()}`, 'liveTest');

                if (savedInvoice && savedInvoice.items.length > 0) {
                    const savedItem = savedInvoice.items[0];

                    log(`ğŸ” Checking timestamps:`, 'liveTest');
                    log(`   Raw created_at: ${savedItem.created_at}`, 'liveTest');

                    if (savedItem.created_at) {
                        const createdDate = new Date(savedItem.created_at);
                        log(`   Parsed date: ${createdDate.toString()}`, 'liveTest');

                        // Apply app formatting
                        const day = createdDate.getDate().toString().padStart(2, '0');
                        const month = (createdDate.getMonth() + 1).toString().padStart(2, '0');
                        const year = createdDate.getFullYear().toString().slice(-2);
                        const appDate = `${day}/${month}/${year}`;

                        const appTime = createdDate.toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true
                        });

                        log(`   App Display: ${appDate} ${appTime}`, 'liveTest');

                        // Check if display matches save time
                        const timeDiff = Math.abs(saveTime.getTime() - createdDate.getTime());
                        log(`   Time difference: ${Math.round(timeDiff / 1000)} seconds`, 'liveTest');

                        if (timeDiff < 60000) { // Within 1 minute
                            log(`   âœ… Timestamp is accurate!`, 'liveTest');
                        } else {
                            log(`   âš ï¸ Timestamp differs significantly`, 'liveTest');
                        }
                    } else {
                        log(`   âŒ No created_at timestamp found`, 'liveTest');
                    }
                } else {
                    log(`   âŒ Could not retrieve saved item`, 'liveTest');
                }

            } catch (error) {
                log(`âŒ Real-time test failed: ${error.message}`, 'liveTest');
            }
        }

        // Initialize
        log('ğŸ• DateTime Debug Tool Ready');
        log('Click "Analyze Current DateTime" to start debugging');
    </script>
</body>

</html>