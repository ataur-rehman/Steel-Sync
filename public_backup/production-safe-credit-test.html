<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Production-Safe Credit Application Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        .button:hover {
            background: #2980b9;
        }

        .button.danger {
            background: #e74c3c;
        }

        .button.danger:hover {
            background: #c0392b;
        }

        .button.success {
            background: #27ae60;
        }

        .button.success:hover {
            background: #229954;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-safe {
            background: #d4edda;
            color: #155724;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .ledger-entry {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #ddd;
            background: #f9f9f9;
        }

        .ledger-entry.debit {
            border-left-color: #e74c3c;
        }

        .ledger-entry.credit {
            border-left-color: #27ae60;
        }

        .ledger-entry.reference {
            border-left-color: #3498db;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Production-Safe Credit Application Test</h1>
            <p>Comprehensive validation of the new credit system for billion-dollar financial safety</p>
        </div>

        <div class="test-section">
            <h2>üîç Test Overview</h2>
            <p>This test validates the new production-safe credit application that:</p>
            <ul>
                <li>‚úÖ Uses credit as payment method (single source of truth)</li>
                <li>‚úÖ Creates reference-only entries in customer ledger</li>
                <li>‚úÖ Maintains clear audit trails</li>
                <li>‚úÖ Prevents double-accounting</li>
                <li>‚úÖ Ensures financial accuracy</li>
            </ul>
        </div>

        <div class="grid">
            <div class="card">
                <h3>üìä Test Scenario</h3>
                <p><strong>Customer:</strong> Customer with existing credit</p>
                <p><strong>Invoice:</strong> Rs. 1,430.00</p>
                <p><strong>Available Credit:</strong> Rs. 1,419.90</p>
                <p><strong>Expected Result:</strong> Partial payment via credit</p>
            </div>
            <div class="card">
                <h3>üéØ Expected Outcome</h3>
                <p><strong>Invoice Status:</strong> Partially Paid</p>
                <p><strong>Paid Amount:</strong> Rs. 1,419.90</p>
                <p><strong>Remaining:</strong> Rs. 10.10</p>
                <p><strong>Payment Method:</strong> Customer Credit</p>
            </div>
        </div>

        <div class="test-section">
            <h2>üöÄ Run Tests</h2>
            <button class="button" onclick="runPreTestValidation()">1. Pre-Test Validation</button>
            <button class="button" onclick="createTestScenario()">2. Create Test Scenario</button>
            <button class="button success" onclick="testCreditApplication()">3. Test Credit Application</button>
            <button class="button" onclick="validateResults()">4. Validate Results</button>
            <button class="button danger" onclick="cleanupTest()">5. Cleanup</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        let testCustomerId = null;
        let testInvoiceId = null;

        function showResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function runPreTestValidation() {
            showResult('üîç Running pre-test validation...', 'info');

            try {
                // Check if database service is available
                if (typeof window.electronAPI === 'undefined') {
                    throw new Error('Database service not available');
                }

                showResult('‚úÖ Database service is available', 'success');
                showResult('‚úÖ Production-safe credit system ready for testing', 'success');

            } catch (error) {
                showResult(`‚ùå Pre-test validation failed: ${error.message}`, 'error');
            }
        }

        async function createTestScenario() {
            showResult('üèóÔ∏è Creating test scenario...', 'info');

            try {
                // Create test customer with credit
                const customerData = {
                    name: 'Production Test Customer',
                    phone: '+92-300-1234567',
                    address: 'Test Address for Production Validation',
                    city: 'Test City',
                    balance: -1419.90 // Negative balance = customer has credit
                };

                const customer = await window.electronAPI.createCustomer(customerData);
                testCustomerId = customer.id;

                showResult(`‚úÖ Test customer created with ID: ${testCustomerId}`, 'success');
                showResult(`üí∞ Customer credit balance: Rs. 1,419.90`, 'success');

                // Create test invoice
                const invoiceData = {
                    customer_id: testCustomerId,
                    items: [
                        {
                            name: 'Production Test Item',
                            price: 1430.00,
                            quantity: 1,
                            amount: 1430.00
                        }
                    ],
                    subtotal: 1430.00,
                    grand_total: 1430.00,
                    payment_method: 'pending'
                };

                const invoice = await window.electronAPI.createInvoice(invoiceData);
                testInvoiceId = invoice.id;

                showResult(`‚úÖ Test invoice created with ID: ${testInvoiceId}`, 'success');
                showResult(`üìÑ Invoice amount: Rs. 1,430.00`, 'success');
                showResult(`üí° Test scenario ready for credit application`, 'info');

            } catch (error) {
                showResult(`‚ùå Test scenario creation failed: ${error.message}`, 'error');
            }
        }

        async function testCreditApplication() {
            if (!testCustomerId || !testInvoiceId) {
                showResult('‚ùå Please create test scenario first', 'error');
                return;
            }

            showResult('üõ°Ô∏è Testing production-safe credit application...', 'info');

            try {
                // Apply credit using the new production-safe method
                const creditAmount = 1419.90;

                showResult(`üîÑ Applying Rs. ${creditAmount} credit to invoice ${testInvoiceId}...`, 'info');

                await window.electronAPI.applyCustomerCredit(testInvoiceId, creditAmount);

                showResult('‚úÖ Credit application completed successfully!', 'success');
                showResult('üõ°Ô∏è Production-safe method executed without errors', 'success');

                // Get updated invoice details
                const updatedInvoice = await window.electronAPI.getInvoice(testInvoiceId);

                showResult('üìä Updated Invoice Details:', 'info');
                showResult(`   Total Amount: Rs. ${updatedInvoice.grand_total.toFixed(2)}`, 'info');
                showResult(`   Paid Amount: Rs. ${updatedInvoice.payment_amount.toFixed(2)}`, 'info');
                showResult(`   Remaining: Rs. ${updatedInvoice.remaining_balance.toFixed(2)}`, 'info');
                showResult(`   Status: ${updatedInvoice.status}`, 'info');

            } catch (error) {
                showResult(`‚ùå Credit application failed: ${error.message}`, 'error');
            }
        }

        async function validateResults() {
            if (!testCustomerId || !testInvoiceId) {
                showResult('‚ùå Please run tests first', 'error');
                return;
            }

            showResult('üîç Validating production-safe results...', 'info');

            try {
                // 1. Check invoice payment history
                const invoicePayments = await window.electronAPI.getInvoicePayments(testInvoiceId);

                showResult('üìã Invoice Payment History:', 'info');
                if (invoicePayments && invoicePayments.length > 0) {
                    invoicePayments.forEach(payment => {
                        showResult(`   üí≥ Payment: Rs. ${payment.amount.toFixed(2)} via ${payment.payment_method}`, 'success');
                        showResult(`   üìÖ Date: ${payment.date} | Notes: ${payment.notes || 'N/A'}`, 'info');
                    });
                } else {
                    showResult('   ‚ö†Ô∏è No payment history found', 'warning');
                }

                // 2. Check customer ledger entries
                const customerLedger = await window.electronAPI.getCustomerLedger(testCustomerId);

                showResult('üìã Customer Ledger Entries:', 'info');
                if (customerLedger && customerLedger.length > 0) {
                    customerLedger.slice(-5).forEach(entry => {
                        const entryType = entry.entry_type.toUpperCase();
                        const amount = entry.amount.toFixed(2);
                        const balance = entry.balance_after.toFixed(2);

                        showResult(`   ${entryType === 'DEBIT' ? 'üìà' : entryType === 'CREDIT' ? 'üìâ' : 'üìã'} ${entry.description}`, 'info');
                        showResult(`     Amount: Rs. ${amount} | Balance: Rs. ${balance}`, 'info');
                    });
                } else {
                    showResult('   ‚ö†Ô∏è No ledger entries found', 'warning');
                }

                // 3. Validate no double-accounting
                const customerBalance = await window.electronAPI.getCustomerBalance(testCustomerId);

                showResult('üîç Double-Accounting Check:', 'info');
                showResult(`   Current Customer Balance: Rs. ${customerBalance.toFixed(2)}`, 'info');

                // Expected balance: original credit (-1419.90) + invoice (+1430.00) - credit used (+1419.90) = +10.10
                const expectedBalance = 10.10;
                const balanceDifference = Math.abs(customerBalance - expectedBalance);

                if (balanceDifference < 0.01) {
                    showResult(`   ‚úÖ Balance calculation correct (Expected: Rs. ${expectedBalance.toFixed(2)})`, 'success');
                } else {
                    showResult(`   ‚ùå Balance calculation incorrect (Expected: Rs. ${expectedBalance.toFixed(2)})`, 'error');
                }

                showResult('üéâ Production-safe validation completed!', 'success');

            } catch (error) {
                showResult(`‚ùå Validation failed: ${error.message}`, 'error');
            }
        }

        async function cleanupTest() {
            showResult('üßπ Cleaning up test data...', 'info');

            try {
                if (testInvoiceId) {
                    await window.electronAPI.deleteInvoice(testInvoiceId);
                    showResult(`‚úÖ Test invoice ${testInvoiceId} deleted`, 'success');
                }

                if (testCustomerId) {
                    await window.electronAPI.deleteCustomer(testCustomerId);
                    showResult(`‚úÖ Test customer ${testCustomerId} deleted`, 'success');
                }

                testCustomerId = null;
                testInvoiceId = null;

                showResult('‚úÖ Cleanup completed successfully', 'success');

            } catch (error) {
                showResult(`‚ùå Cleanup failed: ${error.message}`, 'error');
            }
        }

        // Show initial message
        showResult('üõ°Ô∏è Production-Safe Credit Application Test Tool Ready', 'info');
        showResult('üí° This tool validates the new credit system designed for billion-dollar financial safety', 'info');
        showResult('üìã Follow the numbered steps to run comprehensive tests', 'info');
    </script>
</body>

</html>