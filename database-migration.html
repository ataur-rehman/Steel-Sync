<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Migration Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6">Database Migration Tool</h1>

        <div class="space-y-4">
            <button onclick="checkCurrentSchema()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                1. Check Current Schema
            </button>

            <button onclick="createNewTable()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                2. Create Flexible Salary Table
            </button>

            <button onclick="migrateData()" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                3. Migrate Existing Data
            </button>

            <button onclick="dropOldTable()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                4. Drop Old Table
            </button>
        </div>

        <div id="output" class="mt-6 p-4 bg-gray-100 rounded-lg font-mono text-sm whitespace-pre-wrap"></div>
    </div>

    <script type="module">
        import Database from '/node_modules/@tauri-apps/plugin-sql/dist/index.js';

        let db;

        async function initDb() {
            if (!db) {
                db = await Database.load('sqlite:database.db');
            }
            return db;
        }

        function log(message) {
            const output = document.getElementById('output');
            output.textContent += message + '\n';
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        window.checkCurrentSchema = async function () {
            try {
                const database = await initDb();
                log('üìã Checking current salary_payments table schema...');

                // Get table schema
                const schema = await database.select('SELECT sql FROM sqlite_master WHERE type="table" AND name="salary_payments"');
                log('Current schema:');
                log(schema[0]?.sql || 'Table not found');

                // Get table info
                const tableInfo = await database.select('PRAGMA table_info(salary_payments)');
                log('\nColumn details:');
                tableInfo.forEach(col => {
                    log(`${col.name}: ${col.type} ${col.notnull ? '(NOT NULL)' : ''} ${col.dflt_value ? `DEFAULT ${col.dflt_value}` : ''}`);
                });

            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        };

        window.createNewTable = async function () {
            try {
                const database = await initDb();
                log('üîß Creating new flexible salary_payments_new table...');

                const createTableSQL = `
                CREATE TABLE IF NOT EXISTS salary_payments_new (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    staff_id INTEGER NOT NULL,
                    staff_name TEXT NOT NULL,
                    employee_id TEXT,
                    salary_amount REAL,
                    payment_amount REAL NOT NULL,
                    payment_type TEXT DEFAULT 'full',
                    payment_percentage REAL DEFAULT 100,
                    payment_month TEXT,
                    payment_year INTEGER,
                    payment_method TEXT DEFAULT 'cash',
                    paid_by TEXT DEFAULT 'system',
                    payment_date TEXT DEFAULT (date('now')),
                    notes TEXT,
                    created_at TEXT DEFAULT (datetime('now')),
                    updated_at TEXT DEFAULT (datetime('now')),
                    FOREIGN KEY (staff_id) REFERENCES staff_members(id)
                )`;

                await database.execute(createTableSQL);
                log('‚úÖ New flexible table created successfully');
                log('Key improvements:');
                log('- Removed restrictive CHECK constraints');
                log('- Made most fields optional with sensible defaults');
                log('- Only staff_id, staff_name, and payment_amount are required');
                log('- All other fields have flexible defaults');

            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        };

        window.migrateData = async function () {
            try {
                const database = await initDb();
                log('üì¶ Migrating existing data...');

                // Check if old table has data
                const count = await database.select('SELECT COUNT(*) as count FROM salary_payments');
                log(`Found ${count[0].count} records to migrate`);

                if (count[0].count > 0) {
                    // Copy data to new table
                    const migrateSQL = `
                    INSERT INTO salary_payments_new 
                    (staff_id, staff_name, employee_id, salary_amount, payment_amount, 
                     payment_type, payment_percentage, payment_month, payment_year, 
                     payment_method, paid_by, payment_date, notes, created_at, updated_at)
                    SELECT 
                        staff_id, staff_name, employee_id, salary_amount, payment_amount,
                        COALESCE(payment_type, 'full'),
                        COALESCE(payment_percentage, 100),
                        payment_month, payment_year,
                        COALESCE(payment_method, 'cash'),
                        COALESCE(paid_by, 'system'),
                        COALESCE(payment_date, date('now')),
                        COALESCE(notes, ''),
                        COALESCE(created_at, datetime('now')),
                        COALESCE(updated_at, datetime('now'))
                    FROM salary_payments`;

                    await database.execute(migrateSQL);
                    log('‚úÖ Data migrated successfully');
                } else {
                    log('‚ÑπÔ∏è No data to migrate');
                }

            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        };

        window.dropOldTable = async function () {
            try {
                const database = await initDb();
                log('üóëÔ∏è Dropping old table and renaming new one...');

                // Drop old table
                await database.execute('DROP TABLE IF EXISTS salary_payments');
                log('‚úÖ Old table dropped');

                // Rename new table
                await database.execute('ALTER TABLE salary_payments_new RENAME TO salary_payments');
                log('‚úÖ New table renamed to salary_payments');

                log('üéâ Migration completed successfully!');
                log('The salary_payments table is now flexible and user-friendly');

            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        };
    </script>
</body>

</html>