<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Production Issue Verification System</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background-color: #1a1a1a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 10px;
        }

        .issue-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .issue-card {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .issue-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .issue-resolved {
            border-left: 4px solid #28a745;
        }

        .issue-unresolved {
            border-left: 4px solid #dc3545;
        }

        .issue-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-icon {
            font-size: 20px;
        }

        .issue-description {
            color: #ccc;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .error-count {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        .error-count.resolved {
            background-color: #28a745;
            color: white;
        }

        .error-count.unresolved {
            background-color: #dc3545;
            color: white;
        }

        .button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            font-family: inherit;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #0056b3;
        }

        .button.primary {
            background-color: #28a745;
        }

        .button.primary:hover {
            background-color: #218838;
        }

        .output {
            background-color: #2d2d2d;
            border: 1px solid #444;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .summary {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary.all-resolved {
            background: linear-gradient(135deg, #1a4a1a, #2d5a2d);
        }

        .summary.issues-remaining {
            background: linear-gradient(135deg, #4a1a1a, #5a2d2d);
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }

        .sample-data {
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîç Production Issue Verification System</h1>
            <p>Comprehensive verification of all critical payment and balance issues</p>
        </div>

        <div class="summary" id="summary">
            <h2>üìä Verification Status</h2>
            <p>Click "Run Full Verification" to check all issues</p>
        </div>

        <div>
            <button class="button primary" onclick="runFullVerification()">
                üîç Run Full Verification
            </button>
            <button class="button" onclick="runMigration()">
                üöÄ Run Automatic Migration
            </button>
            <button class="button" onclick="testUserScenario()">
                üß™ Test User Scenario
            </button>
            <button class="button" onclick="clearOutput()">
                üóëÔ∏è Clear Output
            </button>
        </div>

        <div class="issue-grid" id="issueGrid">
            <!-- Issue cards will be populated here -->
        </div>

        <div id="output" class="output">
            Ready to run verification. Click "Run Full Verification" to start.

            This system will check:
            ‚úÖ Invoice remaining_balance calculation accuracy
            ‚úÖ Customer balance precision (5 paisa errors)
            ‚úÖ Customer status logic consistency
            ‚úÖ Payment allocation to correct totals
            ‚úÖ Database trigger functionality

            üîß Functions available:
            - verifyProductionIssues(): Check all issues
            - runAutomaticProductionMigration(): Fix all issues
            - Database connection via window.db
        </div>
    </div>

    <script type="module">
        import { db } from './src/services/database.ts';

        window.db = db;

        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            let className = '';

            if (type === 'error') className = 'error';
            else if (type === 'success') className = 'success';
            else if (type === 'warning') className = 'warning';
            else if (type === 'info') className = 'info';

            output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            output.scrollTop = output.scrollHeight;
        }

        function updateSummary(result) {
            const summary = document.getElementById('summary');
            const allResolved = result.allIssuesResolved;

            summary.className = `summary ${allResolved ? 'all-resolved' : 'issues-remaining'}`;
            summary.innerHTML = `
                <h2>üìä Verification Results</h2>
                <h3 class="${allResolved ? 'success' : 'error'}">
                    ${allResolved ? '‚úÖ ALL ISSUES RESOLVED' : '‚ö†Ô∏è ISSUES REMAINING'}
                </h3>
                <p>Issues Resolved: ${result.summary.issuesResolved}/${result.summary.totalIssuesChecked}</p>
                <p>Issues Remaining: ${result.summary.issuesRemaining}</p>
            `;
        }

        function updateIssueGrid(detailedResults) {
            const grid = document.getElementById('issueGrid');
            grid.innerHTML = '';

            const issues = [
                {
                    key: 'invoiceBalanceAccuracy',
                    title: 'Invoice Balance Accuracy',
                    icon: 'üìÑ',
                    result: detailedResults.invoiceBalanceAccuracy
                },
                {
                    key: 'customerBalancePrecision',
                    title: 'Customer Balance Precision',
                    icon: 'üí∞',
                    result: detailedResults.customerBalancePrecision
                },
                {
                    key: 'customerStatusLogic',
                    title: 'Customer Status Logic',
                    icon: 'üë•',
                    result: detailedResults.customerStatusLogic
                },
                {
                    key: 'paymentAllocation',
                    title: 'Payment Allocation',
                    icon: 'üí≥',
                    result: detailedResults.paymentAllocation
                },
                {
                    key: 'databaseTriggers',
                    title: 'Database Triggers',
                    icon: 'üîß',
                    result: detailedResults.databaseTriggers
                }
            ];

            issues.forEach(issue => {
                const card = document.createElement('div');
                card.className = `issue-card ${issue.result.resolved ? 'issue-resolved' : 'issue-unresolved'}`;

                card.innerHTML = `
                    <div class="issue-title">
                        <span class="status-icon">${issue.result.resolved ? '‚úÖ' : '‚ùå'}</span>
                        <span>${issue.icon} ${issue.title}</span>
                    </div>
                    <div class="issue-description">${issue.result.description}</div>
                    <div class="error-count ${issue.result.resolved ? 'resolved' : 'unresolved'}">
                        ${issue.result.errorCount === 0 ? 'No errors found' :
                        issue.result.errorCount === -1 ? 'Check failed' :
                            `${issue.result.errorCount} errors found`}
                    </div>
                    <div class="sample-data">
                        <strong>Sample Data:</strong><br>
                        ${issue.result.sampleErrors.length > 0 ?
                        JSON.stringify(issue.result.sampleErrors.slice(0, 2), null, 2) :
                        'No sample errors'}
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        window.runFullVerification = async function () {
            log('üîç === STARTING COMPREHENSIVE VERIFICATION ===', 'info');
            log('Checking all critical production issues...', 'info');

            try {
                // Import verification module
                const { verifyProductionIssues } = await import('./src/utils/production-issue-verifier.ts');

                if (!window.db) {
                    log('‚ùå Database instance not available', 'error');
                    return;
                }

                log('üîß Running verification with database connection...', 'info');
                const result = await verifyProductionIssues(window.db);

                // Update UI
                updateSummary(result);
                updateIssueGrid(result.detailedResults);

                // Log results
                log('üìä === VERIFICATION COMPLETE ===', 'success');
                log(`‚úÖ Issues Resolved: ${result.summary.issuesResolved}/${result.summary.totalIssuesChecked}`, 'success');

                if (result.allIssuesResolved) {
                    log('üéâ ALL ISSUES HAVE BEEN RESOLVED!', 'success');
                } else {
                    log('‚ö†Ô∏è Some issues remain - see details above', 'warning');

                    if (result.recommendations.length > 0) {
                        log('üí° Recommendations:', 'info');
                        result.recommendations.forEach((rec, index) => {
                            log(`   ${index + 1}. ${rec}`, 'info');
                        });
                    }
                }

                // Log sample problematic data
                if (result.sampleData.problematicInvoices.length > 0) {
                    log('üìÑ Sample problematic invoices:', 'warning');
                    log(JSON.stringify(result.sampleData.problematicInvoices.slice(0, 2), null, 2), 'warning');
                }

                if (result.sampleData.problematicCustomers.length > 0) {
                    log('üë• Sample problematic customers:', 'warning');
                    log(JSON.stringify(result.sampleData.problematicCustomers.slice(0, 2), null, 2), 'warning');
                }

            } catch (error) {
                log(`‚ùå Verification failed: ${error.message}`, 'error');
                console.error('Verification error:', error);
            }
        };

        window.runMigration = async function () {
            log('üöÄ === STARTING AUTOMATIC MIGRATION ===', 'info');

            try {
                const { runAutomaticProductionMigration } = await import('./src/utils/automatic-production-migration.ts');

                if (!window.db) {
                    log('‚ùå Database instance not available', 'error');
                    return;
                }

                log('üîß Running automatic production migration...', 'info');
                const result = await runAutomaticProductionMigration(window.db);

                if (result.success) {
                    log('üéâ MIGRATION COMPLETED SUCCESSFULLY!', 'success');
                    log(`‚è±Ô∏è Total time: ${result.totalTime}ms`, 'success');
                    log(`üîß Triggers updated: ${result.operations.triggersUpdated}`, 'success');
                    log(`üìÑ Invoices fixed: ${result.operations.invoicesFixed}`, 'success');
                    log(`üë• Customers fixed: ${result.operations.customersFixed}`, 'success');
                    log(`‚úÖ Validation passed: ${result.operations.validationPassed}`, 'success');

                    log('üí° Run verification again to confirm all issues are resolved', 'info');
                } else {
                    log('‚ùå MIGRATION FAILED', 'error');
                    result.errors.forEach(error => {
                        log(`   Error: ${error}`, 'error');
                    });
                }

            } catch (error) {
                log(`‚ùå Migration execution failed: ${error.message}`, 'error');
                console.error('Migration error:', error);
            }
        };

        window.testUserScenario = async function () {
            log('üß™ === TESTING USER-REPORTED SCENARIO ===', 'info');

            try {
                if (!window.db) {
                    log('‚ùå Database instance not available', 'error');
                    return;
                }

                // Look for invoices with returns and payments (like user's scenario)
                log('üîç Looking for invoices matching user scenario...', 'info');

                const testQuery = `
                    SELECT 
                        i.id, i.bill_number, i.customer_id,
                        i.grand_total, i.payment_amount, i.remaining_balance,
                        COALESCE((
                            SELECT SUM(return_quantity * unit_price) 
                            FROM return_items ri 
                            WHERE ri.original_invoice_id = i.id
                        ), 0) as total_returns,
                        c.name as customer_name, c.total_balance as customer_balance, c.status as customer_status,
                        ROUND((i.grand_total - COALESCE((
                            SELECT SUM(return_quantity * unit_price) 
                            FROM return_items ri 
                            WHERE ri.original_invoice_id = i.id
                        ), 0)) - COALESCE(i.payment_amount, 0), 2) as calculated_remaining,
                        CASE 
                            WHEN ABS(i.remaining_balance - ROUND((i.grand_total - COALESCE((
                                SELECT SUM(return_quantity * unit_price) 
                                FROM return_items ri 
                                WHERE ri.original_invoice_id = i.id
                            ), 0)) - COALESCE(i.payment_amount, 0), 2)) <= 0.01 THEN 'correct'
                            ELSE 'incorrect'
                        END as balance_status
                    FROM invoices i
                    LEFT JOIN customers c ON i.customer_id = c.id
                    WHERE EXISTS (
                        SELECT 1 FROM return_items ri 
                        WHERE ri.original_invoice_id = i.id
                    )
                    AND COALESCE(i.payment_amount, 0) > 0
                    ORDER BY i.id
                    LIMIT 5
                `;

                const testResults = await window.db.dbConnection.select(testQuery);

                if (testResults.length > 0) {
                    log(`‚úÖ Found ${testResults.length} invoices matching user scenario`, 'success');

                    testResults.forEach((invoice, index) => {
                        log(`\nüìÑ Invoice ${index + 1}: ${invoice.bill_number}`, 'info');
                        log(`   Customer: ${invoice.customer_name} (${invoice.customer_id})`, 'info');
                        log(`   Grand Total: Rs. ${invoice.grand_total}`, 'info');
                        log(`   Returns: Rs. ${invoice.total_returns}`, 'info');
                        log(`   Payment: Rs. ${invoice.payment_amount}`, 'info');
                        log(`   Stored Remaining: Rs. ${invoice.remaining_balance}`, 'info');
                        log(`   Calculated Remaining: Rs. ${invoice.calculated_remaining}`, 'info');
                        log(`   Balance Status: ${invoice.balance_status === 'correct' ? '‚úÖ' : '‚ùå'} ${invoice.balance_status}`,
                            invoice.balance_status === 'correct' ? 'success' : 'error');
                        log(`   Customer Balance: Rs. ${invoice.customer_balance} (${invoice.customer_status})`, 'info');
                    });
                } else {
                    log('üìÑ No invoices found matching user scenario (invoices with returns and payments)', 'warning');
                    log('This might mean the test data doesn\'t exist or the issues were already fixed', 'info');
                }

            } catch (error) {
                log(`‚ùå Test scenario failed: ${error.message}`, 'error');
                console.error('Test error:', error);
            }
        };

        window.clearOutput = function () {
            document.getElementById('output').innerHTML = 'Output cleared.\n';
        };

        // Initialize
        log('üîç Production Issue Verification System initialized', 'success');
        log('üí° Use the buttons above to run verification and migration', 'info');
    </script>
</body>

</html>